<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Al Bourakh Driver Pro - Application Chauffeur ‚úÖ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .mobile-container {
            max-width: 414px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .app-header {
            background: linear-gradient(135deg, #00A854, #FECB00);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            z-index: 100;
        }

        .app-header h1 {
            font-size: 1.3em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-header button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .app-header button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .login-screen {
            padding: 40px 30px;
            text-align: center;
        }

        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, #00A854, #FECB00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            box-shadow: 0 8px 20px rgba(0,168,84,0.3);
        }

        .login-title {
            font-size: 2em;
            color: #00A854;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 40px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #00A854;
            box-shadow: 0 0 15px rgba(0,168,84,0.2);
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00A854, #FECB00);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,168,84,0.3);
        }

        .link-text {
            color: #00A854;
            margin-top: 20px;
            display: inline-block;
            cursor: pointer;
        }

        .dashboard-content {
            padding: 20px;
            padding-bottom: 100px;
        }

        .status-toggle {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-info h3 {
            color: #333;
            margin-bottom: 8px;
        }

        .status-text {
            font-size: 1.2em;
            font-weight: bold;
            color: #999;
        }

        .status-text.online {
            color: #00A854;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 34px;
            background: #ccc;
            border-radius: 34px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: #00A854;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 4px;
            left: 4px;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            left: 30px;
        }

        #map {
            width: 100%;
            height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .map-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .map-container h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .location-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .location-info div {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .permission-guide {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .permission-guide.show {
            display: block;
        }

        .permission-guide h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .permission-guide ul {
            text-align: left;
            padding-left: 20px;
            color: #856404;
        }

        .permission-guide li {
            margin: 5px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #00A854;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .action-btn {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 1em;
        }

        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .action-btn-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .course-notification {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .course-modal {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 30px;
            animation: slideUp 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .course-timer {
            background: linear-gradient(135deg, #E30613, #FF6B00);
            color: white;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2em;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(227,6,19,0.3);
        }

        .course-timer-label {
            font-size: 0.4em;
            margin-top: 5px;
        }

        .course-title {
            text-align: center;
            font-size: 1.5em;
            color: #00A854;
            margin-bottom: 20px;
        }

        .course-client {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .course-route {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .route-point {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .route-icon {
            font-size: 1.5em;
        }

        .course-details {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .detail-item {
            text-align: center;
        }

        .detail-icon {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .course-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-refuse {
            background: #E30613;
            color: white;
        }

        .btn-accept {
            background: #00A854;
            color: white;
        }

        .active-course-container {
            padding: 20px;
            padding-bottom: 100px;
        }

        .course-status-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .status-badge.acceptee {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.en-route {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.arrive {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.en-cours {
            background: #cce5ff;
            color: #004085;
        }

        .client-info-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .client-info-card h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .navigation-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .nav-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .nav-btn.primary {
            background: #00A854;
            color: white;
        }

        .nav-btn.secondary {
            background: #2196F3;
            color: white;
        }

        .nav-btn.danger {
            background: #E30613;
            color: white;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .chat-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            max-width: calc(100% - 40px);
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 9999;
            animation: slideUp 0.3s;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-header {
            background: linear-gradient(135deg, #00A854, #FECB00);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f5f5;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.sent {
            align-items: flex-end;
        }

        .chat-message.received {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
        }

        .message-bubble.sent {
            background: #00A854;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-bubble.received {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
        }

        .chat-input-container {
            padding: 15px;
            background: white;
            border-radius: 0 0 15px 15px;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 1em;
        }

        .chat-input:focus {
            outline: none;
            border-color: #00A854;
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            background: #00A854;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .chat-fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #00A854;
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,168,84,0.4);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            z-index: 9998;
        }

        .chat-fab.active {
            display: flex;
        }

        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #E30613;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
        }

        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .payment-modal.active {
            display: flex;
        }

        .payment-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 30px;
            animation: slideUp 0.3s;
        }

        .payment-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .payment-amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #00A854;
            margin: 20px 0;
        }

        .payment-methods {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }

        .payment-method {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .payment-method:hover {
            border-color: #00A854;
            background: #f5fff5;
        }

        .payment-method.selected {
            border-color: #00A854;
            background: #f5fff5;
        }

        .payment-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .payment-icon.cash {
            background: #4CAF50;
            color: white;
        }

        .payment-icon.orange {
            background: #FF6B00;
            color: white;
        }

        .payment-icon.wave {
            background: #0066FF;
            color: white;
        }

        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .password-modal.active {
            display: flex;
        }

        .password-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 30px;
            animation: slideUp 0.3s;
        }

        .password-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .password-header h2 {
            color: #00A854;
            margin-bottom: 10px;
        }

        .password-input-group {
            margin-bottom: 20px;
        }

        .password-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .password-input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .password-input-group input:focus {
            outline: none;
            border-color: #00A854;
            box-shadow: 0 0 15px rgba(0,168,84,0.2);
        }

        .password-strength {
            margin-top: 10px;
            height: 5px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s;
        }

        .strength-weak {
            background: #E30613;
            width: 33%;
        }

        .strength-medium {
            background: #FFA500;
            width: 66%;
        }

        .strength-strong {
            background: #00A854;
            width: 100%;
        }

        .password-requirements {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .password-requirements ul {
            margin: 10px 0 0 20px;
            color: #666;
        }

        .password-requirements li {
            margin: 5px 0;
        }

        .requirement-met {
            color: #00A854;
        }

        .history-list {
            padding: 20px;
            padding-bottom: 100px;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .history-date {
            color: #666;
            font-size: 0.9em;
        }

        .history-price {
            font-weight: bold;
            color: #00A854;
        }

        .history-route {
            color: #333;
            margin-bottom: 5px;
        }

        .history-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            background: #00A854;
            color: white;
        }

        .profile-header {
            background: linear-gradient(135deg, #00A854, #FECB00);
            padding: 30px 20px;
            text-align: center;
            color: white;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: #00A854;
        }

        .profile-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-rating {
            font-size: 1.2em;
        }

        .profile-info {
            padding: 20px;
            padding-bottom: 100px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-label {
            color: #666;
        }

        .info-value {
            font-weight: bold;
            color: #333;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            max-width: 414px;
            margin: 0 auto;
            z-index: 1000;
        }

        .nav-item {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            transition: all 0.3s;
            flex: 1;
        }

        .nav-item:hover {
            background: #f5f5f5;
        }

        .nav-item.active {
            color: #00A854;
        }

        .nav-icon {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 0.8em;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideInRight 0.3s;
            max-width: 300px;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .toast.success {
            border-left: 4px solid #00A854;
        }

        .toast.error {
            border-left: 4px solid #E30613;
        }

        .toast.info {
            border-left: 4px solid #2196F3;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top-color: #FECB00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.2em;
            margin-top: 20px;
        }

        @media (max-width: 414px) {
            .mobile-container {
                max-width: 100%;
            }

            .bottom-nav {
                max-width: 100%;
            }

            .chat-container {
                right: 10px;
                width: calc(100% - 20px);
            }

            .chat-fab {
                right: 10px;
            }
        }

        .sync-badge {
            display: inline-block;
            background: #d4edda;
            color: #155724;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
        }

        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            max-width: 300px;
            z-index: 9998;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div id="loginScreen" class="screen active">
            <div class="login-screen">
                <div class="login-logo">üöï</div>
                <h1 class="login-title">Al Bourakh Driver Pro <span class="sync-badge">‚úÖ SYNC</span></h1>
                <p class="login-subtitle">Connectez-vous pour commencer</p>

                <div class="input-group">
                    <label>üì± T√©l√©phone</label>
                    <input type="tel" id="loginPhone" placeholder="+221 77 123 45 67">
                </div>

                <div class="input-group">
                    <label>üîí Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="Votre mot de passe">
                </div>

                <button class="btn btn-primary" onclick="handleLogin()">
                    Se connecter
                </button>

                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #4CAF50;">
                    <p style="margin: 0 0 8px 0; color: #2e7d32; font-size: 0.9em;">
                        <strong>üîê Connexion :</strong> 
                        <br>Tout num√©ro s√©n√©galais + <code style="background: #fff; padding: 2px 6px; border-radius: 3px; color: #000;">Admin2025</code>
                    </p>
                    <p style="margin: 0; color: #2e7d32; font-size: 0.9em;">
                        <strong>üß™ Mode D√©mo :</strong> 
                        <br>N'importe quel num√©ro + <code style="background: #fff; padding: 2px 6px; border-radius: 3px; color: #000;">demo123</code>
                    </p>
                </div>

                <a class="link-text" onclick="resetPassword()">
                    Mot de passe oubli√© ?
                </a>

                <div style="margin-top: 20px;">
                    <button class="btn" style="background: #2196F3; color: white;" onclick="createTestAccount()">
                        üîß Cr√©er compte test
                    </button>
                </div>

                <p style="margin-top: 30px; color: #999; font-size: 0.9em;">
                    Version 3.3.0 (OPTIMIS√âE ‚úÖ‚úÖ‚úÖ) - Al Bourakh ¬© 2025
                </p>
            </div>
        </div>

        <div id="dashboardScreen" class="screen">
            <div class="app-header">
                <h1><i class="fas fa-car"></i> Dashboard</h1>
                <button onclick="showScreen('profileScreen')">
                    <i class="fas fa-user"></i>
                </button>
            </div>

            <div class="dashboard-content">
                <div class="status-toggle">
                    <div class="status-info">
                        <h3>Statut</h3>
                        <div class="status-text" id="statusText">‚ö´ HORS LIGNE</div>
                    </div>
                    <div class="toggle-switch" id="toggleSwitch" onclick="toggleOnlineStatus()"></div>
                </div>

                <div class="map-container">
                    <h3>üìç Ma Position</h3>
                    <div id="map"></div>
                    <div class="location-info" id="locationInfo">
                        <div>
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="currentAddress">En attente de localisation...</span>
                        </div>
                        <div>
                            <i class="fas fa-crosshairs"></i>
                            <span id="accuracy">Pr√©cision: -- m</span>
                        </div>
                    </div>
                    
                    <div class="permission-guide" id="permissionGuide">
                        <h4>üîì Comment activer la localisation :</h4>
                        <ul>
                            <li><strong>Chrome/Edge</strong> : Cliquez sur üîí dans la barre d'adresse ‚Üí Autoriser localisation</li>
                            <li><strong>Firefox</strong> : Param√®tres ‚Üí Permissions ‚Üí Localisation</li>
                            <li><strong>Safari iOS</strong> : R√©glages ‚Üí Safari ‚Üí Localisation ‚Üí Autoriser</li>
                            <li><strong>Android</strong> : Param√®tres ‚Üí Applications ‚Üí Autoriser localisation</li>
                        </ul>
                        <p style="margin-top: 10px; font-weight: bold;">
                            üí° Rechargez la page apr√®s avoir activ√© les permissions
                        </p>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px; color: #333;">üìä Aujourd'hui</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üöó</div>
                        <div class="stat-value" id="coursesJour">0</div>
                        <div class="stat-label">Courses</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="revenusJour">0</div>
                        <div class="stat-label">FCFA</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="rating">4.8</div>
                        <div class="stat-label">Note</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="coursesTotal">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="action-btn" onclick="showScreen('historyScreen')">
                        <div class="action-btn-icon">üìä</div>
                        <div>Historique</div>
                    </button>

                    <button class="action-btn" onclick="showScreen('profileScreen')">
                        <div class="action-btn-icon">üë§</div>
                        <div>Profil</div>
                    </button>

                    <button class="action-btn" onclick="diagnosticGeolocation()">
                        <div class="action-btn-icon">üîç</div>
                        <div>Test GPS</div>
                    </button>

                    <button class="action-btn" onclick="simulateNewCourse()">
                        <div class="action-btn-icon">üîî</div>
                        <div>Test Course</div>
                    </button>
                </div>
            </div>
        </div>

        <div id="activeCourseScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1><i class="fas fa-route"></i> Course en cours</h1>
                <button onclick="toggleChat()">
                    <i class="fas fa-comments"></i>
                </button>
            </div>

            <div class="active-course-container">
                <div class="map-container">
                    <div id="activeCourseMap" style="height: 350px; border-radius: 15px;"></div>
                </div>

                <div class="course-status-card">
                    <span class="status-badge acceptee" id="courseStatus">‚úÖ Course accept√©e</span>
                    <h3 id="courseStatusTitle">En route vers le client</h3>
                    <div class="location-info">
                        <div>
                            <i class="fas fa-clock"></i>
                            <span id="estimatedTime">Temps estim√©: 12 min</span>
                        </div>
                        <div>
                            <i class="fas fa-road"></i>
                            <span id="remainingDistance">Distance: 3.2 km</span>
                        </div>
                    </div>
                </div>

                <div class="client-info-card" id="clientInfoCard">
                    <h3>üë§ Client</h3>
                    <div class="info-row">
                        <span>Nom</span>
                        <strong id="clientName">Aminata Sow</strong>
                    </div>
                    <div class="info-row">
                        <span>T√©l√©phone</span>
                        <strong id="clientPhone">+221 77 999 88 77</strong>
                    </div>
                    <div class="info-row">
                        <span>Note</span>
                        <strong id="clientRating">‚≠ê 4.9</strong>
                    </div>
                </div>

                <div class="client-info-card">
                    <h3>üó∫Ô∏è Trajet</h3>
                    <div class="info-row">
                        <span>üìç D√©part</span>
                        <strong id="activeDeparture">Plateau, Dakar</strong>
                    </div>
                    <div class="info-row">
                        <span>üéØ Destination</span>
                        <strong id="activeDestination">Almadies</strong>
                    </div>
                    <div class="info-row">
                        <span>üí∞ Prix</span>
                        <strong id="activePrice">3 500 FCFA</strong>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="nav-btn secondary" onclick="openGoogleMaps()">
                        <i class="fas fa-map-marked-alt"></i> Navigation GPS
                    </button>
                    <button class="nav-btn primary" onclick="callClient()">
                        <i class="fas fa-phone"></i> Appeler Client
                    </button>
                </div>

                <div class="navigation-buttons" style="margin-top: 10px;">
                    <button class="nav-btn primary" onclick="updateCourseStatus('arrive')">
                        <i class="fas fa-map-pin"></i> Arriv√© sur place
                    </button>
                    <button class="nav-btn primary" onclick="updateCourseStatus('en_cours')">
                        <i class="fas fa-play"></i> D√©marrer course
                    </button>
                </div>

                <button class="btn btn-primary" onclick="completeCourse()" style="margin-top: 15px;">
                    <i class="fas fa-check-circle"></i> Terminer la course
                </button>

                <button class="btn" onclick="cancelCourse()" style="margin-top: 10px; background: #E30613; color: white;">
                    <i class="fas fa-times-circle"></i> Annuler la course
                </button>
            </div>
        </div>

        <div id="historyScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1><i class="fas fa-history"></i> Historique</h1>
                <button onclick="loadHistory()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>

            <div class="history-list" id="historyList">
            </div>
        </div>

        <div id="profileScreen" class="screen">
            <div class="profile-header">
                <button onclick="showScreen('dashboardScreen')" style="position: absolute; left: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="profile-avatar">üë§</div>
                <div class="profile-name" id="profileName">Chauffeur Al Bourakh</div>
                <div class="profile-rating">‚≠ê 4.8 ‚Ä¢ <span id="profileTotalCourses">0</span> courses</div>
            </div>

            <div class="profile-info">
                <div class="info-item">
                    <span class="info-label">üì± T√©l√©phone</span>
                    <span class="info-value" id="profilePhone">+221 77 123 45 67</span>
                </div>

                <div class="info-item">
                    <span class="info-label">üöó V√©hicule</span>
                    <span class="info-value">Toyota Corolla</span>
                </div>

                <div class="info-item">
                    <span class="info-label">üî¢ Immatriculation</span>
                    <span class="info-value">DK-1234-AB</span>
                </div>

                <div class="info-item">
                    <span class="info-label">üí∞ Revenus Total</span>
                    <span class="info-value" id="profileRevenuTotal">0 FCFA</span>
                </div>

                <button class="btn btn-primary" onclick="showPasswordModal()" style="margin-top: 20px;">
                    <i class="fas fa-key"></i> Changer le mot de passe
                </button>

                <button class="btn btn-primary" onclick="handleLogout()" style="margin-top: 10px; background: #E30613;">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>
        </div>

        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <div class="nav-item active" onclick="showScreen('dashboardScreen')">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <div class="nav-label">Accueil</div>
            </div>

            <div class="nav-item" onclick="showScreen('activeCourseScreen')">
                <div class="nav-icon"><i class="fas fa-route"></i></div>
                <div class="nav-label">Course</div>
            </div>

            <div class="nav-item" onclick="showScreen('historyScreen')">
                <div class="nav-icon"><i class="fas fa-history"></i></div>
                <div class="nav-label">Historique</div>
            </div>

            <div class="nav-item" onclick="showScreen('profileScreen')">
                <div class="nav-icon"><i class="fas fa-user"></i></div>
                <div class="nav-label">Profil</div>
            </div>
        </div>
    </div>

    <button class="chat-fab" id="chatFab" onclick="toggleChat()">
        <i class="fas fa-comments"></i>
        <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
    </button>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div>
                <strong id="chatClientName">Client</strong>
                <div style="font-size: 0.85em; opacity: 0.9;">En ligne</div>
            </div>
            <button onclick="toggleChat()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="√âcrivez votre message..." onkeypress="handleChatKeyPress(event)">
            <button class="chat-send-btn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div class="payment-modal" id="paymentModal">
        <div class="payment-content">
            <div class="payment-header">
                <h2>üí≥ Paiement</h2>
                <p style="color: #666; margin-top: 10px;">S√©lectionnez le mode de paiement</p>
            </div>

            <div class="payment-amount" id="paymentAmount">3 500 FCFA</div>

            <div class="payment-methods">
                <div class="payment-method" onclick="selectPaymentMethod('cash')">
                    <div class="payment-icon cash">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div>
                        <strong>Esp√®ces</strong>
                        <div style="font-size: 0.9em; color: #666;">Paiement en liquide</div>
                    </div>
                </div>

                <div class="payment-method" onclick="selectPaymentMethod('orange')">
                    <div class="payment-icon orange">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div>
                        <strong>Orange Money</strong>
                        <div style="font-size: 0.9em; color: #666;">Paiement mobile</div>
                    </div>
                </div>

                <div class="payment-method" onclick="selectPaymentMethod('wave')">
                    <div class="payment-icon wave">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div>
                        <strong>Wave</strong>
                        <div style="font-size: 0.9em; color: #666;">Portefeuille digital</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="confirmPayment()">
                Confirmer le paiement
            </button>

            <button class="btn" onclick="closePaymentModal()" style="margin-top: 10px; background: #999; color: white;">
                Annuler
            </button>
        </div>
    </div>

    <div class="password-modal" id="passwordModal">
        <div class="password-content">
            <div class="password-header">
                <h2>üîí Changer le mot de passe</h2>
                <p style="color: #666; margin-top: 5px;">S√©curisez votre compte avec un nouveau mot de passe</p>
            </div>

            <div class="password-input-group">
                <label>Mot de passe actuel</label>
                <input type="password" id="currentPassword" placeholder="Entrez votre mot de passe actuel">
            </div>

            <div class="password-input-group">
                <label>Nouveau mot de passe</label>
                <input type="password" id="newPassword" placeholder="Entrez un nouveau mot de passe" oninput="checkPasswordStrength()">
                <div class="password-strength">
                    <div class="password-strength-bar" id="passwordStrengthBar"></div>
                </div>
            </div>

            <div class="password-input-group">
                <label>Confirmer le nouveau mot de passe</label>
                <input type="password" id="confirmPassword" placeholder="Confirmez le nouveau mot de passe">
            </div>

            <div class="password-requirements">
                <strong>Exigences du mot de passe :</strong>
                <ul id="passwordRequirements">
                    <li id="req-length">Au moins 6 caract√®res</li>
                    <li id="req-match">Les mots de passe correspondent</li>
                </ul>
            </div>

            <button class="btn btn-primary" onclick="changePassword()">
                <i class="fas fa-check"></i> Changer le mot de passe
            </button>

            <button class="btn" onclick="closePasswordModal()" style="margin-top: 10px; background: #999; color: white;">
                Annuler
            </button>
        </div>
    </div>

    <div class="debug-panel" id="debugPanel">
        <div>üìä DEBUG INFO</div>
        <div id="debugContent"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <script>
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBI1svukv3Ts7fN97ke5OGfwo2V-vRUGHI&callback=initMap';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
    </script>

    <script>
        // ====== CONFIGURATION FIREBASE ======
        const firebaseConfig = {
            apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
            authDomain: "albourakh-sn-ok.firebaseapp.com",
            projectId: "albourakh-sn-ok",
            storageBucket: "albourakh-sn-ok.firebasestorage.app",
            messagingSenderId: "297875396274",
            appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        console.log('üöï Al Bourakh Driver Pro - VERSION OPTIMIS√âE 3.3.0 ‚úÖ‚úÖ‚úÖ');
        console.log('üîÑ Corrections appliqu√©es:');
        console.log('   ‚úÖ Gestion multi-format t√©l√©phones');
        console.log('   ‚úÖ Cr√©ation automatique comptes');
        console.log('   ‚úÖ Synchronisation compl√®te Firebase');
        console.log('   ‚úÖ Debug et diagnostic int√©gr√©s');

        // ====== VARIABLES GLOBALES ======
        let currentUser = null;
        let isOnline = false;
        let currentCourse = null;
        let map = null;
        let marker = null;
        let directionsService = null;
        let directionsRenderer = null;
        let watchPositionId = null;
        let chatListener = null;
        let unreadMessages = 0;
        let gpsAttempts = 0;
        let gpsActivated = false;
        
        let stats = {
            coursesJour: 0,
            revenusJour: 0,
            rating: 4.8,
            coursesTotal: 0
        };

        // ====== FONCTIONS UTILITAIRES ======
        
        /**
         * Normalise un num√©ro de t√©l√©phone en retirant les caract√®res sp√©ciaux
         * et en g√©n√©rant plusieurs formats possibles
         */
        function normalizePhoneNumber(phone) {
            // Nettoyer le num√©ro
            phone = phone.replace(/[\s\-\(\)\.]/g, ''); // Enlever espaces et caract√®res
            phone = phone.replace(/^\+/, ''); // Enlever le + au d√©but
            phone = phone.replace(/^00/, ''); // Enlever 00 au d√©but
            
            // G√©n√©rer les formats possibles
            const formats = [];
            
            if (phone.startsWith('221')) {
                // Format international complet
                formats.push(phone); // 221771234567
                formats.push(phone.substring(3)); // 771234567
            } else if (phone.startsWith('00221')) {
                // Format avec 00221
                formats.push(phone.substring(5)); // 771234567
                formats.push(phone.substring(2)); // 221771234567
            } else if (phone.match(/^[67][0-8]/)) {
                // Format local s√©n√©galais (commence par 6, 70-78)
                formats.push(phone); // 771234567
                formats.push('221' + phone); // 221771234567
            } else {
                // Autres formats
                formats.push(phone);
            }
            
            // Enlever les doublons
            return [...new Set(formats)];
        }

        // ====== FONCTION DE CONNEXION AM√âLIOR√âE ======
        async function handleLogin() {
            let phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!phone || !password) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }

            // MODE DEMO
            if (password === 'demo123') {
                console.log('üß™ MODE DEMO ACTIV√â');
                showLoading('Connexion d√©mo...');
                
                setTimeout(() => {
                    currentUser = {
                        uid: 'DEMO_USER_' + Date.now(),
                        telephone: phone,
                        prenom: 'Chauffeur',
                        nom: 'Demo',
                        rating: 4.8,
                        coursesCompletees: 42,
                        revenusTotal: 150000,
                        isDemo: true
                    };
                    
                    hideLoading();
                    showToast('‚úÖ Connexion d√©mo r√©ussie!', 'success');
                    document.getElementById('bottomNav').style.display = 'flex';
                    showScreen('dashboardScreen');
                    loadDashboardDataDemo();
                    startLocationTracking();
                }, 1000);
                return;
            }

            showLoading('Connexion...');
            console.log('üîê Tentative de connexion...');

            // Obtenir tous les formats possibles
            const phoneFormats = normalizePhoneNumber(phone);
            console.log('üì± Formats test√©s:', phoneFormats);

            let connectionSuccess = false;
            let lastError = null;

            // Essayer chaque format
            for (const format of phoneFormats) {
                try {
                    const email = format + '@albourakh.sn';
                    console.log(`üìß Test: ${email}`);
                    
                    // Tenter la connexion
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const uid = userCredential.user.uid;
                    
                    console.log('‚úÖ Auth r√©ussie avec:', email);
                    
                    // V√©rifier/cr√©er le document driver
                    let driverDoc = await db.collection('drivers').doc(uid).get();
                    
                    if (!driverDoc.exists) {
                        console.log('‚ö†Ô∏è Document driver manquant, cr√©ation...');
                        await db.collection('drivers').doc(uid).set({
                            telephone: phone,
                            prenom: 'Chauffeur',
                            nom: 'Al Bourakh',
                            email: email,
                            statut: 'hors_ligne',
                            rating: 4.8,
                            coursesCompletees: 0,
                            revenusTotal: 0,
                            vehicule: {
                                marque: 'Toyota',
                                modele: 'Corolla',
                                immatriculation: 'DK-1234-AB'
                            },
                            dateInscription: firebase.firestore.FieldValue.serverTimestamp(),
                            actif: true
                        });
                        driverDoc = await db.collection('drivers').doc(uid).get();
                    }
                    
                    const driverData = driverDoc.data();
                    currentUser = { uid: uid, ...driverData };
                    
                    // Mettre √† jour derni√®re connexion
                    await db.collection('drivers').doc(uid).update({
                        derniereConnexion: firebase.firestore.FieldValue.serverTimestamp(),
                        statut: 'hors_ligne'
                    });

                    hideLoading();
                    showToast(`‚úÖ Bienvenue ${driverData.prenom || 'Chauffeur'} !`, 'success');
                    
                    document.getElementById('bottomNav').style.display = 'flex';
                    showScreen('dashboardScreen');
                    loadDashboardData();
                    startLocationTracking();
                    
                    connectionSuccess = true;
                    break;
                    
                } catch (error) {
                    console.log(`‚ùå √âchec ${format}:`, error.code);
                    lastError = error;
                    
                    // Si le compte n'existe pas et qu'on utilise Admin2025, cr√©er automatiquement
                    if (error.code === 'auth/user-not-found' && password === 'Admin2025') {
                        try {
                            console.log('üîß Cr√©ation automatique du compte...');
                            const email = format + '@albourakh.sn';
                            
                            const newUser = await auth.createUserWithEmailAndPassword(email, password);
                            const uid = newUser.user.uid;
                            
                            // Cr√©er le document driver
                            await db.collection('drivers').doc(uid).set({
                                telephone: phone,
                                prenom: 'Chauffeur',
                                nom: 'Al Bourakh',
                                email: email,
                                statut: 'hors_ligne',
                                rating: 4.8,
                                coursesCompletees: 0,
                                revenusTotal: 0,
                                vehicule: {
                                    marque: 'Toyota',
                                    modele: 'Corolla',
                                    immatriculation: 'DK-1234-AB'
                                },
                                dateInscription: firebase.firestore.FieldValue.serverTimestamp(),
                                actif: true
                            });
                            
                            currentUser = {
                                uid: uid,
                                telephone: phone,
                                prenom: 'Chauffeur',
                                nom: 'Al Bourakh',
                                email: email,
                                rating: 4.8,
                                coursesCompletees: 0,
                                revenusTotal: 0
                            };
                            
                            hideLoading();
                            showToast('‚úÖ Compte cr√©√© avec succ√®s!', 'success');
                            
                            document.getElementById('bottomNav').style.display = 'flex';
                            showScreen('dashboardScreen');
                            loadDashboardData();
                            startLocationTracking();
                            
                            connectionSuccess = true;
                            break;
                            
                        } catch (createError) {
                            console.error('Erreur cr√©ation:', createError);
                        }
                    }
                }
            }

            if (!connectionSuccess) {
                hideLoading();
                let errorMsg = '‚ùå Identifiants incorrects';
                
                if (lastError) {
                    if (lastError.code === 'auth/wrong-password') {
                        errorMsg = '‚ùå Mot de passe incorrect';
                    } else if (lastError.code === 'auth/user-not-found') {
                        errorMsg = '‚ùå Compte non trouv√© (utilisez Admin2025)';
                    } else if (lastError.code === 'auth/too-many-requests') {
                        errorMsg = '‚ùå Trop de tentatives, r√©essayez plus tard';
                    }
                }
                
                showToast(errorMsg, 'error');
            }
        }

        // ====== FONCTION DE CR√âATION DE COMPTE TEST ======
        async function createTestAccount() {
            const phone = prompt('Num√©ro de t√©l√©phone (ex: 771234567):');
            if (!phone) return;
            
            showLoading('Cr√©ation du compte test...');
            
            try {
                const formats = normalizePhoneNumber(phone);
                const email = formats[0] + '@albourakh.sn';
                
                // Cr√©er le compte
                const userCredential = await auth.createUserWithEmailAndPassword(email, 'Admin2025');
                const uid = userCredential.user.uid;
                
                // Cr√©er le document driver
                await db.collection('drivers').doc(uid).set({
                    telephone: phone,
                    prenom: 'Test',
                    nom: 'Chauffeur',
                    email: email,
                    statut: 'hors_ligne',
                    rating: 4.8,
                    coursesCompletees: 0,
                    revenusTotal: 0,
                    vehicule: {
                        marque: 'Toyota',
                        modele: 'Corolla',
                        immatriculation: 'DK-TEST-' + Math.floor(Math.random() * 1000)
                    },
                    dateInscription: firebase.firestore.FieldValue.serverTimestamp(),
                    actif: true
                });
                
                hideLoading();
                alert(`‚úÖ Compte cr√©√©!\n\nEmail: ${email}\nMot de passe: Admin2025\nT√©l√©phone: ${phone}`);
                
                // Remplir automatiquement les champs
                document.getElementById('loginPhone').value = phone;
                document.getElementById('loginPassword').value = 'Admin2025';
                
            } catch (error) {
                hideLoading();
                console.error('Erreur cr√©ation:', error);
                
                if (error.code === 'auth/email-already-in-use') {
                    alert('‚ùå Ce num√©ro a d√©j√† un compte');
                } else {
                    alert('‚ùå Erreur: ' + error.message);
                }
            }
        }

        // ====== FONCTION DE R√âINITIALISATION MOT DE PASSE ======
        async function resetPassword() {
            const phone = prompt('Votre num√©ro de t√©l√©phone:');
            if (!phone) return;
            
            showToast('üìß Instructions envoy√©es (simulation)', 'info');
            
            // Dans un cas r√©el, vous pourriez envoyer un SMS ou email
            alert('Nouveau mot de passe: Admin2025\n\n(En production, un SMS serait envoy√©)');
        }

        // ====== GOOGLE MAPS ======
        function initMap() {
            console.log('üó∫Ô∏è Initialisation de Google Maps...');
            
            const mapOptions = {
                center: { lat: 14.6937, lng: -17.4441 }, // Dakar
                zoom: 14,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            };
            
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            
            marker = new google.maps.Marker({
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#00A854',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3
                }
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#00A854',
                    strokeWeight: 5
                }
            });

            console.log('‚úÖ Google Maps initialis√©');
        }

        window.initMap = initMap;
        loadGoogleMaps();

        // ====== G√âOLOCALISATION ======
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showToast('‚ùå G√©olocalisation non support√©e', 'error');
                return;
            }

            console.log('üìç D√©marrage du suivi de position...');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 10000
            };

            watchPositionId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    
                    console.log(`‚úÖ Position: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
                    
                    if (marker && map) {
                        const newPos = { lat: latitude, lng: longitude };
                        marker.setPosition(newPos);
                        map.panTo(newPos);
                    }

                    let qualityIcon = accuracy < 50 ? 'üü¢' : accuracy < 100 ? 'üü°' : 'üî¥';
                    document.getElementById('accuracy').innerHTML = 
                        `${qualityIcon} Pr√©cision: ${Math.round(accuracy)} m`;
                    
                    reverseGeocode(latitude, longitude);

                    // Mise √† jour Firebase si en ligne et non d√©mo
                    if (currentUser && isOnline && !currentUser.isDemo) {
                        db.collection('drivers').doc(currentUser.uid).update({
                            position: {
                                latitude,
                                longitude,
                                accuracy,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            },
                            derniereActivite: firebase.firestore.FieldValue.serverTimestamp()
                        }).catch(err => console.error('Erreur MAJ position:', err));
                    }

                    if (!gpsActivated) {
                        gpsActivated = true;
                        showToast('‚úÖ Position GPS activ√©e', 'success');
                    }
                },
                (error) => {
                    gpsAttempts++;
                    console.error('‚ùå Erreur g√©olocalisation:', error);
                    
                    let errorMessage = error.code === 1 ? 'üîí Permission refus√©e' : 
                                     error.code === 2 ? 'üì° Position indisponible' : 
                                     '‚è±Ô∏è Timeout';
                    
                    if (gpsAttempts === 1) {
                        showToast(errorMessage, 'error');
                        if (error.code === 1) {
                            document.getElementById('permissionGuide').classList.add('show');
                        }
                    }
                    
                    document.getElementById('currentAddress').textContent = 'Position non disponible';
                    document.getElementById('accuracy').innerHTML = 'üî¥ GPS d√©sactiv√©';
                },
                options
            );
        }

        function stopLocationTracking() {
            if (watchPositionId) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
                gpsActivated = false;
                console.log('üõë Suivi de position arr√™t√©');
            }
        }

        async function reverseGeocode(lat, lng) {
            try {
                if (!google || !google.maps) {
                    document.getElementById('currentAddress').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    return;
                }

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('currentAddress').textContent = results[0].formatted_address;
                    } else {
                        document.getElementById('currentAddress').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    }
                });
            } catch (error) {
                console.error('Erreur g√©ocodage:', error);
            }
        }

        function diagnosticGeolocation() {
            console.log('üîç === DIAGNOSTIC G√âOLOCALISATION ===');
            
            if (!navigator.geolocation) {
                alert('‚ùå G√©olocalisation NON disponible');
                return;
            }
            
            showToast('üß™ Test GPS en cours...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('‚úÖ TEST R√âUSSI!');
                    showToast('‚úÖ GPS fonctionne!', 'success');
                    alert(`‚úÖ TEST GPS R√âUSSI!\n\nLat: ${position.coords.latitude.toFixed(6)}\nLng: ${position.coords.longitude.toFixed(6)}\nPr√©cision: ${Math.round(position.coords.accuracy)} m`);
                },
                (error) => {
                    console.error('‚ùå TEST √âCHOU√â:', error);
                    let msg = error.code === 1 ? 'Permission refus√©e' : error.code === 2 ? 'Position indisponible' : 'Timeout';
                    showToast(`‚ùå Test √©chou√©: ${msg}`, 'error');
                    alert(`‚ùå TEST GPS √âCHOU√â!\n\nErreur: ${msg}\n\nSolutions:\n1. V√©rifiez les permissions\n2. Activez la localisation\n3. Rechargez la page`);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // ====== GESTION DES COURSES ======
        async function toggleOnlineStatus() {
            if (!currentUser) {
                showToast('Veuillez vous connecter', 'error');
                return;
            }

            isOnline = !isOnline;
            const toggle = document.getElementById('toggleSwitch');
            const statusText = document.getElementById('statusText');

            if (isOnline) {
                toggle.classList.add('active');
                statusText.textContent = 'üü¢ EN LIGNE';
                statusText.classList.add('online');
                showToast('‚úÖ Vous √™tes en ligne', 'success');

                if (!currentUser.isDemo) {
                    try {
                        await db.collection('drivers').doc(currentUser.uid).update({
                            statut: 'disponible',
                            derniereActivite: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        startLocationTracking();
                        listenForNewCourses();
                    } catch (error) {
                        console.error('Erreur:', error);
                    }
                }

            } else {
                toggle.classList.remove('active');
                statusText.textContent = '‚ö´ HORS LIGNE';
                statusText.classList.remove('online');
                showToast('Vous √™tes hors ligne', 'info');

                if (!currentUser.isDemo) {
                    try {
                        await db.collection('drivers').doc(currentUser.uid).update({
                            statut: 'hors_ligne',
                            derniereActivite: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        stopLocationTracking();
                    } catch (error) {
                        console.error('Erreur:', error);
                    }
                }
            }
        }

        let courseListener = null;

        function listenForNewCourses() {
            if (!currentUser || !isOnline || currentUser.isDemo) return;

            console.log('üëÇ √âcoute des nouvelles courses...');

            courseListener = db.collection('reservations')
                .where('chauffeurAssigne', '==', currentUser.uid)
                .where('statut', '==', 'assignee')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const course = { id: change.doc.id, ...change.doc.data() };
                            console.log('üîî Nouvelle course:', course);
                            showCourseNotification(course);
                        }
                    });
                });
        }

        async function simulateNewCourse() {
            if (!isOnline) {
                showToast('Vous devez √™tre en ligne', 'error');
                return;
            }

            showLoading('Cr√©ation de la course de test...');

            if (currentUser.isDemo) {
                console.log('üß™ Mode d√©mo : simulation');
                hideLoading();
                
                setTimeout(() => {
                    const testCourse = {
                        id: 'DEMO_COURSE_' + Date.now(),
                        depart: 'Plateau, Dakar',
                        destination: 'Almadies',
                        prixEstime: 3500,
                        distance: '12 km',
                        passagers: 2,
                        clientNom: 'Aminata Sow (DEMO)',
                        clientTelephone: '+221 77 999 88 77',
                        client: { nom: 'Aminata Sow (DEMO)', telephone: '+221 77 999 88 77', rating: 4.9 }
                    };
                    showCourseNotification(testCourse);
                }, 500);
                return;
            }

            try {
                const testReservation = {
                    depart: 'Plateau, Dakar',
                    destination: 'Almadies',
                    prixEstime: 3500,
                    distance: 12,
                    passagers: 2,
                    statut: 'assignee',
                    chauffeurAssigne: currentUser.uid,
                    clientNom: 'Aminata Sow',
                    clientTelephone: '+221 77 999 88 77',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('reservations').add(testReservation);
                hideLoading();

                setTimeout(() => {
                    const testCourse = {
                        id: docRef.id,
                        ...testReservation,
                        distance: '12 km',
                        client: { nom: 'Aminata Sow', telephone: '+221 77 999 88 77', rating: 4.9 }
                    };
                    showCourseNotification(testCourse);
                }, 500);

            } catch (error) {
                console.error('Erreur:', error);
                hideLoading();
                showToast('Erreur de cr√©ation', 'error');
            }
        }

        function showCourseNotification(course) {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSOBzPDYizcIGWi77eeeTRAMUKfj8LZjHAY4ktfyy3ksBSR3x/DdkEAKFF606+uoVRQKRp/g8r5sIQUjgczw2Ik3CBlou+3nnk0QDFCn4/C2YxwGOJLX8st5LAUkd8fw3ZBAC');
                audio.play().catch(() => {});
            } catch (e) {}

            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

            const notification = document.createElement('div');
            notification.className = 'course-notification';
            notification.innerHTML = `
                <div class="course-modal">
                    <div class="course-timer" id="courseTimer">30<div class="course-timer-label">secondes</div></div>
                    <h2 class="course-title">üîî NOUVELLE COURSE !</h2>
                    <div class="course-client">
                        <strong>Client:</strong> ${course.client?.nom || course.clientNom || 'Client'}<br>
                        ${course.client?.rating ? '‚≠ê ' + course.client.rating : ''}
                    </div>
                    <div class="course-route">
                        <div class="route-point"><span class="route-icon">üìç</span><span>${course.depart}</span></div>
                        <div style="text-align: center; margin: 10px 0;">‚Üì</div>
                        <div class="route-point"><span class="route-icon">üéØ</span><span>${course.destination}</span></div>
                    </div>
                    <div class="course-details">
                        <div class="detail-item"><div class="detail-icon">üí∞</div><div>${course.prixEstime?.toLocaleString() || 0} FCFA</div></div>
                        <div class="detail-item"><div class="detail-icon">üìè</div><div>${course.distance || '5 km'}</div></div>
                        <div class="detail-item"><div class="detail-icon">üë•</div><div>${course.passagers || 1} pers.</div></div>
                    </div>
                    <div class="course-actions">
                        <button class="btn btn-refuse" onclick="refuseCourse('${course.id}')">‚ùå REFUSER</button>
                        <button class="btn btn-accept" onclick="acceptCourse('${course.id}')">‚úÖ ACCEPTER</button>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            let timeLeft = 30;
            const timerInterval = setInterval(() => {
                timeLeft--;
                const timerElement = document.getElementById('courseTimer');
                if (timerElement) {
                    timerElement.innerHTML = `${timeLeft}<div class="course-timer-label">secondes</div>`;
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    refuseCourse(course.id, true);
                }
            }, 1000);

            notification.timerInterval = timerInterval;
        }

        async function acceptCourse(courseId) {
            const notification = document.querySelector('.course-notification');
            if (notification) {
                clearInterval(notification.timerInterval);
                notification.remove();
            }

            showLoading('Acceptation...');

            if (currentUser.isDemo || courseId.startsWith('DEMO_COURSE_')) {
                console.log('üß™ Mode d√©mo : acceptation simul√©e');
                currentCourse = {
                    id: courseId,
                    depart: 'Plateau, Dakar',
                    destination: 'Almadies',
                    prixEstime: 3500,
                    distance: '12 km',
                    clientNom: 'Aminata Sow (DEMO)',
                    clientTelephone: '+221 77 999 88 77',
                    clientRating: 4.9
                };
                
                setTimeout(() => {
                    hideLoading();
                    showToast('‚úÖ Course accept√©e (DEMO)!', 'success');
                    showScreen('activeCourseScreen');
                    displayActiveCourse();
                    document.getElementById('chatFab').classList.add('active');
                }, 1000);
                return;
            }

            try {
                const courseDoc = await db.collection('reservations').doc(courseId).get();
                
                if (!courseDoc.exists) {
                    throw new Error('R√©servation non trouv√©e');
                }

                await db.collection('reservations').doc(courseId).update({
                    statut: 'acceptee',
                    accepteeParChauffeur: true,
                    dateAcceptation: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('üîÑ SYNCHRONISATION:');
                console.log('   ‚Üí currentBookingId: ' + courseId);
                console.log('   ‚Üí reservationEnCours: ' + courseId);

                await db.collection('drivers').doc(currentUser.uid).update({
                    statut: 'en_course',
                    currentBookingId: courseId,
                    reservationEnCours: courseId
                });

                console.log('‚úÖ SYNCHRONISATION R√âUSSIE!');

                currentCourse = { id: courseId, ...courseDoc.data() };
                hideLoading();
                showToast('‚úÖ Course accept√©e!', 'success');
                
                showScreen('activeCourseScreen');
                displayActiveCourse();
                document.getElementById('chatFab').classList.add('active');
                listenToChat(courseId);

            } catch (error) {
                console.error('Erreur acceptation:', error);
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function refuseCourse(courseId, auto = false) {
            const notification = document.querySelector('.course-notification');
            if (notification) {
                clearInterval(notification.timerInterval);
                notification.remove();
            }

            if (currentUser.isDemo || courseId.startsWith('DEMO_COURSE_')) {
                console.log('üß™ Mode d√©mo : refus simul√©');
                if (!auto) showToast('Course refus√©e (DEMO)', 'info');
                else showToast('‚è±Ô∏è Temps √©coul√© (DEMO)', 'info');
                return;
            }

            if (!auto) showLoading('Refus...');

            try {
                await db.collection('reservations').doc(courseId).update({
                    chauffeursRefuses: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
                    chauffeurAssigne: null,
                    statut: 'en_attente'
                });

                if (!auto) {
                    hideLoading();
                    showToast('Course refus√©e', 'info');
                } else {
                    showToast('‚è±Ô∏è Temps √©coul√©', 'info');
                }
            } catch (error) {
                console.error('Erreur refus:', error);
                if (!auto) {
                    hideLoading();
                    showToast('Erreur', 'error');
                }
            }
        }

        function displayActiveCourse() {
            if (!currentCourse) return;

            document.getElementById('clientName').textContent = currentCourse.clientNom || 'Client';
            document.getElementById('clientPhone').textContent = currentCourse.clientTelephone || '';
            document.getElementById('clientRating').textContent = currentCourse.clientRating ? `‚≠ê ${currentCourse.clientRating}` : '';
            document.getElementById('activeDeparture').textContent = currentCourse.depart;
            document.getElementById('activeDestination').textContent = currentCourse.destination;
            document.getElementById('activePrice').textContent = `${currentCourse.prixEstime?.toLocaleString()} FCFA`;

            if (google && google.maps) {
                showRoute(currentCourse.depart, currentCourse.destination);
            }
        }

        function showRoute(origin, destination) {
            if (!directionsService || !directionsRenderer || !google) {
                console.log('‚ö†Ô∏è Google Maps non charg√©');
                return;
            }

            const activeCourseMap = new google.maps.Map(document.getElementById('activeCourseMap'), {
                zoom: 13,
                center: { lat: 14.6937, lng: -17.4441 }
            });

            directionsRenderer.setMap(activeCourseMap);

            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: 'DRIVING'
            }, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    const route = result.routes[0].legs[0];
                    document.getElementById('estimatedTime').textContent = `Temps estim√©: ${route.duration.text}`;
                    document.getElementById('remainingDistance').textContent = `Distance: ${route.distance.text}`;
                }
            });
        }

        async function updateCourseStatus(newStatus) {
            if (!currentCourse) return;

            showLoading('Mise √† jour...');

            if (currentUser.isDemo) {
                setTimeout(() => {
                    currentCourse.statut = newStatus;
                    hideLoading();
                    showToast(statusMessages[newStatus] || 'Statut mis √† jour', 'success');
                    updateStatusDisplay(newStatus);
                }, 500);
                return;
            }

            try {
                await db.collection('reservations').doc(currentCourse.id).update({
                    statut: newStatus,
                    derniereModification: firebase.firestore.FieldValue.serverTimestamp()
                });

                currentCourse.statut = newStatus;

                const statusMessages = {
                    'arrive': '‚úÖ Arriv√© sur place',
                    'en_cours': 'üöó Course d√©marr√©e',
                };

                hideLoading();
                showToast(statusMessages[newStatus] || 'Statut mis √† jour', 'success');
                updateStatusDisplay(newStatus);

            } catch (error) {
                console.error('Erreur:', error);
                hideLoading();
                showToast('Erreur', 'error');
            }
        }

        function updateStatusDisplay(status) {
            const statusBadge = document.getElementById('courseStatus');
            const statusTitle = document.getElementById('courseStatusTitle');

            if (status === 'arrive') {
                statusBadge.className = 'status-badge arrive';
                statusBadge.textContent = 'üìç Arriv√© sur place';
                statusTitle.textContent = 'En attente du client';
            } else if (status === 'en_cours') {
                statusBadge.className = 'status-badge en-cours';
                statusBadge.textContent = 'üöó Course en cours';
                statusTitle.textContent = 'Direction: ' + (currentCourse?.destination || 'Destination');
            }
        }

        function completeCourse() {
            if (!currentCourse) return;

            document.getElementById('paymentAmount').textContent = `${currentCourse.prixEstime?.toLocaleString()} FCFA`;
            document.getElementById('paymentModal').classList.add('active');
        }

        let selectedPaymentMethod = null;

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            selectedPaymentMethod = null;
        }

        async function confirmPayment() {
            if (!selectedPaymentMethod) {
                showToast('S√©lectionnez un mode de paiement', 'error');
                return;
            }

            closePaymentModal();
            showLoading('Finalisation...');

            if (currentUser.isDemo) {
                console.log('üß™ Mode d√©mo : finalisation simul√©e');
                setTimeout(() => {
                    currentCourse = null;
                    document.getElementById('chatFab').classList.remove('active');
                    document.getElementById('chatContainer').classList.remove('active');
                    hideLoading();
                    showToast('‚úÖ Course termin√©e (DEMO)!', 'success');
                    showScreen('dashboardScreen');
                    loadDashboardDataDemo();
                }, 1000);
                return;
            }

            try {
                await db.collection('reservations').doc(currentCourse.id).update({
                    statut: 'terminee',
                    modePaiementFinal: selectedPaymentMethod,
                    dateFin: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('üîÑ SYNCHRONISATION TERMINAISON');

                await db.collection('drivers').doc(currentUser.uid).update({
                    statut: 'disponible',
                    currentBookingId: null,
                    reservationEnCours: null,
                    coursesCompletees: firebase.firestore.FieldValue.increment(1),
                    revenusTotal: firebase.firestore.FieldValue.increment(currentCourse.prixEstime || 0)
                });

                console.log('‚úÖ SYNCHRONISATION R√âUSSIE');

                currentCourse = null;
                
                document.getElementById('chatFab').classList.remove('active');
                document.getElementById('chatContainer').classList.remove('active');
                if (chatListener) {
                    chatListener();
                    chatListener = null;
                }

                hideLoading();
                showToast('‚úÖ Course termin√©e!', 'success');
                
                showScreen('dashboardScreen');
                loadDashboardData();

            } catch (error) {
                console.error('Erreur:', error);
                hideLoading();
                showToast('Erreur', 'error');
            }
        }

        async function cancelCourse() {
            if (!confirm('Voulez-vous vraiment annuler cette course ?')) return;

            showLoading('Annulation...');

            if (currentUser.isDemo) {
                console.log('üß™ Mode d√©mo : annulation simul√©e');
                setTimeout(() => {
                    currentCourse = null;
                    hideLoading();
                    showToast('Course annul√©e (DEMO)', 'info');
                    showScreen('dashboardScreen');
                }, 1000);
                return;
            }

            try {
                await db.collection('reservations').doc(currentCourse.id).update({
                    statut: 'annulee',
                    annuleePar: 'chauffeur',
                    dateAnnulation: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('üîÑ SYNCHRONISATION ANNULATION');

                await db.collection('drivers').doc(currentUser.uid).update({
                    statut: 'disponible',
                    currentBookingId: null,
                    reservationEnCours: null
                });

                console.log('‚úÖ SYNCHRONISATION R√âUSSIE');

                currentCourse = null;

                hideLoading();
                showToast('Course annul√©e', 'info');
                
                showScreen('dashboardScreen');

            } catch (error) {
                console.error('Erreur:', error);
                hideLoading();
                showToast('Erreur', 'error');
            }
        }

        function openGoogleMaps() {
            if (!currentCourse) {
                showToast('Aucune course active', 'error');
                return;
            }
            const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(currentCourse.depart)}&travelmode=driving`;
            window.open(url, '_blank');
        }

        function callClient() {
            if (!currentCourse || !currentCourse.clientTelephone) {
                showToast('Num√©ro client non disponible', 'error');
                return;
            }
            window.location.href = `tel:${currentCourse.clientTelephone}`;
        }

        // ====== CHAT ======
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.toggle('active');
            
            if (chatContainer.classList.contains('active')) {
                unreadMessages = 0;
                document.getElementById('chatBadge').style.display = 'none';
                document.getElementById('chatInput').focus();
            }
        }

        function listenToChat(courseId) {
            const messagesRef = db.collection('reservations').doc(courseId).collection('messages');
            
            chatListener = messagesRef.orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';

                snapshot.forEach(doc => {
                    const msg = doc.data();
                    addMessageToChat(msg);
                });

                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const msg = change.doc.data();
                        if (msg.senderId !== currentUser.uid && !document.getElementById('chatContainer').classList.contains('active')) {
                            unreadMessages++;
                            const badge = document.getElementById('chatBadge');
                            badge.textContent = unreadMessages;
                            badge.style.display = 'flex';
                        }
                    }
                });
            });
        }

        function addMessageToChat(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
            
            const time = message.timestamp ? message.timestamp.toDate().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) : '';
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${message.senderId === currentUser.uid ? 'sent' : 'received'}">
                    ${message.text}
                </div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || !currentCourse) return;

            if (currentUser.isDemo) {
                addMessageToChat({
                    text: text,
                    senderId: currentUser.uid,
                    senderType: 'driver',
                    timestamp: { toDate: () => new Date() }
                });
                input.value = '';
                return;
            }

            try {
                await db.collection('reservations').doc(currentCourse.id).collection('messages').add({
                    text: text,
                    senderId: currentUser.uid,
                    senderType: 'driver',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                input.value = '';
            } catch (error) {
                console.error('Erreur:', error);
                showToast('Erreur envoi', 'error');
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ====== DASHBOARD ======
        async function loadDashboardData() {
            try {
                if (!currentUser || currentUser.isDemo) return;

                const driverDoc = await db.collection('drivers').doc(currentUser.uid).get();
                const driverData = driverDoc.data();

                document.getElementById('profileName').textContent = `${driverData.prenom || ''} ${driverData.nom || ''}`;
                document.getElementById('profilePhone').textContent = driverData.telephone || '';
                document.getElementById('rating').textContent = (driverData.rating || 4.8).toFixed(1);
                document.getElementById('coursesTotal').textContent = driverData.coursesCompletees || 0;
                document.getElementById('profileTotalCourses').textContent = driverData.coursesCompletees || 0;
                document.getElementById('profileRevenuTotal').textContent = (driverData.revenusTotal || 0).toLocaleString() + ' FCFA';

                const aujourdhui = new Date();
                aujourdhui.setHours(0, 0, 0, 0);

                const coursesSnapshot = await db.collection('reservations')
                    .where('chauffeurAssigne', '==', currentUser.uid)
                    .where('timestamp', '>=', aujourdhui)
                    .get();

                let coursesJour = 0;
                let revenusJour = 0;

                coursesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.statut === 'terminee') {
                        coursesJour++;
                        revenusJour += data.prixEstime || 0;
                    }
                });

                document.getElementById('coursesJour').textContent = coursesJour;
                document.getElementById('revenusJour').textContent = revenusJour.toLocaleString();

                stats = {
                    coursesJour,
                    revenusJour,
                    rating: driverData.rating || 4.8,
                    coursesTotal: driverData.coursesCompletees || 0
                };

                if (driverData.reservationEnCours) {
                    const courseDoc = await db.collection('reservations').doc(driverData.reservationEnCours).get();
                    if (courseDoc.exists) {
                        currentCourse = { id: courseDoc.id, ...courseDoc.data() };
                        showScreen('activeCourseScreen');
                    }
                }

                loadHistory();

            } catch (error) {
                console.error('‚ùå Erreur chargement:', error);
            }
        }

        function loadDashboardDataDemo() {
            console.log('üìä Chargement d√©mo...');
            
            document.getElementById('profileName').textContent = `${currentUser.prenom} ${currentUser.nom}`;
            document.getElementById('profilePhone').textContent = currentUser.telephone;
            document.getElementById('rating').textContent = currentUser.rating.toFixed(1);
            document.getElementById('coursesTotal').textContent = currentUser.coursesCompletees;
            document.getElementById('profileTotalCourses').textContent = currentUser.coursesCompletees;
            document.getElementById('profileRevenuTotal').textContent = currentUser.revenusTotal.toLocaleString() + ' FCFA';

            const coursesJour = Math.floor(Math.random() * 5) + 3;
            const revenusJour = coursesJour * 3500;
            
            document.getElementById('coursesJour').textContent = coursesJour;
            document.getElementById('revenusJour').textContent = revenusJour.toLocaleString();

            stats = { coursesJour, revenusJour, rating: currentUser.rating, coursesTotal: currentUser.coursesCompletees };

            loadHistoryDemo();
            showToast('üìä Mode d√©mo actif', 'info');
        }

        async function loadHistory() {
            try {
                if (!currentUser) return;

                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Chargement...</p>';

                if (currentUser.isDemo) {
                    loadHistoryDemo();
                    return;
                }

                const allCourses = [];

                const acceptedSnapshot = await db.collection('reservations')
                    .where('chauffeurAssigne', '==', currentUser.uid)
                    .limit(50)
                    .get();

                acceptedSnapshot.forEach(doc => {
                    allCourses.push({ id: doc.id, ...doc.data() });
                });

                historyList.innerHTML = '';

                if (allCourses.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune course</p>';
                    return;
                }

                allCourses.sort((a, b) => {
                    const dateA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                    const dateB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                    return dateB - dateA;
                });

                allCourses.forEach(data => {
                    const date = data.timestamp ? data.timestamp.toDate() : new Date();
                    
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.style.borderLeft = '3px solid #00A854';
                    
                    item.innerHTML = `
                        <div class="history-header">
                            <span class="history-date">${date.toLocaleDateString('fr-FR')} ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                            <span class="history-price">${(data.prixEstime || 0).toLocaleString()} FCFA</span>
                        </div>
                        <div class="history-route">üìç ${data.depart}</div>
                        <div class="history-route">üéØ ${data.destination}</div>
                        <span class="history-status" style="background: ${getStatusColor(data.statut)}">${getStatusLabel(data.statut)}</span>
                    `;
                    historyList.appendChild(item);
                });

            } catch (error) {
                console.error('Erreur:', error);
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '<p style="text-align: center; color: #E30613; padding: 40px;">‚ùå Erreur</p>';
            }
        }

        function loadHistoryDemo() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const coursesDemo = [
                { date: new Date(), depart: 'Plateau', destination: 'Almadies', prix: 3500, statut: 'terminee' },
                { date: new Date(Date.now() - 2 * 60 * 60 * 1000), depart: 'Sacr√©-C≈ìur', destination: 'Yoff', prix: 4200, statut: 'terminee' },
                { date: new Date(Date.now() - 24 * 60 * 60 * 1000), depart: 'M√©dina', destination: 'Mamelles', prix: 2800, statut: 'terminee' },
                { date: new Date(Date.now() - 48 * 60 * 60 * 1000), depart: 'Grand Yoff', destination: 'Plateau', prix: 3200, statut: 'terminee' }
            ];
            
            coursesDemo.forEach(course => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.style.borderLeft = '3px solid #00A854';
                item.innerHTML = `
                    <div class="history-header">
                        <span class="history-date">${course.date.toLocaleDateString('fr-FR')} ${course.date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                        <span class="history-price">${course.prix.toLocaleString()} FCFA</span>
                    </div>
                    <div class="history-route">üìç ${course.depart}</div>
                    <div class="history-route">üéØ ${course.destination}</div>
                    <span class="history-status">‚úÖ Termin√©e (DEMO)</span>
                `;
                historyList.appendChild(item);
            });
        }

        function getStatusLabel(statut) {
            const labels = {
                'en_attente': 'En attente',
                'assignee': 'Assign√©e',
                'acceptee': 'Accept√©e',
                'en_cours': 'En cours',
                'terminee': 'Termin√©e',
                'annulee': 'Annul√©e'
            };
            return labels[statut] || statut;
        }

        function getStatusColor(statut) {
            const colors = {
                'en_attente': '#FFA500',
                'assignee': '#2196F3',
                'acceptee': '#00A854',
                'en_cours': '#00A854',
                'terminee': '#00A854',
                'annulee': '#999'
            };
            return colors[statut] || '#00A854';
        }

        // ====== MOT DE PASSE ======
        function showPasswordModal() {
            if (currentUser && currentUser.isDemo) {
                showToast('‚ùå Non disponible en mode d√©mo', 'error');
                return;
            }

            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            const strengthBar = document.getElementById('passwordStrengthBar');
            strengthBar.className = 'password-strength-bar';
            strengthBar.style.width = '0%';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('passwordStrengthBar');
            const reqLength = document.getElementById('req-length');
            
            if (password.length >= 6) {
                reqLength.classList.add('requirement-met');
            } else {
                reqLength.classList.remove('requirement-met');
            }

            let strength = 0;
            if (password.length >= 6) strength += 1;
            if (password.length >= 8) strength += 1;
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^A-Za-z0-9]/.test(password)) strength += 1;

            strengthBar.className = 'password-strength-bar';
            
            if (strength <= 1) {
                strengthBar.classList.add('strength-weak');
            } else if (strength <= 3) {
                strengthBar.classList.add('strength-medium');
            } else {
                strengthBar.classList.add('strength-strong');
            }

            checkPasswordMatch();
        }

        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const reqMatch = document.getElementById('req-match');

            if (confirmPassword && newPassword === confirmPassword) {
                reqMatch.classList.add('requirement-met');
            } else {
                reqMatch.classList.remove('requirement-met');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Remplir tous les champs', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showToast('6 caract√®res minimum', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('Mots de passe diff√©rents', 'error');
                return;
            }

            closePasswordModal();
            showLoading('Changement...');

            try {
                const user = auth.currentUser;
                if (!user) throw new Error('Non connect√©');

                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                await user.reauthenticateWithCredential(credential);
                await user.updatePassword(newPassword);

                await db.collection('drivers').doc(currentUser.uid).update({
                    derniereModificationMotDePasse: firebase.firestore.FieldValue.serverTimestamp()
                });

                hideLoading();
                showToast('‚úÖ Mot de passe chang√©!', 'success');

            } catch (error) {
                hideLoading();
                let errorMsg = 'Erreur';
                if (error.code === 'auth/wrong-password') errorMsg = '‚ùå Mot de passe incorrect';
                showToast(errorMsg, 'error');
            }
        }

        // ====== D√âCONNEXION ======
        async function handleLogout() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                showLoading('D√©connexion...');
                
                try {
                    if (isOnline) {
                        await toggleOnlineStatus();
                    }
                    
                    if (currentUser && !currentUser.isDemo) {
                        await db.collection('drivers').doc(currentUser.uid).update({
                            statut: 'hors_ligne',
                            derniereDeconnexion: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error('Erreur d√©connexion:', error);
                }
                
                stopLocationTracking();
                currentUser = null;
                currentCourse = null;
                hideLoading();
                document.getElementById('bottomNav').style.display = 'none';
                showScreen('loginScreen');
                showToast('D√©connexion r√©ussie', 'info');
            }
        }

        // ====== NAVIGATION ======
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            const navIndex = { 'dashboardScreen': 0, 'activeCourseScreen': 1, 'historyScreen': 2, 'profileScreen': 3 };
            if (navIndex[screenId] !== undefined) {
                document.querySelectorAll('.nav-item')[navIndex[screenId]].classList.add('active');
            }

            if (screenId === 'activeCourseScreen' && currentCourse) {
                displayActiveCourse();
            }
        }

        // ====== UTILITAIRES UI ======
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoading(text = 'Chargement...') {
            const loading = document.createElement('div');
            loading.className = 'loading-overlay';
            loading.id = 'loadingOverlay';
            loading.innerHTML = `<div class="loading-spinner"></div><div class="loading-text">${text}</div>`;
            document.body.appendChild(loading);
        }

        function hideLoading() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) loading.remove();
        }

        // ====== INITIALISATION ======
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöï Al Bourakh Driver Pro - READY');
            console.log('üì± Format accept√©s: 77xxxxxxx, 221-77-xxx-xx-xx, +221 77 xxx xx xx');
            console.log('üîê Admin2025: Cr√©ation automatique si inexistant');
            console.log('üß™ demo123: Mode d√©mo instantan√©');
            
            // Pr√©-remplir pour test rapide
            document.getElementById('loginPhone').value = '+221 77 123 45 67';
            document.getElementById('loginPassword').value = 'Admin2025';

            // G√©rer Google Maps absent
            if (typeof google === 'undefined' || !google.maps) {
                console.log('‚ö†Ô∏è Google Maps non charg√©, cr√©ation de fallback');
                window.google = {
                    maps: {
                        Map: class { constructor() {} },
                        Marker: class { constructor() {} setPosition() {} },
                        DirectionsService: class {},
                        DirectionsRenderer: class { setMap() {} setDirections() {} },
                        Geocoder: class {},
                        SymbolPath: { CIRCLE: 0 }
                    }
                };
            }

            // Debug mode (appuyer 5 fois sur le titre)
            let debugClickCount = 0;
            document.querySelector('.login-title').addEventListener('click', () => {
                debugClickCount++;
                if (debugClickCount >= 5) {
                    document.getElementById('debugPanel').classList.toggle('show');
                    debugClickCount = 0;
                    updateDebugInfo();
                }
            });
        });

        // ====== FONCTIONS DEBUG ======
        function updateDebugInfo() {
            const debugContent = document.getElementById('debugContent');
            if (!debugContent) return;
            
            debugContent.innerHTML = `
                User: ${currentUser ? currentUser.uid.substring(0, 8) : 'None'}<br>
                Online: ${isOnline}<br>
                Course: ${currentCourse ? currentCourse.id.substring(0, 8) : 'None'}<br>
                GPS: ${gpsActivated ? '‚úì' : '‚úó'}<br>
                Auth: ${auth.currentUser ? '‚úì' : '‚úó'}
            `;
        }
    </script>
</body>
</html>
