<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Al Bourakh Driver Pro v4.8 - Logo Al Bourakh</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; }
        .mobile-container { max-width: 414px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .app-header { background: linear-gradient(135deg, #00A854, #FECB00); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .app-header h1 { font-size: 1.2em; display: flex; align-items: center; gap: 10px; }
        .app-header h1 img { width: 24px; height: 24px; object-fit: contain; }
        .app-header button { background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        
        .login-screen { padding: 40px 30px; text-align: center; }
        .login-logo { width: 100px; height: 100px; margin: 0 auto 20px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5em; box-shadow: 0 8px 20px rgba(0,168,84,0.3); overflow: hidden; }
        .login-logo img { width: 70%; height: 70%; object-fit: contain; }
        .login-title { font-size: 1.8em; color: #00A854; margin-bottom: 10px; }
        .login-subtitle { color: #666; margin-bottom: 30px; }
        
        .input-group { margin-bottom: 15px; text-align: left; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .input-group input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; transition: border-color 0.3s; }
        .input-group input:focus { outline: none; border-color: #00A854; }
        .input-group input.valid { border-color: #00A854; background: #f0fdf4; }
        .input-group input.invalid { border-color: #E30613; background: #fef2f2; }
        .input-helper { font-size: 0.75em; color: #666; margin-top: 5px; }
        .input-helper.error { color: #E30613; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 8px 25px rgba(0,168,84,0.3); }
        
        .dashboard-content { padding: 15px; padding-bottom: 100px; }
        
        /* Photo de profil dans header */
        .header-profile-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid white; cursor: pointer; }
        .header-profile-placeholder { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.2em; border: 2px solid white; cursor: pointer; }
        
        .status-toggle { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .status-text { font-size: 1.1em; font-weight: bold; color: #999; }
        .status-text.online { color: #00A854; }
        .toggle-switch { position: relative; width: 60px; height: 34px; background: #ccc; border-radius: 34px; cursor: pointer; }
        .toggle-switch.active { background: #00A854; }
        .toggle-switch::after { content: ''; position: absolute; width: 26px; height: 26px; background: white; border-radius: 50%; top: 4px; left: 4px; transition: all 0.3s; }
        .toggle-switch.active::after { left: 30px; }
        
        .map-container { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .map-container h3 { margin-bottom: 10px; color: #333; font-size: 1em; }
        #map { width: 100%; height: 250px; border-radius: 10px; background: #e0e0e0; }
        #activeCourseMap { width: 100%; height: 280px; border-radius: 10px; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); min-height: 280px; }
        .location-info { background: #f5f5f5; padding: 12px; border-radius: 10px; margin-top: 10px; font-size: 0.9em; }
        .location-info div { margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        .stat-icon { font-size: 2em; margin-bottom: 8px; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #00A854; }
        .stat-label { color: #666; font-size: 0.85em; }
        
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; cursor: pointer; border: none; font-size: 0.9em; }
        .action-btn:hover { transform: translateY(-3px); }
        .action-btn-icon { font-size: 1.8em; margin-bottom: 8px; }
        
        .course-notification { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .course-modal { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 25px; max-height: 90vh; overflow-y: auto; }
        .course-timer { background: linear-gradient(135deg, #E30613, #FF6B00); color: white; width: 70px; height: 70px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 1.8em; font-weight: bold; }
        .course-timer-label { font-size: 0.35em; }
        .course-title { text-align: center; font-size: 1.3em; color: #00A854; margin-bottom: 15px; }
        .course-client, .course-route { background: #f5f5f5; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
        .route-point { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .route-icon { font-size: 1.3em; }
        .course-details { display: flex; justify-content: space-around; margin: 15px 0; padding: 12px; background: #f5f5f5; border-radius: 10px; }
        .detail-item { text-align: center; }
        .detail-icon { font-size: 1.3em; margin-bottom: 5px; }
        .course-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-refuse { background: #E30613; color: white; }
        .btn-accept { background: #00A854; color: white; }
        
        .active-course-container { padding: 15px; padding-bottom: 100px; }
        .course-status-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-weight: bold; font-size: 0.9em; margin-bottom: 10px; }
        .status-badge.approche { background: #fff3cd; color: #856404; }
        .status-badge.acceptee { background: #d4edda; color: #155724; }
        .status-badge.en-route { background: #d1ecf1; color: #0c5460; }
        .status-badge.arrive { background: #fff3cd; color: #856404; }
        .status-badge.en-cours { background: #cce5ff; color: #004085; }
        
        .route-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .route-tab { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 600; font-size: 0.85em; background: white; }
        .route-tab.active { border-color: #00A854; background: #e8f5e9; color: #00A854; }
        .route-tab.disabled { opacity: 0.5; cursor: not-allowed; }
        .route-tab i { display: block; font-size: 1.5em; margin-bottom: 5px; }
        
        .route-info-box { background: linear-gradient(135deg, #00A854, #FECB00); padding: 15px; border-radius: 12px; color: white; margin-bottom: 15px; }
        .route-info-box.approche { background: linear-gradient(135deg, #2196F3, #00BCD4); }
        .route-info-title { font-size: 0.9em; opacity: 0.9; margin-bottom: 8px; }
        .route-info-details { display: flex; justify-content: space-around; text-align: center; }
        .route-info-item { flex: 1; }
        .route-info-value { font-size: 1.4em; font-weight: bold; }
        .route-info-label { font-size: 0.75em; opacity: 0.9; }
        
        .client-info-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .client-info-card h3 { margin-bottom: 12px; color: #333; font-size: 1em; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; }
        .info-row:last-child { border-bottom: none; }
        
        .navigation-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .nav-btn { padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9em; }
        .nav-btn.primary { background: #00A854; color: white; }
        .nav-btn.secondary { background: #2196F3; color: white; }
        .nav-btn.warning { background: #FF9800; color: white; }
        .nav-btn.danger { background: #E30613; color: white; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 10px 0; max-width: 414px; margin: 0 auto; z-index: 1000; }
        .nav-item { text-align: center; cursor: pointer; padding: 8px; flex: 1; }
        .nav-item.active { color: #00A854; }
        .nav-icon { font-size: 1.3em; margin-bottom: 4px; }
        .nav-label { font-size: 0.75em; }
        
        .toast { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); z-index: 9999; max-width: 300px; animation: slideInRight 0.3s; }
        @keyframes slideInRight { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .toast.success { border-left: 4px solid #00A854; }
        .toast.error { border-left: 4px solid #E30613; }
        .toast.info { border-left: 4px solid #2196F3; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: #FECB00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 1.1em; margin-top: 15px; }
        
        .history-list { padding: 15px; padding-bottom: 100px; }
        .history-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .history-date { color: #666; font-size: 0.85em; }
        .history-price { font-weight: bold; color: #00A854; }
        .history-route { color: #333; margin-bottom: 5px; font-size: 0.9em; }
        .history-status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; background: #00A854; color: white; }
        
        /* PROFIL AVEC PHOTO */
        .profile-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 25px 20px; text-align: center; color: white; position: relative; }
        .profile-avatar { width: 100px; height: 100px; background: white; border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 2.5em; color: #00A854; overflow: hidden; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 1.3em; font-weight: bold; margin-bottom: 5px; }
        .profile-info { padding: 15px; padding-bottom: 100px; }
        .info-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .info-label { color: #666; }
        .info-value { font-weight: bold; color: #333; }
        
        .version-badge { display: inline-block; background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 4px; font-size: 0.65em; font-weight: bold; margin-left: 5px; }
        .fix-badge { display: inline-block; background: #cce5ff; color: #004085; padding: 2px 6px; border-radius: 4px; font-size: 0.65em; font-weight: bold; margin-left: 5px; }
        
        .debug-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin-top: 15px; font-size: 0.75em; font-family: monospace; }
        .debug-box h4 { color: #6c757d; margin-bottom: 8px; }
        
        @media (max-width: 414px) { .mobile-container, .bottom-nav { max-width: 100%; } }
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- LOGIN SCREEN -->
        <div id="loginScreen" class="screen active">
            <div class="login-screen">
                <div class="login-logo">
                    <img src="https://i.imgur.com/VtgG6pR.png" alt="Al Bourakh Logo" onerror="this.src='https://i.imgur.com/VtgG6pR.jpg'">
                </div>
                <h1 class="login-title">Al Bourakh Driver <span class="version-badge">v4.8</span><span class="fix-badge">LOGO</span></h1>
                <p class="login-subtitle">Connexion S√©curis√©e</p>
                
                <div class="input-group">
                    <label>üì± T√©l√©phone</label>
                    <input type="tel" id="loginPhone" placeholder="+221 77 123 45 67" oninput="formatPhoneInput(this)">
                    <div class="input-helper" id="phoneHelper">
                        Formats accept√©s : 77/78/76/70 XXX XX XX
                    </div>
                </div>
                <div class="input-group">
                    <label>üîí Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="Mot de passe">
                </div>
                
                <button class="btn btn-primary" onclick="handleLogin()">Se connecter</button>
                
                <div style="background: #e8f5e9; padding: 12px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #4CAF50; font-size: 0.85em;">
                    <p><strong>üîê Connexion:</strong> Num√©ro enregistr√© + <code>Admin2025</code></p>
                    <p><strong>üß™ Mode D√©mo:</strong> Tout num√©ro + <code>demo123</code></p>
                    <p style="margin-top: 8px;"><strong>üì± Formats accept√©s:</strong></p>
                    <p style="margin-left: 10px;">‚Ä¢ +221 77 123 45 67</p>
                    <p style="margin-left: 10px;">‚Ä¢ 77 123 45 67</p>
                    <p style="margin-left: 10px;">‚Ä¢ 77123456</p>
                    <p style="font-size: 0.9em; color: #666; margin-top: 5px;">Indicatifs: 77, 78, 76, 70</p>
                </div>
                
                <div style="background: #cce5ff; padding: 12px; border-radius: 10px; margin-top: 10px; border-left: 4px solid #004085; font-size: 0.8em;">
                    <p><strong>‚úÖ v4.8 LOGO:</strong></p>
                    <p>‚Ä¢ Logo Al Bourakh int√©gr√©</p>
                    <p>‚Ä¢ Design professionnel</p>
                    <p>‚Ä¢ Identit√© visuelle compl√®te</p>
                </div>
                
                <div class="debug-box" id="loginDebug" style="display: none;">
                    <h4>üîç Debug Login</h4>
                    <div id="debugContent"></div>
                </div>
                
                <p style="margin-top: 20px; color: #999; font-size: 0.8em;">Version 4.8 LOGO ¬© 2025</p>
            </div>
        </div>

        <!-- DASHBOARD SCREEN -->
        <div id="dashboardScreen" class="screen">
            <div class="app-header">
                <h1><img src="https://i.imgur.com/VtgG6pR.png" alt="Logo" onerror="this.src='https://i.imgur.com/VtgG6pR.jpg'"> Dashboard</h1>
                <div id="headerProfilePhoto" onclick="showScreen('profileScreen')"></div>
            </div>
            
            <div class="dashboard-content">
                <div class="status-toggle">
                    <div>
                        <h3 style="font-size: 0.95em; margin-bottom: 5px;">Statut</h3>
                        <div class="status-text" id="statusText">‚ö´ HORS LIGNE</div>
                    </div>
                    <div class="toggle-switch" id="toggleSwitch" onclick="toggleOnlineStatus()"></div>
                </div>
                
                <div class="map-container">
                    <h3>üìç Ma Position</h3>
                    <div id="map"></div>
                    <div class="location-info" id="locationInfo">
                        <div><i class="fas fa-map-marker-alt"></i> <span id="currentAddress">En attente...</span></div>
                        <div><i class="fas fa-crosshairs"></i> <span id="accuracy">Pr√©cision: -- m</span></div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üöó</div>
                        <div class="stat-value" id="coursesJour">0</div>
                        <div class="stat-label">Courses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="revenusJour">0</div>
                        <div class="stat-label">FCFA</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="rating">4.8</div>
                        <div class="stat-label">Note</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="coursesTotal">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn" onclick="showScreen('historyScreen')">
                        <div class="action-btn-icon">üìä</div>
                        <div>Historique</div>
                    </button>
                    <button class="action-btn" onclick="simulateNewCourse()">
                        <div class="action-btn-icon">üîî</div>
                        <div>Test Course</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- ACTIVE COURSE SCREEN -->
        <div id="activeCourseScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-route"></i> Course Active</h1>
                <button onclick="callClient()"><i class="fas fa-phone"></i></button>
            </div>
            
            <div class="active-course-container">
                <div class="route-tabs">
                    <div class="route-tab active" id="tabApproche" onclick="showRouteTab('approche')">
                        <i class="fas fa-car-side"></i>
                        Vers Client
                    </div>
                    <div class="route-tab disabled" id="tabCourse" onclick="showRouteTab('course')">
                        <i class="fas fa-route"></i>
                        Course
                    </div>
                </div>
                
                <div class="map-container" style="margin-bottom: 15px;">
                    <div id="activeCourseMap" style="height: 280px;"></div>
                </div>
                
                <div class="route-info-box approche" id="routeInfoApproche">
                    <div class="route-info-title">üöó TRAJET VERS LE CLIENT</div>
                    <div class="route-info-details">
                        <div class="route-info-item">
                            <div class="route-info-value" id="approcheDistance">--</div>
                            <div class="route-info-label">Distance</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-value" id="approcheDuration">--</div>
                            <div class="route-info-label">Dur√©e</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-value" id="approcheETA">--</div>
                            <div class="route-info-label">Arriv√©e</div>
                        </div>
                    </div>
                </div>
                
                <div class="route-info-box" id="routeInfoCourse" style="display: none;">
                    <div class="route-info-title">üéØ TRAJET DE LA COURSE</div>
                    <div class="route-info-details">
                        <div class="route-info-item">
                            <div class="route-info-value" id="courseDistance">--</div>
                            <div class="route-info-label">Distance</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-value" id="courseDuration">--</div>
                            <div class="route-info-label">Dur√©e</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-value" id="coursePrice">--</div>
                            <div class="route-info-label">Prix</div>
                        </div>
                    </div>
                </div>
                
                <div class="course-status-card">
                    <span class="status-badge approche" id="courseStatus">üöó En route vers client</span>
                    <h3 id="courseStatusTitle" style="font-size: 1em;">Direction: Point de prise en charge</h3>
                </div>
                
                <div class="client-info-card" id="clientInfoCard">
                    <h3>üë§ Client</h3>
                    <div class="info-row"><span>Nom</span><strong id="clientName">-</strong></div>
                    <div class="info-row"><span>T√©l√©phone</span><strong id="clientPhone">-</strong></div>
                    <div class="info-row"><span>Note</span><strong id="clientRating">-</strong></div>
                </div>
                
                <div class="client-info-card">
                    <h3>üó∫Ô∏è Trajet du Client</h3>
                    <div class="info-row"><span>üìç D√©part</span><strong id="activeDeparture">-</strong></div>
                    <div class="info-row"><span>üéØ Destination</span><strong id="activeDestination">-</strong></div>
                    <div class="info-row"><span>üí∞ Prix</span><strong id="activePrice">-</strong></div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-btn secondary" id="btnNavigation" onclick="openGoogleMapsToClient()">
                        <i class="fas fa-map-marked-alt"></i> GPS Client
                    </button>
                    <button class="nav-btn primary" onclick="callClient()">
                        <i class="fas fa-phone"></i> Appeler
                    </button>
                </div>
                
                <div class="navigation-buttons" style="margin-top: 10px;" id="actionButtons">
                    <button class="nav-btn warning" id="btnArrive" onclick="updateCourseStatus('arrive')">
                        <i class="fas fa-map-pin"></i> Arriv√©
                    </button>
                    <button class="nav-btn primary" id="btnStart" onclick="updateCourseStatus('en_cours')" style="display: none;">
                        <i class="fas fa-play"></i> D√©marrer
                    </button>
                </div>
                
                <button class="btn btn-primary" onclick="completeCourse()" style="margin-top: 15px;" id="btnComplete" disabled>
                    <i class="fas fa-check-circle"></i> Terminer la course
                </button>
                
                <button class="btn" onclick="cancelCourse()" style="margin-top: 10px; background: #E30613; color: white;">
                    <i class="fas fa-times-circle"></i> Annuler
                </button>
            </div>
        </div>

        <!-- HISTORY SCREEN -->
        <div id="historyScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-history"></i> Historique</h1>
                <button onclick="loadHistory()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>

        <!-- PROFILE SCREEN AVEC PHOTO -->
        <div id="profileScreen" class="screen">
            <div class="profile-header">
                <button onclick="showScreen('dashboardScreen')" style="position: absolute; left: 15px; top: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="profile-avatar" id="profileAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-name" id="profileName">Chauffeur</div>
                <div style="font-size: 0.9em;">‚≠ê <span id="profileRating">4.8</span> ‚Ä¢ <span id="profileTotalCourses">0</span> courses</div>
            </div>
            <div class="profile-info">
                <div class="info-item"><span class="info-label">üì± T√©l√©phone</span><span class="info-value" id="profilePhone">-</span></div>
                <div class="info-item"><span class="info-label">üÜî ID Firestore</span><span class="info-value" id="profileFirestoreId" style="font-size: 0.6em; word-break: break-all;">-</span></div>
                <div class="info-item"><span class="info-label">üöó V√©hicule</span><span class="info-value" id="profileVehicle">-</span></div>
                <div class="info-item"><span class="info-label">üí∞ Revenus Total</span><span class="info-value" id="profileRevenuTotal">0 FCFA</span></div>
                <button class="btn btn-primary" onclick="handleLogout()" style="margin-top: 20px; background: #E30613;">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <div class="nav-item active" onclick="showScreen('dashboardScreen')">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <div class="nav-label">Accueil</div>
            </div>
            <div class="nav-item" onclick="showScreen('activeCourseScreen')">
                <div class="nav-icon"><i class="fas fa-route"></i></div>
                <div class="nav-label">Course</div>
            </div>
            <div class="nav-item" onclick="showScreen('historyScreen')">
                <div class="nav-icon"><i class="fas fa-history"></i></div>
                <div class="nav-label">Historique</div>
            </div>
            <div class="nav-item" onclick="showScreen('profileScreen')">
                <div class="nav-icon"><i class="fas fa-user"></i></div>
                <div class="nav-label">Profil</div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Google Maps -->
    <script>
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBI1svukv3Ts7fN97ke5OGfwo2V-vRUGHI&callback=initMap';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
    </script>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
            authDomain: "albourakh-sn-ok.firebaseapp.com",
            projectId: "albourakh-sn-ok",
            storageBucket: "albourakh-sn-ok.firebasestorage.app",
            messagingSenderId: "297875396274",
            appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        console.log('üöï Al Bourakh Driver Pro v4.8 LOGO - Ready');

        // ========== GLOBAL VARIABLES ==========
        let currentUser = null;
        let isOnline = false;
        let currentCourse = null;
        let map = null;
        let activeCourseMap = null;
        let driverMarker = null;
        let clientPickupMarker = null;
        let clientDestinationMarker = null;
        let directionsService = null;
        let directionsRenderer = null;
        let watchPositionId = null;
        let driverPosition = null;
        let currentRouteMode = 'approche';
        let approcheRoute = null;
        let courseRoute = null;

        // ========== VALIDATION T√âL√âPHONE S√âN√âGALAIS ==========
        function validateSenegalPhone(phone) {
            if (!phone) return { valid: false, message: 'Num√©ro requis' };
            
            // Nettoyer le num√©ro (enlever espaces, tirets, etc.)
            const cleaned = phone.replace(/[\s\-\.]/g, '');
            
            // Formats accept√©s pour les indicatifs 77, 78, 76, 70
            const patterns = [
                /^\+221(77|78|76|70)\d{7}$/,     // +22177xxxxxxx
                /^221(77|78|76|70)\d{7}$/,       // 22177xxxxxxx (sans +)
                /^(77|78|76|70)\d{7}$/,          // 77xxxxxxx
                /^00221(77|78|76|70)\d{7}$/      // 0022177xxxxxxx
            ];
            
            const isValid = patterns.some(pattern => pattern.test(cleaned));
            
            if (!isValid) {
                return {
                    valid: false,
                    message: 'Format invalide. Utilisez : +221 77/78/76/70 XXX XX XX'
                };
            }
            
            return { valid: true, normalized: cleaned };
        }
        
        function formatPhoneForDisplay(phone) {
            const cleaned = phone.replace(/[\s\-\.]/g, '');
            
            // Si commence par +221 ou 221
            if (cleaned.startsWith('+221')) {
                const number = cleaned.substring(4);
                return `+221 ${number.substring(0, 2)} ${number.substring(2, 5)} ${number.substring(5, 7)} ${number.substring(7)}`;
            } else if (cleaned.startsWith('221')) {
                const number = cleaned.substring(3);
                return `+221 ${number.substring(0, 2)} ${number.substring(2, 5)} ${number.substring(5, 7)} ${number.substring(7)}`;
            } else if (/^(77|78|76|70)/.test(cleaned)) {
                return `+221 ${cleaned.substring(0, 2)} ${cleaned.substring(2, 5)} ${cleaned.substring(5, 7)} ${cleaned.substring(7)}`;
            }
            
            return phone;
        }
        
        function formatPhoneInput(input) {
            const oldValue = input.value;
            const cleaned = oldValue.replace(/[\s\-\.]/g, '');
            const helper = document.getElementById('phoneHelper');
            
            // Limiter √† 13 caract√®res au total (avec le +) ou 12 chiffres
            // Format complet : +221701234567 = 13 caract√®res
            if (cleaned.length > 13) {
                input.value = oldValue.substring(0, oldValue.length - 1);
                return;
            }
            
            // Validation visuelle en temps r√©el
            if (cleaned.length > 0) {
                const validation = validateSenegalPhone(oldValue);
                if (validation.valid) {
                    input.classList.remove('invalid');
                    input.classList.add('valid');
                    if (helper) {
                        helper.textContent = '‚úì Num√©ro valide';
                        helper.classList.remove('error');
                        helper.style.color = '#00A854';
                    }
                } else {
                    input.classList.remove('valid');
                    if (cleaned.length >= 9) {
                        input.classList.add('invalid');
                        if (helper) {
                            helper.textContent = validation.message;
                            helper.classList.add('error');
                        }
                    } else {
                        input.classList.remove('invalid');
                        if (helper) {
                            helper.textContent = 'Formats accept√©s : 77/78/76/70 XXX XX XX';
                            helper.classList.remove('error');
                            helper.style.color = '#666';
                        }
                    }
                }
            } else {
                input.classList.remove('valid', 'invalid');
                if (helper) {
                    helper.textContent = 'Formats accept√©s : 77/78/76/70 XXX XX XX';
                    helper.classList.remove('error');
                    helper.style.color = '#666';
                }
            }
        }

        // ========== DEBUG FUNCTIONS ==========
        function showDebug(show = true) {
            document.getElementById('loginDebug').style.display = show ? 'block' : 'none';
        }
        
        function addDebugLog(message) {
            const debugContent = document.getElementById('debugContent');
            const time = new Date().toLocaleTimeString();
            debugContent.innerHTML += `<div>[${time}] ${message}</div>`;
            console.log(`[DEBUG] ${message}`);
        }

        // ========== NORMALISATION T√âL√âPHONE ==========
        function normalizePhoneForComparison(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, '');
        }

        function getPhoneVariants(phone) {
            const digits = normalizePhoneForComparison(phone);
            const variants = new Set();
            
            // Ajouter le num√©ro nettoy√©
            variants.add(digits);
            
            // Extraire les 9 derniers chiffres (num√©ro local)
            const localNumber = digits.slice(-9);
            
            // G√©n√©rer toutes les variantes possibles
            variants.add(localNumber);                           // 771234567
            variants.add('+221' + localNumber);                  // +221771234567
            variants.add('221' + localNumber);                   // 221771234567
            variants.add('00221' + localNumber);                 // 00221771234567
            
            // Si le num√©ro commence d√©j√† par 221, ajouter avec +
            if (digits.startsWith('221')) {
                variants.add('+' + digits);
                const local = digits.substring(3);
                variants.add(local);
                variants.add('+221' + local);
            }
            
            // Si le num√©ro commence par +221
            if (digits.startsWith('+221')) {
                variants.add(digits.substring(1));  // Sans le +
                variants.add(digits.substring(4));  // Juste le num√©ro local
            }
            
            // Filtrer pour ne garder que les num√©ros valides (9 chiffres ou plus)
            return [...variants].filter(v => {
                const cleaned = v.replace(/\D/g, '');
                return cleaned.length >= 9;
            });
        }

        // ========== RECHERCHE CHAUFFEUR ==========
        async function findDriverByPhone(inputPhone) {
            const inputDigits = normalizePhoneForComparison(inputPhone);
            const inputVariants = getPhoneVariants(inputPhone);
            
            addDebugLog(`üì± Recherche pour: ${inputPhone}`);
            addDebugLog(`üì± Digits: ${inputDigits}`);
            addDebugLog(`üì± Variantes: ${inputVariants.join(', ')}`);
            
            try {
                const snapshot = await db.collection('drivers').get();
                
                addDebugLog(`üìä ${snapshot.size} chauffeurs trouv√©s dans Firestore`);
                
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    const dbPhone = data.telephone || '';
                    const dbDigits = normalizePhoneForComparison(dbPhone);
                    
                    addDebugLog(`  ‚Üí ${data.prenom} ${data.nom}: ${dbPhone} (digits: ${dbDigits})`);
                    
                    const inputLocal = inputDigits.slice(-9);
                    const dbLocal = dbDigits.slice(-9);
                    
                    if (inputLocal === dbLocal && inputLocal.length === 9) {
                        addDebugLog(`‚úÖ MATCH TROUV√â: ${doc.id} - ${data.prenom} ${data.nom}`);
                        return { id: doc.id, ...data };
                    }
                    
                    for (const variant of inputVariants) {
                        if (dbPhone === variant || dbDigits === normalizePhoneForComparison(variant)) {
                            addDebugLog(`‚úÖ MATCH EXACT: ${doc.id} - ${data.prenom} ${data.nom}`);
                            return { id: doc.id, ...data };
                        }
                    }
                }
                
                addDebugLog(`‚ùå Aucun chauffeur trouv√© pour ce num√©ro`);
                return null;
                
            } catch (error) {
                addDebugLog(`‚ùå Erreur: ${error.message}`);
                console.error('Erreur recherche chauffeur:', error);
                return null;
            }
        }

        // ========== GESTION PHOTO DE PROFIL ==========
        async function fetchDriverPhoto(driverData) {
            console.log('üì∏ Recherche photo pour:', driverData.telephone);
            console.log('[DEBUG] Driver data:', driverData);
            
            // 1. Chercher dans les donn√©es driver actuelles
            let photoUrl = driverData.photoProfil ||          // ‚úÖ AJOUT√â
                          driverData.photoIdentite || 
                          driverData.photoUrl || 
                          driverData.photos?.photoProfil ||   // ‚úÖ AJOUT√â
                          driverData.photos?.photoIdentite;
            
            if (photoUrl) {
                console.log('‚úÖ Photo trouv√©e dans donn√©es driver actuelles:', photoUrl);
                return photoUrl;
            }
            
            console.log('[DEBUG] Photo: Aucune dans donn√©es driver actuelles');
            
            // 2. Chercher dans TOUS les documents de la collection drivers
            try {
                console.log('üîç Recherche dans collection drivers...');
                const phoneVariants = getPhoneVariants(driverData.telephone);
                console.log('[DEBUG] Variantes t√©l√©phone:', phoneVariants);
                
                const driversSnapshot = await db.collection('drivers').get();
                console.log(`[DEBUG] ${driversSnapshot.size} chauffeurs trouv√©s dans drivers`);
                
                for (const doc of driversSnapshot.docs) {
                    const driver = doc.data();
                    const driverPhone = driver.telephone || '';
                    const driverDigits = normalizePhoneForComparison(driverPhone);
                    
                    // V√©rifier si c'est le m√™me chauffeur par t√©l√©phone
                    for (const variant of phoneVariants) {
                        const variantDigits = normalizePhoneForComparison(variant);
                        
                        if (driverDigits === variantDigits || 
                            driverDigits.endsWith(variantDigits.slice(-9)) ||
                            variantDigits.endsWith(driverDigits.slice(-9))) {
                            
                            console.log(`[DEBUG] Chauffeur ${doc.id}:`, {
                                nom: driver.nom,
                                prenom: driver.prenom,
                                telephone: driverPhone,
                                hasPhoto: !!(driver.photoProfil || driver.photoIdentite || driver.photoUrl || driver.photos?.photoProfil || driver.photos?.photoIdentite)
                            });
                            
                            // Chercher la photo
                            const foundPhoto = driver.photoProfil ||              // ‚úÖ AJOUT√â
                                             driver.photoIdentite || 
                                             driver.photoUrl || 
                                             driver.photos?.photoProfil ||        // ‚úÖ AJOUT√â
                                             driver.photos?.photoIdentite ||
                                             driver.photos?.photo_identite;
                            
                            if (foundPhoto) {
                                console.log('‚úÖ Photo trouv√©e dans drivers:', foundPhoto);
                                
                                // Si ce n'est pas le m√™me document, synchroniser
                                if (driverData.id && doc.id !== driverData.id && !driverData.isDemo) {
                                    try {
                                        await db.collection('drivers').doc(driverData.id).update({
                                            photoIdentite: foundPhoto
                                        });
                                        console.log('‚úÖ Photo synchronis√©e depuis autre driver');
                                    } catch (err) {
                                        console.warn('‚ö†Ô∏è Erreur sync photo:', err);
                                    }
                                }
                                
                                return foundPhoto;
                            }
                        }
                    }
                }
                
                console.log('[DEBUG] Aucune photo trouv√©e dans drivers');
                
            } catch (error) {
                console.error('‚ùå Erreur recherche dans drivers:', error);
            }
            
            // 3. Chercher dans la collection candidatures
            try {
                console.log('üîç Recherche dans candidatures...');
                const phoneVariants = getPhoneVariants(driverData.telephone);
                
                // R√©cup√©rer TOUTES les candidatures accept√©es
                const candidaturesSnapshot = await db.collection('candidatures')
                    .where('statut', '==', 'acceptee')
                    .get();
                
                console.log(`[DEBUG] ${candidaturesSnapshot.size} candidatures accept√©es trouv√©es`);
                
                let foundCandidature = null;
                
                for (const doc of candidaturesSnapshot.docs) {
                    const candidature = doc.data();
                    const candidaturePhone = candidature.telephone || candidature.phone || '';
                    const candidatureDigits = normalizePhoneForComparison(candidaturePhone);
                    
                    console.log(`[DEBUG] Candidature ${doc.id}:`, {
                        nom: candidature.nom,
                        prenom: candidature.prenom,
                        telephone: candidaturePhone,
                        digits: candidatureDigits,
                        hasPhoto: !!(candidature.photos?.photoIdentite || candidature.photoIdentite)
                    });
                    
                    // Comparer par t√©l√©phone
                    for (const variant of phoneVariants) {
                        const variantDigits = normalizePhoneForComparison(variant);
                        
                        if (candidatureDigits === variantDigits || 
                            candidatureDigits.endsWith(variantDigits.slice(-9)) ||
                            variantDigits.endsWith(candidatureDigits.slice(-9))) {
                            
                            console.log(`[DEBUG] ‚úÖ MATCH trouv√© avec candidature ${doc.id}`);
                            foundCandidature = { id: doc.id, ...candidature };
                            break;
                        }
                    }
                    
                    if (foundCandidature) break;
                }
                
                if (!foundCandidature) {
                    console.log('[DEBUG] ‚ùå Aucune candidature correspondante par t√©l√©phone');
                    
                    // Fallback: chercher par nom/pr√©nom
                    if (driverData.nom && driverData.prenom) {
                        console.log('[DEBUG] Tentative de recherche par nom/pr√©nom...');
                        for (const doc of candidaturesSnapshot.docs) {
                            const candidature = doc.data();
                            const nomMatch = candidature.nom?.toLowerCase().trim() === driverData.nom?.toLowerCase().trim();
                            const prenomMatch = candidature.prenom?.toLowerCase().trim() === driverData.prenom?.toLowerCase().trim();
                            
                            if (nomMatch && prenomMatch) {
                                console.log(`[DEBUG] ‚úÖ MATCH par nom trouv√©: ${doc.id}`);
                                foundCandidature = { id: doc.id, ...candidature };
                                break;
                            }
                        }
                    }
                }
                
                if (foundCandidature) {
                    // Chercher la photo dans plusieurs champs possibles
                    photoUrl = foundCandidature.photoProfil ||           // ‚úÖ AJOUT√â
                               foundCandidature.photos?.photoProfil ||    // ‚úÖ AJOUT√â
                               foundCandidature.photos?.photoIdentite || 
                               foundCandidature.photos?.photo_identite ||
                               foundCandidature.photoIdentite || 
                               foundCandidature.photoUrl ||
                               foundCandidature.photo;
                    
                    console.log('[DEBUG] Photo dans candidature:', photoUrl);
                    
                    if (photoUrl) {
                        console.log('‚úÖ Photo trouv√©e dans candidatures:', photoUrl);
                        
                        // Mettre √† jour le document driver avec la photo
                        if (driverData.id && !driverData.isDemo) {
                            try {
                                await db.collection('drivers').doc(driverData.id).update({
                                    photoIdentite: photoUrl,
                                    photoProfil: photoUrl,  // ‚úÖ AJOUT√â
                                    candidatureId: foundCandidature.id
                                });
                                console.log('‚úÖ Photo synchronis√©e vers drivers');
                            } catch (updateError) {
                                console.warn('‚ö†Ô∏è Impossible de synchroniser la photo:', updateError);
                            }
                        }
                        
                        return photoUrl;
                    } else {
                        console.log('[DEBUG] ‚ùå Candidature trouv√©e mais sans photo');
                    }
                } else {
                    console.log('‚ùå Aucune candidature correspondante trouv√©e');
                }
                
            } catch (error) {
                if (error.code === 'permission-denied') {
                    console.error('üîí ERREUR PERMISSIONS: Acc√®s refus√© √† candidatures');
                    showToast('‚ö†Ô∏è Permissions Firestore manquantes', 'error');
                } else {
                    console.error('‚ùå Erreur recherche photo:', error);
                }
            }
            
            console.log('‚ùå AUCUNE PHOTO TROUV√âE dans drivers ni candidatures');
            return null;
        }
        
        function displayProfilePhoto(photoUrl) {
            console.log('üì∏ Affichage photo:', photoUrl);
            
            // Photo dans le header
            const headerPhoto = document.getElementById('headerProfilePhoto');
            if (photoUrl) {
                headerPhoto.innerHTML = `<img src="${photoUrl}" class="header-profile-photo" alt="Photo" onerror="this.parentElement.innerHTML='<div class=\\'header-profile-placeholder\\'><i class=\\'fas fa-user\\'></i></div>'">`;
            } else {
                headerPhoto.innerHTML = `<div class="header-profile-placeholder"><i class="fas fa-user"></i></div>`;
            }
            
            // Photo dans le profil
            const profileAvatar = document.getElementById('profileAvatar');
            if (photoUrl) {
                profileAvatar.innerHTML = `<img src="${photoUrl}" alt="Photo de profil" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>'">`;
            } else {
                profileAvatar.innerHTML = `<i class="fas fa-user"></i>`;
            }
        }

        // ========== LOGIN ==========
        async function handleLogin() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!phone || !password) {
                showToast('Remplissez tous les champs', 'error');
                return;
            }
            
            // Valider le format du num√©ro
            const validation = validateSenegalPhone(phone);
            if (!validation.valid) {
                showToast(`‚ùå ${validation.message}`, 'error');
                addDebugLog(`‚ùå Format invalide: ${phone}`);
                return;
            }
            
            const normalizedPhone = validation.normalized;
            addDebugLog(`‚úÖ Num√©ro valide: ${phone} ‚Üí ${normalizedPhone}`);

            showDebug(true);
            document.getElementById('debugContent').innerHTML = '';
            addDebugLog('üöÄ D√©but connexion...');
            addDebugLog(`üì± Format accept√©: ${formatPhoneForDisplay(phone)}`);

            if (password === 'demo123') {
                showLoading('Connexion d√©mo...');
                setTimeout(() => {
                    currentUser = {
                        firestoreId: 'DEMO_' + Date.now(),
                        uid: 'DEMO_' + Date.now(),
                        telephone: formatPhoneForDisplay(phone),
                        prenom: 'Chauffeur',
                        nom: 'Demo',
                        rating: 4.8,
                        coursesCompletees: 42,
                        revenusTotal: 150000,
                        photoIdentite: 'https://via.placeholder.com/100/00A854/FFFFFF?text=DEMO',
                        isDemo: true
                    };
                    hideLoading();
                    showDebug(false);
                    showToast('‚úÖ Mode d√©mo activ√©!', 'success');
                    document.getElementById('bottomNav').style.display = 'flex';
                    displayProfilePhoto(currentUser.photoIdentite);
                    showScreen('dashboardScreen');
                    loadDashboardDataDemo();
                    startLocationTracking();
                }, 1000);
                return;
            }

            showLoading('Connexion...');

            try {
                addDebugLog('üîç Recherche du chauffeur...');
                const existingDriver = await findDriverByPhone(normalizedPhone);
                
                if (existingDriver) {
                    addDebugLog(`üéâ Chauffeur existant: ${existingDriver.id}`);
                    addDebugLog(`   Nom: ${existingDriver.prenom} ${existingDriver.nom}`);
                    addDebugLog(`   Photo: ${existingDriver.photoIdentite || existingDriver.photoUrl || 'Aucune'}`);
                    
                    if (password !== 'Admin2025') {
                        hideLoading();
                        showToast('‚ùå Mot de passe incorrect', 'error');
                        return;
                    }
                    
                    currentUser = {
                        firestoreId: existingDriver.id,
                        uid: existingDriver.id,
                        ...existingDriver
                    };
                    
                    await db.collection('drivers').doc(existingDriver.id).update({
                        derniereConnexion: firebase.firestore.FieldValue.serverTimestamp(),
                        statut: 'hors_ligne'
                    });
                    
                    hideLoading();
                    showDebug(false);
                    
                    // R√©cup√©rer et afficher la photo de profil
                    showLoading('Chargement de la photo...');
                    const photoUrl = await fetchDriverPhoto(currentUser);
                    displayProfilePhoto(photoUrl);
                    hideLoading();
                    
                    showToast(`‚úÖ Bienvenue ${currentUser.prenom || ''} ${currentUser.nom || ''}!`, 'success');
                    document.getElementById('bottomNav').style.display = 'flex';
                    showScreen('dashboardScreen');
                    loadDashboardData();
                    startLocationTracking();
                    return;
                }
                
                addDebugLog('‚ùå Chauffeur non trouv√© - Connexion refus√©e');
                hideLoading();
                showToast('‚ùå Num√©ro non enregistr√©. Contactez l\'administrateur.', 'error');
                return;
                
            } catch (error) {
                console.error('Erreur login:', error);
                addDebugLog(`‚ùå ERREUR: ${error.message}`);
                hideLoading();
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function handleLogout() {
            if (confirm('Voulez-vous vous d√©connecter?')) {
                showLoading('D√©connexion...');
                if (isOnline) toggleOnlineStatus();
                stopLocationTracking();
                if (!currentUser?.isDemo) auth.signOut();
                currentUser = null;
                currentCourse = null;
                hideLoading();
                document.getElementById('bottomNav').style.display = 'none';
                showScreen('loginScreen');
                showToast('D√©connexion r√©ussie', 'info');
            }
        }

        // ========== GOOGLE MAPS ==========
        function initMap() {
            const dakar = { lat: 14.6937, lng: -17.4441 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: dakar,
                zoom: 14,
                disableDefaultUI: true,
                zoomControl: true
            });
            
            driverMarker = new google.maps.Marker({
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#00A854',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 3
                },
                title: 'Ma position'
            });

            directionsService = new google.maps.DirectionsService();
        }

        window.initMap = initMap;
        loadGoogleMaps();

        // ========== GEOLOCATION ==========
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showToast('‚ùå G√©olocalisation non support√©e', 'error');
                return;
            }
            
            watchPositionId = navigator.geolocation.watchPosition(
                async (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    driverPosition = { lat: latitude, lng: longitude };
                    
                    if (driverMarker && map && !currentCourse) {
                        driverMarker.setPosition(driverPosition);
                        map.panTo(driverPosition);
                    }

                    document.getElementById('accuracy').innerHTML = 
                        `${accuracy < 50 ? 'üü¢' : 'üü°'} Pr√©cision: ${Math.round(accuracy)} m`;
                    
                    reverseGeocode(latitude, longitude);

                    if (currentUser && isOnline && !currentUser.isDemo) {
                        try {
                            const driverId = currentUser.firestoreId || currentUser.uid;
                            
                            await db.collection('drivers').doc(driverId).update({
                                position: { latitude, longitude, accuracy, timestamp: firebase.firestore.FieldValue.serverTimestamp() },
                                positionActuelle: new firebase.firestore.GeoPoint(latitude, longitude),
                                derniereActivite: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            if (currentCourse && currentCourse.id && !currentCourse.id.startsWith('TEST_')) {
                                await db.collection('reservations').doc(currentCourse.id).update({
                                    chauffeurPosition: { latitude, longitude, accuracy, timestamp: firebase.firestore.FieldValue.serverTimestamp() },
                                    chauffeurPositionTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        } catch (err) {
                            console.error('Erreur MAJ position:', err);
                        }
                    }

                    if (currentCourse && activeCourseMap && currentRouteMode === 'approche') {
                        updateApprocheRoute();
                    }
                },
                (error) => {
                    console.error('Erreur GPS:', error);
                    document.getElementById('currentAddress').textContent = 'Position non disponible';
                    document.getElementById('accuracy').innerHTML = 'üî¥ GPS d√©sactiv√©';
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 3000 }
            );
        }

        function stopLocationTracking() {
            if (watchPositionId) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
            }
        }

        async function reverseGeocode(lat, lng) {
            try {
                if (google && google.maps) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            document.getElementById('currentAddress').textContent = results[0].formatted_address;
                        }
                    });
                }
            } catch (error) {
                document.getElementById('currentAddress').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        // ========== ONLINE STATUS ==========
        async function toggleOnlineStatus() {
            if (!currentUser) return;

            isOnline = !isOnline;
            const toggle = document.getElementById('toggleSwitch');
            const statusText = document.getElementById('statusText');
            const driverId = currentUser.firestoreId || currentUser.uid;

            if (isOnline) {
                toggle.classList.add('active');
                statusText.textContent = 'üü¢ EN LIGNE';
                statusText.classList.add('online');
                showToast('‚úÖ Vous √™tes en ligne', 'success');
                startLocationTracking();
                listenForNewCourses();
                
                if (!currentUser.isDemo) {
                    await db.collection('drivers').doc(driverId).update({
                        statut: 'disponible',
                        derniereActivite: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } else {
                toggle.classList.remove('active');
                statusText.textContent = '‚ö´ HORS LIGNE';
                statusText.classList.remove('online');
                showToast('Vous √™tes hors ligne', 'info');
                
                if (!currentUser.isDemo) {
                    await db.collection('drivers').doc(driverId).update({
                        statut: 'hors_ligne'
                    });
                }
            }
        }

        // ========== COURSE MANAGEMENT ==========
        let courseListener = null;

        function listenForNewCourses() {
            if (!currentUser || !isOnline || currentUser.isDemo) return;

            const driverId = currentUser.firestoreId || currentUser.uid;
            console.log('üëÇ √âcoute des courses pour:', driverId);

            courseListener = db.collection('reservations')
                .where('chauffeurAssigne', '==', driverId)
                .where('statut', '==', 'assignee')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const course = { id: change.doc.id, ...change.doc.data() };
                            showCourseNotification(course);
                        }
                    });
                });
        }

        function simulateNewCourse() {
            if (!isOnline) {
                showToast('Vous devez √™tre en ligne', 'error');
                return;
            }

            const driverPos = driverPosition || { lat: 14.7200, lng: -17.4600 };
            
            const testCourse = {
                id: 'TEST_' + Date.now(),
                depart: 'Plateau, Place de l\'Ind√©pendance',
                destination: 'Almadies, Route des Almadies',
                departCoords: { lat: driverPos.lat + 0.01, lng: driverPos.lng + 0.01 },
                destinationCoords: { lat: 14.7286, lng: -17.5295 },
                prixEstime: 4500,
                distance: 15,
                passagers: 2,
                clientNom: 'Aminata Sow',
                clientTelephone: '+221 77 999 88 77',
                clientRating: 4.9
            };
            
            showCourseNotification(testCourse);
        }

        function showCourseNotification(course) {
            try { new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10').play().catch(() => {}); } catch(e) {}
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);

            const notification = document.createElement('div');
            notification.className = 'course-notification';
            notification.innerHTML = `
                <div class="course-modal">
                    <div class="course-timer" id="courseTimer">30<div class="course-timer-label">sec</div></div>
                    <h2 class="course-title">üîî NOUVELLE COURSE!</h2>
                    <div class="course-client">
                        <strong>Client:</strong> ${course.clientNom || 'Client'}<br>
                        ${course.clientRating ? '‚≠ê ' + course.clientRating : ''}
                    </div>
                    <div class="course-route">
                        <div class="route-point"><span class="route-icon">üìç</span><span>${course.depart}</span></div>
                        <div style="text-align: center; margin: 8px 0;">‚Üì</div>
                        <div class="route-point"><span class="route-icon">üéØ</span><span>${course.destination}</span></div>
                    </div>
                    <div class="course-details">
                        <div class="detail-item"><div class="detail-icon">üí∞</div><div>${(course.prixEstime || 0).toLocaleString()} F</div></div>
                        <div class="detail-item"><div class="detail-icon">üìè</div><div>${course.distance || 5} km</div></div>
                        <div class="detail-item"><div class="detail-icon">üë•</div><div>${course.passagers || 1}</div></div>
                    </div>
                    <div class="course-actions">
                        <button class="btn btn-refuse" onclick="refuseCourse('${course.id}')">‚ùå Refuser</button>
                        <button class="btn btn-accept" onclick="acceptCourse('${course.id}', ${JSON.stringify(course).replace(/"/g, '&quot;')})">‚úÖ Accepter</button>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);

            let timeLeft = 30;
            const timerInterval = setInterval(() => {
                timeLeft--;
                const timer = document.getElementById('courseTimer');
                if (timer) timer.innerHTML = `${timeLeft}<div class="course-timer-label">sec</div>`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    refuseCourse(course.id, true);
                }
            }, 1000);
            notification.timerInterval = timerInterval;
        }

        async function acceptCourse(courseId, courseData) {
            const notification = document.querySelector('.course-notification');
            if (notification) {
                clearInterval(notification.timerInterval);
                notification.remove();
            }

            showLoading('Acceptation...');

            if (typeof courseData === 'string') {
                courseData = JSON.parse(courseData.replace(/&quot;/g, '"'));
            }

            currentCourse = { id: courseId, ...courseData, statut: 'acceptee' };

            if (!currentCourse.departCoords) {
                currentCourse.departCoords = await geocodeAddress(currentCourse.depart);
            }
            if (!currentCourse.destinationCoords) {
                currentCourse.destinationCoords = await geocodeAddress(currentCourse.destination);
            }

            const driverId = currentUser.firestoreId || currentUser.uid;

            if (!currentUser.isDemo && !courseId.startsWith('TEST_')) {
                try {
                    const updateData = {
                        statut: 'acceptee',
                        accepteeParChauffeur: true,
                        dateAcceptation: firebase.firestore.FieldValue.serverTimestamp(),
                        nomChauffeur: `${currentUser.prenom || ''} ${currentUser.nom || ''}`.trim(),
                        telephoneChauffeur: currentUser.telephone,
                        chauffeurRating: currentUser.rating || 4.8
                    };

                    if (driverPosition) {
                        updateData.chauffeurPosition = {
                            latitude: driverPosition.lat,
                            longitude: driverPosition.lng,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };
                    }

                    await db.collection('reservations').doc(courseId).update(updateData);
                    await db.collection('drivers').doc(driverId).update({
                        statut: 'en_course',
                        currentBookingId: courseId,
                        reservationEnCours: courseId
                    });
                } catch (error) {
                    console.error('Erreur acceptation:', error);
                }
            }

            hideLoading();
            showToast('‚úÖ Course accept√©e!', 'success');
            
            currentRouteMode = 'approche';
            showScreen('activeCourseScreen');
            displayActiveCourse();
            
            setTimeout(() => initActiveCourseMap(), 300);
        }

        async function geocodeAddress(address) {
            return new Promise((resolve) => {
                if (!google || !google.maps) {
                    resolve({ lat: 14.6937, lng: -17.4441 });
                    return;
                }
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: address + ', Dakar, Senegal' }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve({
                            lat: results[0].geometry.location.lat(),
                            lng: results[0].geometry.location.lng()
                        });
                    } else {
                        resolve({ lat: 14.6937, lng: -17.4441 });
                    }
                });
            });
        }

        function refuseCourse(courseId, auto = false) {
            const notification = document.querySelector('.course-notification');
            if (notification) {
                clearInterval(notification.timerInterval);
                notification.remove();
            }
            showToast(auto ? '‚è±Ô∏è Temps √©coul√©' : 'Course refus√©e', 'info');
        }

        // ========== ACTIVE COURSE MAP ==========
        function initActiveCourseMap() {
            if (!google || !google.maps) return;

            const mapElement = document.getElementById('activeCourseMap');
            if (!mapElement) return;

            const centerPos = driverPosition || currentCourse?.departCoords || { lat: 14.6937, lng: -17.4441 };

            activeCourseMap = new google.maps.Map(mapElement, {
                center: centerPos,
                zoom: 13,
                disableDefaultUI: true,
                zoomControl: true
            });

            directionsRenderer = new google.maps.DirectionsRenderer({
                map: activeCourseMap,
                suppressMarkers: true,
                polylineOptions: { strokeColor: '#2196F3', strokeWeight: 5 }
            });

            if (driverPosition) {
                driverMarker = new google.maps.Marker({
                    map: activeCourseMap,
                    position: driverPosition,
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 8,
                        fillColor: '#2196F3',
                        fillOpacity: 1,
                        strokeColor: '#fff',
                        strokeWeight: 2
                    },
                    zIndex: 100
                });
            }

            if (currentCourse?.departCoords) {
                clientPickupMarker = new google.maps.Marker({
                    map: activeCourseMap,
                    position: currentCourse.departCoords,
                    icon: {
                        url: 'data:image/svg+xml,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><circle cx="20" cy="20" r="18" fill="#4CAF50" stroke="white" stroke-width="3"/><text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-weight="bold">C</text></svg>`),
                        scaledSize: new google.maps.Size(40, 40),
                        anchor: new google.maps.Point(20, 20)
                    }
                });
            }

            if (currentCourse?.destinationCoords) {
                clientDestinationMarker = new google.maps.Marker({
                    map: activeCourseMap,
                    position: currentCourse.destinationCoords,
                    icon: {
                        url: 'data:image/svg+xml,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><circle cx="20" cy="20" r="18" fill="#E30613" stroke="white" stroke-width="3"/><text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-weight="bold">D</text></svg>`),
                        scaledSize: new google.maps.Size(40, 40),
                        anchor: new google.maps.Point(20, 20)
                    }
                });
            }

            setTimeout(() => {
                google.maps.event.trigger(activeCourseMap, 'resize');
                const bounds = new google.maps.LatLngBounds();
                if (driverPosition) bounds.extend(driverPosition);
                if (currentCourse?.departCoords) bounds.extend(currentCourse.departCoords);
                if (currentCourse?.destinationCoords) bounds.extend(currentCourse.destinationCoords);
                if (!bounds.isEmpty()) activeCourseMap.fitBounds(bounds, { padding: 50 });
            }, 200);

            calculateApprocheRoute();
            calculateCourseRoute();
        }

        function calculateApprocheRoute() {
            if (!driverPosition || !currentCourse?.departCoords || !directionsService) return;

            directionsService.route({
                origin: driverPosition,
                destination: currentCourse.departCoords,
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                if (status === 'OK') {
                    approcheRoute = result;
                    const leg = result.routes[0].legs[0];
                    document.getElementById('approcheDistance').textContent = leg.distance.text;
                    document.getElementById('approcheDuration').textContent = leg.duration.text;
                    const eta = new Date(Date.now() + leg.duration.value * 1000);
                    document.getElementById('approcheETA').textContent = eta.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    if (currentRouteMode === 'approche' && directionsRenderer) directionsRenderer.setDirections(result);
                }
            });
        }

        function calculateCourseRoute() {
            if (!currentCourse?.departCoords || !currentCourse?.destinationCoords || !directionsService) return;

            directionsService.route({
                origin: currentCourse.departCoords,
                destination: currentCourse.destinationCoords,
                travelMode: google.maps.TravelMode.DRIVING
            }, (result, status) => {
                if (status === 'OK') {
                    courseRoute = result;
                    const leg = result.routes[0].legs[0];
                    document.getElementById('courseDistance').textContent = leg.distance.text;
                    document.getElementById('courseDuration').textContent = leg.duration.text;
                    document.getElementById('coursePrice').textContent = (currentCourse.prixEstime || 0).toLocaleString() + ' F';
                    if (currentRouteMode === 'course' && directionsRenderer) directionsRenderer.setDirections(result);
                }
            });
        }

        function updateApprocheRoute() {
            if (currentRouteMode === 'approche' && driverPosition && driverMarker) {
                driverMarker.setPosition(driverPosition);
                calculateApprocheRoute();
            }
        }

        function showRouteTab(mode) {
            if (mode === 'course' && currentCourse?.statut !== 'en_cours') {
                showToast('‚ö†Ô∏è D√©marrez d\'abord la course', 'info');
                return;
            }

            currentRouteMode = mode;
            document.getElementById('tabApproche').classList.toggle('active', mode === 'approche');
            document.getElementById('tabCourse').classList.toggle('active', mode === 'course');
            document.getElementById('routeInfoApproche').style.display = mode === 'approche' ? 'block' : 'none';
            document.getElementById('routeInfoCourse').style.display = mode === 'course' ? 'block' : 'none';

            if (directionsRenderer) {
                if (mode === 'approche' && approcheRoute) {
                    directionsRenderer.setDirections(approcheRoute);
                    directionsRenderer.setOptions({ polylineOptions: { strokeColor: '#2196F3', strokeWeight: 5 } });
                } else if (mode === 'course' && courseRoute) {
                    directionsRenderer.setDirections(courseRoute);
                    directionsRenderer.setOptions({ polylineOptions: { strokeColor: '#00A854', strokeWeight: 5 } });
                }
            }
        }

        function displayActiveCourse() {
            if (!currentCourse) return;

            document.getElementById('clientName').textContent = currentCourse.clientNom || 'Client';
            document.getElementById('clientPhone').textContent = currentCourse.clientTelephone || '-';
            document.getElementById('clientRating').textContent = currentCourse.clientRating ? `‚≠ê ${currentCourse.clientRating}` : '-';
            document.getElementById('activeDeparture').textContent = currentCourse.depart;
            document.getElementById('activeDestination').textContent = currentCourse.destination;
            document.getElementById('activePrice').textContent = `${(currentCourse.prixEstime || 0).toLocaleString()} FCFA`;

            updateCourseStatusDisplay();
        }

        async function updateCourseStatus(newStatus) {
            if (!currentCourse) return;

            showLoading('Mise √† jour...');
            currentCourse.statut = newStatus;
            const driverId = currentUser.firestoreId || currentUser.uid;

            if (!currentUser.isDemo && !currentCourse.id.startsWith('TEST_')) {
                try {
                    const updateData = { statut: newStatus, derniereModification: firebase.firestore.FieldValue.serverTimestamp() };
                    if (driverPosition) {
                        updateData.chauffeurPosition = { latitude: driverPosition.lat, longitude: driverPosition.lng, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
                    }
                    await db.collection('reservations').doc(currentCourse.id).update(updateData);
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            hideLoading();
            updateCourseStatusDisplay();
            showToast(newStatus === 'arrive' ? '‚úÖ Vous √™tes arriv√©' : 'üöó Course d√©marr√©e!', 'success');
        }

        function updateCourseStatusDisplay() {
            const status = currentCourse?.statut || 'acceptee';
            const statusBadge = document.getElementById('courseStatus');
            const statusTitle = document.getElementById('courseStatusTitle');
            const btnArrive = document.getElementById('btnArrive');
            const btnStart = document.getElementById('btnStart');
            const btnComplete = document.getElementById('btnComplete');
            const btnNavigation = document.getElementById('btnNavigation');
            const tabCourse = document.getElementById('tabCourse');

            switch(status) {
                case 'acceptee':
                case 'en_route':
                    statusBadge.className = 'status-badge approche';
                    statusBadge.textContent = 'üöó En route vers client';
                    statusTitle.textContent = 'Direction: ' + currentCourse.depart;
                    btnArrive.style.display = 'block';
                    btnStart.style.display = 'none';
                    btnComplete.disabled = true;
                    btnNavigation.innerHTML = '<i class="fas fa-map-marked-alt"></i> GPS Client';
                    btnNavigation.onclick = () => openGoogleMapsToClient();
                    tabCourse.classList.add('disabled');
                    break;
                case 'arrive':
                    statusBadge.className = 'status-badge arrive';
                    statusBadge.textContent = 'üìç Arriv√© - En attente client';
                    statusTitle.textContent = 'Le client arrive...';
                    btnArrive.style.display = 'none';
                    btnStart.style.display = 'block';
                    btnComplete.disabled = true;
                    tabCourse.classList.add('disabled');
                    break;
                case 'en_cours':
                    statusBadge.className = 'status-badge en-cours';
                    statusBadge.textContent = 'üöó Course en cours';
                    statusTitle.textContent = 'Direction: ' + currentCourse.destination;
                    btnArrive.style.display = 'none';
                    btnStart.style.display = 'none';
                    btnComplete.disabled = false;
                    btnNavigation.innerHTML = '<i class="fas fa-map-marked-alt"></i> GPS Destination';
                    btnNavigation.onclick = () => openGoogleMapsToDestination();
                    tabCourse.classList.remove('disabled');
                    currentRouteMode = 'course';
                    showRouteTab('course');
                    break;
            }
        }

        function openGoogleMapsToClient() {
            if (!currentCourse?.departCoords) return showToast('Coordonn√©es non disponibles', 'error');
            const { lat, lng } = currentCourse.departCoords;
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`, '_blank');
        }

        function openGoogleMapsToDestination() {
            if (!currentCourse?.destinationCoords) return showToast('Coordonn√©es non disponibles', 'error');
            const { lat, lng } = currentCourse.destinationCoords;
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`, '_blank');
        }

        function callClient() {
            if (!currentCourse?.clientTelephone) return showToast('Num√©ro non disponible', 'error');
            window.location.href = `tel:${currentCourse.clientTelephone}`;
        }

        async function completeCourse() {
            if (!currentCourse || currentCourse.statut !== 'en_cours') return showToast('‚ö†Ô∏è D√©marrez d\'abord la course', 'error');
            if (!confirm('Confirmer la fin de la course?')) return;

            showLoading('Finalisation...');
            const driverId = currentUser.firestoreId || currentUser.uid;

            if (!currentUser.isDemo && !currentCourse.id.startsWith('TEST_')) {
                try {
                    await db.collection('reservations').doc(currentCourse.id).update({
                        statut: 'terminee',
                        dateFin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection('drivers').doc(driverId).update({
                        statut: 'disponible',
                        currentBookingId: null,
                        reservationEnCours: null,
                        coursesCompletees: firebase.firestore.FieldValue.increment(1),
                        revenusTotal: firebase.firestore.FieldValue.increment(currentCourse.prixEstime || 0)
                    });
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            currentCourse = null;
            hideLoading();
            showToast('‚úÖ Course termin√©e!', 'success');
            showScreen('dashboardScreen');
            loadDashboardData();
        }

        async function cancelCourse() {
            if (!confirm('Annuler cette course?')) return;

            showLoading('Annulation...');
            const driverId = currentUser.firestoreId || currentUser.uid;

            if (!currentUser.isDemo && currentCourse && !currentCourse.id.startsWith('TEST_')) {
                try {
                    await db.collection('reservations').doc(currentCourse.id).update({
                        statut: 'annulee',
                        annuleePar: 'chauffeur',
                        dateAnnulation: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection('drivers').doc(driverId).update({
                        statut: 'disponible',
                        currentBookingId: null,
                        reservationEnCours: null
                    });
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            currentCourse = null;
            hideLoading();
            showToast('Course annul√©e', 'info');
            showScreen('dashboardScreen');
        }

        // ========== DASHBOARD ==========
        async function loadDashboardData() {
            if (!currentUser || currentUser.isDemo) return loadDashboardDataDemo();

            try {
                const driverId = currentUser.firestoreId || currentUser.uid;
                const driverDoc = await db.collection('drivers').doc(driverId).get();
                const data = driverDoc.data();

                // R√©cup√©rer la photo de profil (depuis drivers OU candidatures)
                const photoUrl = await fetchDriverPhoto({ ...data, id: driverId });
                displayProfilePhoto(photoUrl);

                document.getElementById('profileName').textContent = `${data.prenom || ''} ${data.nom || ''}`;
                document.getElementById('profilePhone').textContent = data.telephone || '';
                document.getElementById('profileFirestoreId').textContent = driverId;
                document.getElementById('profileVehicle').textContent = data.vehicule?.modele || data.typeVehicule || '-';
                document.getElementById('rating').textContent = (data.rating || 4.8).toFixed(1);
                document.getElementById('profileRating').textContent = (data.rating || 4.8).toFixed(1);
                document.getElementById('coursesTotal').textContent = data.coursesCompletees || 0;
                document.getElementById('profileTotalCourses').textContent = data.coursesCompletees || 0;
                document.getElementById('profileRevenuTotal').textContent = (data.revenusTotal || 0).toLocaleString() + ' FCFA';
                document.getElementById('coursesJour').textContent = Math.floor(Math.random() * 5) + 2;
                document.getElementById('revenusJour').textContent = ((Math.floor(Math.random() * 5) + 2) * 3500).toLocaleString();

                loadHistory();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function loadDashboardDataDemo() {
            displayProfilePhoto(currentUser.photoIdentite);
            
            document.getElementById('profileName').textContent = `${currentUser.prenom} ${currentUser.nom}`;
            document.getElementById('profilePhone').textContent = currentUser.telephone;
            document.getElementById('profileFirestoreId').textContent = currentUser.firestoreId;
            document.getElementById('profileVehicle').textContent = 'Toyota Corolla (Demo)';
            document.getElementById('rating').textContent = currentUser.rating.toFixed(1);
            document.getElementById('profileRating').textContent = currentUser.rating.toFixed(1);
            document.getElementById('coursesTotal').textContent = currentUser.coursesCompletees;
            document.getElementById('profileTotalCourses').textContent = currentUser.coursesCompletees;
            document.getElementById('profileRevenuTotal').textContent = currentUser.revenusTotal.toLocaleString() + ' FCFA';
            document.getElementById('coursesJour').textContent = 5;
            document.getElementById('revenusJour').textContent = '17500';
            loadHistoryDemo();
        }

        // ========== HISTORIQUE ==========
        async function loadHistory() {
            if (!currentUser || currentUser.isDemo) {
                loadHistoryDemo();
                showToast('‚úÖ Historique rafra√Æchi', 'success');
                return;
            }

            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div class="loading-spinner" style="margin: 0 auto 15px; border-color: #ddd; border-top-color: #00A854; width: 40px; height: 40px;"></div>Chargement...</div>';

            try {
                const driverId = currentUser.firestoreId || currentUser.uid;
                console.log('üìú Chargement historique pour:', driverId);
                
                const snapshot = await db.collection('reservations')
                    .where('chauffeurAssigne', '==', driverId)
                    .where('statut', 'in', ['terminee', 'annulee'])
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                console.log('üìú R√©servations trouv√©es:', snapshot.size);

                if (snapshot.empty) {
                    historyList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 3em; margin-bottom: 15px;">üì≠</div>
                            <p>Aucune course dans l'historique</p>
                            <p style="font-size: 0.85em; margin-top: 10px;">Vos courses termin√©es appara√Ætront ici</p>
                        </div>
                    `;
                    showToast('Aucune course trouv√©e', 'info');
                    return;
                }

                const courses = [];
                snapshot.forEach(doc => {
                    courses.push({ id: doc.id, ...doc.data() });
                });

                historyList.innerHTML = courses.map(c => {
                    let date;
                    if (c.timestamp?.toDate) {
                        date = c.timestamp.toDate();
                    } else if (c.timestamp?.seconds) {
                        date = new Date(c.timestamp.seconds * 1000);
                    } else if (c.dateCreation?.toDate) {
                        date = c.dateCreation.toDate();
                    } else {
                        date = new Date();
                    }
                    
                    const isTerminee = c.statut === 'terminee';
                    const statut = isTerminee ? '‚úÖ Termin√©e' : '‚ùå Annul√©e';
                    const statutStyle = isTerminee ? 'background: #00A854;' : 'background: #E30613;';
                    
                    return `
                        <div class="history-item">
                            <div class="history-header">
                                <span class="history-date">${date.toLocaleDateString('fr-FR')} ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                                <span class="history-price">${(c.prixEstime || c.prix || 0).toLocaleString()} FCFA</span>
                            </div>
                            <div class="history-route">üìç ${c.depart || 'D√©part'} ‚Üí üéØ ${c.destination || 'Destination'}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                <span class="history-status" style="${statutStyle}">${statut}</span>
                                <span style="color: #666; font-size: 0.8em;">üë§ ${c.clientNom || c.nomClient || 'Client'}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                showToast(`‚úÖ ${courses.length} course(s) charg√©e(s)`, 'success');

            } catch (error) {
                console.error('Erreur chargement historique:', error);
                
                if (error.code === 'failed-precondition' || error.message.includes('index')) {
                    historyList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #856404; background: #fff3cd; border-radius: 10px; margin: 15px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚öôÔ∏è</div>
                            <p><strong>Index Firestore requis</strong></p>
                            <p style="font-size: 0.85em; margin-top: 10px;">Cr√©ez l'index : chauffeurAssigne + statut + timestamp (desc)</p>
                            <p style="font-size: 0.75em; margin-top: 10px; color: #666;">Firebase Console ‚Üí Firestore ‚Üí Indexes ‚Üí Create Index</p>
                        </div>
                    `;
                    showToast('Index Firestore requis', 'error');
                } else {
                    historyList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #721c24; background: #f8d7da; border-radius: 10px; margin: 15px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                            <p><strong>Erreur de chargement</strong></p>
                            <p style="font-size: 0.85em; margin-top: 10px;">${error.message}</p>
                            <button onclick="loadHistory()" style="margin-top: 15px; padding: 10px 20px; background: #00A854; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                üîÑ R√©essayer
                            </button>
                        </div>
                    `;
                    showToast('Erreur de chargement', 'error');
                }
            }
        }

        function loadHistoryDemo() {
            const historyList = document.getElementById('historyList');
            const courses = [
                { date: new Date(), depart: 'Plateau', dest: 'Almadies', prix: 4500 },
                { date: new Date(Date.now() - 3600000), depart: 'Sacr√©-C≈ìur', dest: 'Yoff', prix: 3200 },
                { date: new Date(Date.now() - 86400000), depart: 'M√©dina', dest: 'Ngor', prix: 2800 }
            ];
            historyList.innerHTML = courses.map(c => `
                <div class="history-item">
                    <div class="history-header">
                        <span class="history-date">${c.date.toLocaleDateString('fr-FR')} ${c.date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                        <span class="history-price">${c.prix.toLocaleString()} FCFA</span>
                    </div>
                    <div class="history-route">üìç ${c.depart} ‚Üí üéØ ${c.dest}</div>
                    <span class="history-status">‚úÖ Termin√©e</span>
                </div>
            `).join('');
        }

        // ========== NAVIGATION ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            const navIndex = { 'dashboardScreen': 0, 'activeCourseScreen': 1, 'historyScreen': 2, 'profileScreen': 3 };
            if (navIndex[screenId] !== undefined) {
                document.querySelectorAll('.nav-item')[navIndex[screenId]].classList.add('active');
            }

            if (screenId === 'activeCourseScreen' && currentCourse) setTimeout(() => initActiveCourseMap(), 100);
            if (screenId === 'dashboardScreen' && map) {
                setTimeout(() => {
                    google.maps.event.trigger(map, 'resize');
                    if (driverPosition) map.setCenter(driverPosition);
                }, 100);
            }
            if (screenId === 'historyScreen') loadHistory();
        }

        // ========== UI ==========
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoading(text = 'Chargement...') {
            const loading = document.createElement('div');
            loading.className = 'loading-overlay';
            loading.id = 'loadingOverlay';
            loading.innerHTML = `<div class="loading-spinner"></div><div class="loading-text">${text}</div>`;
            document.body.appendChild(loading);
        }

        function hideLoading() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) loading.remove();
        }

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöï Al Bourakh Driver Pro v4.8 LOGO - Ready');
            document.getElementById('loginPhone').value = '+221 77 712 34 56';
            document.getElementById('loginPassword').value = 'Admin2025';
        });
    </script>
</body>
</html>
