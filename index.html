<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00A854">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Al Bourakh">
    <link rel="apple-touch-icon" href="https://i.imgur.com/VtgG6pR.png">
    <title>Al Bourakh Driver v6.0 - Recharge & Retrait</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; }
        .mobile-container { max-width: 414px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .app-header { background: linear-gradient(135deg, #00A854, #FECB00); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .app-header h1 { font-size: 1.2em; display: flex; align-items: center; gap: 10px; }
        .app-header h1 img { width: 24px; height: 24px; object-fit: contain; }
        .app-header button { background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        
        .tracking-badge { position: fixed; top: 70px; right: 20px; background: linear-gradient(135deg, #00A854, #FECB00); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.75em; font-weight: bold; z-index: 1000; display: none; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,168,84,0.3); animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .tracking-indicator { width: 8px; height: 8px; background: #fff; border-radius: 50%; animation: blink 1s ease-in-out infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .login-screen { padding: 40px 30px; text-align: center; }
        .login-logo { width: 100px; height: 100px; margin: 0 auto 20px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5em; box-shadow: 0 8px 20px rgba(0,168,84,0.3); overflow: hidden; }
        .login-logo img { width: 70%; height: 70%; object-fit: contain; }
        .login-title { font-size: 1.8em; color: #00A854; margin-bottom: 10px; }
        .login-subtitle { color: #666; margin-bottom: 30px; }
        
        .input-group { margin-bottom: 15px; text-align: left; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; }
        .input-group input, .input-group select { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; transition: border-color 0.3s; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #00A854; }
        .input-group input.valid { border-color: #00A854; background: #f0fdf4; }
        .input-group input.invalid { border-color: #E30613; background: #fef2f2; }
        .input-helper { font-size: 0.75em; color: #666; margin-top: 5px; }
        .input-helper.error { color: #E30613; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-top: 10px; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 8px 25px rgba(0,168,84,0.3); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #E30613; color: white; }
        
        .dashboard-content { padding: 15px; padding-bottom: 100px; }
        
        .header-profile-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid white; cursor: pointer; }
        .header-profile-placeholder { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.2em; border: 2px solid white; cursor: pointer; }
        
        .status-toggle { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .status-text { font-size: 1.1em; font-weight: bold; color: #999; }
        .status-text.online { color: #00A854; }
        .toggle-switch { position: relative; width: 60px; height: 34px; background: #ccc; border-radius: 34px; cursor: pointer; }
        .toggle-switch.active { background: #00A854; }
        .toggle-switch::after { content: ''; position: absolute; width: 26px; height: 26px; background: white; border-radius: 50%; top: 4px; left: 4px; transition: all 0.3s; }
        .toggle-switch.active::after { left: 30px; }
        
        .map-container { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .map-container h3 { margin-bottom: 10px; color: #333; font-size: 1em; }
        #map { width: 100%; height: 250px; border-radius: 10px; background: #e0e0e0; }
        #activeCourseMap { width: 100%; height: 280px; border-radius: 10px; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); min-height: 280px; }
        .location-info { background: #f5f5f5; padding: 12px; border-radius: 10px; margin-top: 10px; font-size: 0.9em; }
        .location-info div { margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        .stat-icon { font-size: 2em; margin-bottom: 8px; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #00A854; }
        .stat-label { color: #666; font-size: 0.85em; }
        
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; cursor: pointer; border: none; font-size: 0.9em; transition: all 0.3s; }
        .action-btn:hover { transform: translateY(-3px); }
        .action-btn-icon { font-size: 1.8em; margin-bottom: 8px; }
        
        /* WALLET STYLES AM√âLIOR√âS */
        .wallet-content { padding: 15px; padding-bottom: 100px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .wallet-balance-card { background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; }
        .wallet-label { font-size: 0.9em; color: rgba(255,255,255,0.8); margin-bottom: 8px; }
        .wallet-amount { font-size: 2.5em; font-weight: bold; margin: 0 0 20px 0; }
        
        .wallet-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .wallet-action-btn { padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.95em; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; }
        .wallet-action-btn.recharge { background: #10b981; color: white; }
        .wallet-action-btn.withdraw { background: white; color: #7c3aed; }
        .wallet-action-btn:hover { transform: scale(1.02); }
        
        .pending-transactions { background: #fff7ed; border: 2px solid #f97316; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .pending-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .pending-icon { font-size: 1.5em; }
        .pending-title { font-weight: bold; color: #c2410c; }
        .pending-count { background: #f97316; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
        .pending-list { max-height: 200px; overflow-y: auto; }
        .pending-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .pending-item-info { flex: 1; }
        .pending-item-type { font-weight: 600; font-size: 0.9em; }
        .pending-item-date { font-size: 0.75em; color: #666; }
        .pending-item-amount { font-weight: bold; }
        .pending-item-amount.credit { color: #10b981; }
        .pending-item-amount.debit { color: #ef4444; }
        .pending-status { font-size: 0.75em; padding: 4px 8px; border-radius: 20px; background: #fef3c7; color: #92400e; }
        
        .driver-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .driver-stat { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .driver-stat-label { font-size: 0.75em; color: #666; margin-bottom: 5px; }
        .driver-stat-value { font-size: 1.3em; font-weight: bold; color: #00A854; }
        .driver-stat-unit { font-size: 0.7em; color: #999; margin-top: 2px; }
        
        .section-header { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .section-header h3 { font-size: 1em; color: #333; }
        
        .transaction-list { max-height: 400px; overflow-y: auto; }
        .transaction-item { padding: 15px; border-bottom: 1px solid #f0f0f0; }
        .transaction-header { display: flex; align-items: center; margin-bottom: 10px; }
        .transaction-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1.2em; }
        .transaction-icon.recharge { background: #d1fae5; color: #059669; }
        .transaction-icon.withdrawal { background: #fee2e2; color: #dc2626; }
        .transaction-icon.course { background: #dbeafe; color: #2563eb; }
        .transaction-route { font-weight: 600; color: #333; margin-bottom: 4px; }
        .transaction-date { color: #666; font-size: 0.8em; }
        .transaction-amount { font-weight: bold; font-size: 1.1em; }
        .transaction-amount.positive { color: #10b981; }
        .transaction-amount.negative { color: #ef4444; }
        .transaction-status { font-size: 0.75em; padding: 4px 10px; border-radius: 20px; margin-left: 10px; }
        .transaction-status.pending { background: #fef3c7; color: #92400e; }
        .transaction-status.validated { background: #d1fae5; color: #065f46; }
        .transaction-status.completed { background: #d1fae5; color: #065f46; }
        .transaction-status.rejected { background: #fee2e2; color: #991b1b; }
        
        /* RECHARGE SCREEN */
        .recharge-content { padding: 15px; padding-bottom: 100px; }
        .albourakh-account { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; }
        .albourakh-account h3 { font-size: 1em; margin-bottom: 10px; opacity: 0.9; }
        .albourakh-number { font-size: 1.8em; font-weight: bold; letter-spacing: 2px; margin-bottom: 10px; }
        .albourakh-copy-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; }
        
        .recharge-instructions { background: #ecfdf5; border: 2px solid #10b981; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .recharge-instructions h4 { color: #065f46; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .recharge-instructions ol { margin-left: 20px; color: #047857; font-size: 0.9em; }
        .recharge-instructions li { margin-bottom: 8px; line-height: 1.5; }
        
        .amount-presets { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .preset-btn { padding: 12px; border: 2px solid #e5e7eb; background: white; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .preset-btn:hover, .preset-btn.active { border-color: #10b981; background: #ecfdf5; color: #065f46; }
        
        .payment-methods { margin-bottom: 20px; }
        .payment-method { width: 100%; padding: 15px; border: 2px solid #e5e7eb; background: white; border-radius: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: all 0.3s; }
        .payment-method:hover, .payment-method.active { border-color: #10b981; background: #ecfdf5; }
        .payment-method-icon { font-size: 1.5em; }
        .payment-method-name { flex: 1; font-weight: 600; }
        .payment-method-check { color: #10b981; display: none; }
        .payment-method.active .payment-method-check { display: block; }
        
        /* WITHDRAWAL SCREEN */
        .withdrawal-content { padding: 15px; padding-bottom: 100px; }
        .withdrawal-balance { background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .withdrawal-balance-label { font-size: 0.9em; opacity: 0.9; margin-bottom: 8px; }
        .withdrawal-balance-amount { font-size: 2em; font-weight: bold; }
        
        .amount-input-container { position: relative; margin-bottom: 15px; }
        .amount-input { width: 100%; padding: 15px 80px 15px 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1.5em; font-weight: bold; text-align: right; }
        .amount-input:focus { outline: none; border-color: #7c3aed; }
        .amount-currency { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-weight: bold; color: #666; }
        
        .quick-amounts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .quick-amount-btn { padding: 10px; border: 2px solid #7c3aed; background: white; color: #7c3aed; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .quick-amount-btn:hover { background: #7c3aed; color: white; }
        
        .withdrawal-info { background: #fef3c7; border: 2px solid #f59e0b; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .withdrawal-info h4 { color: #92400e; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .withdrawal-info p { color: #78350f; font-size: 0.9em; line-height: 1.5; }
        
        .error-box { background: #fee2e2; border: 1px solid #fca5a5; padding: 12px; border-radius: 8px; display: flex; gap: 10px; align-items: center; margin-top: 10px; }
        .error-box.hidden { display: none; }
        .error-icon { color: #dc2626; }
        .error-text { color: #dc2626; font-size: 0.9em; }
        
        /* COURSE SCREENS */
        .course-notification { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; animation: pulseBackground 1s ease-in-out infinite; }
        @keyframes pulseBackground { 0%, 100% { background: rgba(0,0,0,0.9); } 50% { background: rgba(0,0,0,0.95); } }
        .course-modal { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 25px; max-height: 90vh; overflow-y: auto; animation: slideInDown 0.3s ease-out; }
        @keyframes slideInDown { from { transform: translateY(-100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .course-timer { background: linear-gradient(135deg, #E30613, #FF6B00); color: white; width: 70px; height: 70px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 1.8em; font-weight: bold; animation: pulse 1s ease-in-out infinite; }
        .course-timer-label { font-size: 0.35em; }
        .course-title { text-align: center; font-size: 1.3em; color: #00A854; margin-bottom: 15px; }
        .course-client, .course-route { background: #f5f5f5; padding: 12px; border-radius: 10px; margin-bottom: 10px; }
        .route-point { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .route-icon { font-size: 1.3em; }
        .course-details { display: flex; justify-content: space-around; margin: 15px 0; padding: 12px; background: #f5f5f5; border-radius: 10px; }
        .detail-item { text-align: center; }
        .detail-icon { font-size: 1.3em; margin-bottom: 5px; }
        .course-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-refuse { background: #E30613; color: white; }
        .btn-accept { background: #00A854; color: white; }
        
        .active-course-container { padding: 15px; padding-bottom: 100px; }
        .course-status-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .status-badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-weight: bold; font-size: 0.9em; margin-bottom: 10px; }
        .status-badge.approche { background: #fff3cd; color: #856404; }
        .status-badge.arrive { background: #fff3cd; color: #856404; }
        .status-badge.en-cours { background: #cce5ff; color: #004085; }
        
        .route-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .route-tab { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 600; font-size: 0.85em; background: white; }
        .route-tab.active { border-color: #00A854; background: #e8f5e9; color: #00A854; }
        .route-tab.disabled { opacity: 0.5; cursor: not-allowed; }
        .route-tab i { display: block; font-size: 1.5em; margin-bottom: 5px; }
        
        .route-info-box { background: linear-gradient(135deg, #00A854, #FECB00); padding: 15px; border-radius: 12px; color: white; margin-bottom: 15px; }
        .route-info-box.approche { background: linear-gradient(135deg, #2196F3, #00BCD4); }
        .route-info-title { font-size: 0.9em; opacity: 0.9; margin-bottom: 8px; }
        .route-info-details { display: flex; justify-content: space-around; text-align: center; }
        .route-info-item { flex: 1; }
        .route-info-value { font-size: 1.4em; font-weight: bold; }
        .route-info-label { font-size: 0.75em; opacity: 0.9; }
        
        .client-info-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .client-info-card h3 { margin-bottom: 12px; color: #333; font-size: 1em; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; }
        .info-row:last-child { border-bottom: none; }
        
        .navigation-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .nav-btn { padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.9em; }
        .nav-btn.primary { background: #00A854; color: white; }
        .nav-btn.secondary { background: #2196F3; color: white; }
        .nav-btn.warning { background: #FF9800; color: white; }
        .nav-btn.danger { background: #E30613; color: white; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 10px 0; max-width: 414px; margin: 0 auto; z-index: 1000; }
        .nav-item { text-align: center; cursor: pointer; padding: 8px; flex: 1; position: relative; }
        .nav-item.active { color: #00A854; }
        .nav-icon { font-size: 1.3em; margin-bottom: 4px; }
        .nav-label { font-size: 0.75em; }
        .nav-badge { position: absolute; top: 5px; right: 25%; background: #E30613; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7em; font-weight: bold; display: flex; align-items: center; justify-content: center; animation: badgePulse 1s ease-in-out infinite; box-shadow: 0 2px 8px rgba(227, 6, 19, 0.5); }
        @keyframes badgePulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        
        .toast { position: fixed; top: 20px; right: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); z-index: 9999; max-width: 300px; animation: slideInRight 0.3s; }
        @keyframes slideInRight { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .toast.success { border-left: 4px solid #00A854; }
        .toast.error { border-left: 4px solid #E30613; }
        .toast.info { border-left: 4px solid #2196F3; }
        .toast.warning { border-left: 4px solid #FF9800; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: #FECB00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 1.1em; margin-top: 15px; }
        
        .history-list { padding: 15px; padding-bottom: 100px; }
        .history-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .history-date { color: #666; font-size: 0.85em; }
        .history-price { font-weight: bold; color: #00A854; }
        .history-route { color: #333; margin-bottom: 5px; font-size: 0.9em; }
        .history-status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; background: #00A854; color: white; }
        
        .profile-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 25px 20px; text-align: center; color: white; position: relative; }
        .profile-avatar { width: 100px; height: 100px; background: white; border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 2.5em; color: #00A854; overflow: hidden; border: 4px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 1.3em; font-weight: bold; margin-bottom: 5px; }
        .profile-info { padding: 15px; padding-bottom: 100px; }
        .info-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .info-label { color: #666; }
        .info-value { font-weight: bold; color: #333; }
        
        .stats-section { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stats-section h3 { color: #333; font-size: 1em; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .stats-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .stats-row:last-child { border-bottom: none; }
        .stats-row-label { color: #666; font-size: 0.9em; }
        .stats-row-value { font-weight: bold; font-size: 1.1em; }
        .stats-row-value.good { color: #00A854; }
        .stats-row-value.warning { color: #FF9800; }
        .stats-row-value.bad { color: #E30613; }
        .acceptance-rate { width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .acceptance-bar { height: 100%; background: linear-gradient(90deg, #E30613, #FF9800, #00A854); transition: width 0.3s ease; }
        
        .version-badge { display: inline-block; background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 4px; font-size: 0.65em; font-weight: bold; margin-left: 5px; }
        
        @media (max-width: 414px) { .mobile-container, .bottom-nav { max-width: 100%; } }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="tracking-badge" id="trackingBadge">
            <div class="tracking-indicator"></div>
            <span id="trackingStatus">GPS Actif</span>
        </div>

        <!-- LOGIN SCREEN -->
        <div id="loginScreen" class="screen active">
            <div class="login-screen">
                <div class="login-logo">
                    <img src="https://i.imgur.com/VtgG6pR.png" alt="Al Bourakh Logo">
                </div>
                <h1 class="login-title">Al Bourakh Driver <span class="version-badge">v6.0</span></h1>
                <p class="login-subtitle">Recharge & Retrait avec Validation</p>
                
                <div class="input-group">
                    <label>üì± T√©l√©phone</label>
                    <input type="tel" id="loginPhone" placeholder="+221 77 123 45 67" oninput="formatPhoneInput(this)">
                    <div class="input-helper" id="phoneHelper">Formats: 77/78/76/70 XXX XX XX</div>
                </div>
                <div class="input-group">
                    <label>üîí Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="Mot de passe">
                </div>
                
                <button class="btn btn-primary" onclick="handleLogin()">Se connecter</button>
                
                <div style="background: #e8f5e9; padding: 12px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #4CAF50; font-size: 0.85em;">
                    <p><strong>üîê Connexion:</strong> Num√©ro + <code>Admin2025</code></p>
                    <p><strong>üß™ D√©mo:</strong> Tout num√©ro + <code>demo123</code></p>
                </div>
                
                <div style="background: #cce5ff; padding: 12px; border-radius: 10px; margin-top: 10px; border-left: 4px solid #2196F3; font-size: 0.8em;">
                    <p><strong>üÜï v6.0 NOUVEAUT√âS:</strong></p>
                    <p>‚Ä¢ üí≥ Demande de recharge portefeuille</p>
                    <p>‚Ä¢ üí∏ Demande de retrait avec validation</p>
                    <p>‚Ä¢ üìä Historique des transactions</p>
                    <p>‚Ä¢ ‚è≥ Suivi statut en temps r√©el</p>
                </div>
            </div>
        </div>

        <!-- DASHBOARD SCREEN -->
        <div id="dashboardScreen" class="screen">
            <div class="app-header">
                <h1><img src="https://i.imgur.com/VtgG6pR.png" alt="Logo"> Dashboard</h1>
                <div id="headerProfilePhoto" onclick="showScreen('profileScreen')"></div>
            </div>
            
            <div class="dashboard-content">
                <div class="status-toggle">
                    <div>
                        <h3 style="font-size: 0.95em; margin-bottom: 5px;">Statut</h3>
                        <div class="status-text" id="statusText">‚ö´ HORS LIGNE</div>
                    </div>
                    <div class="toggle-switch" id="toggleSwitch" onclick="toggleOnlineStatus()"></div>
                </div>
                
                <div class="map-container">
                    <h3>üìç Ma Position</h3>
                    <div id="map"></div>
                    <div class="location-info" id="locationInfo">
                        <div><i class="fas fa-map-marker-alt"></i> <span id="currentAddress">En attente...</span></div>
                        <div><i class="fas fa-crosshairs"></i> <span id="accuracy">Pr√©cision: -- m</span></div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üöó</div>
                        <div class="stat-value" id="coursesJour">0</div>
                        <div class="stat-label">Courses Aujourd'hui</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="revenusJour">0</div>
                        <div class="stat-label">FCFA Aujourd'hui</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="rating">4.8</div>
                        <div class="stat-label">Note</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="coursesTotal">0</div>
                        <div class="stat-label">Total Courses</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn" onclick="showScreen('walletScreen')">
                        <div class="action-btn-icon">üí≥</div>
                        <div>Portefeuille</div>
                    </button>
                    <button class="action-btn" onclick="showScreen('historyScreen')">
                        <div class="action-btn-icon">üìä</div>
                        <div>Historique</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- WALLET SCREEN -->
        <div id="walletScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-wallet"></i> Portefeuille</h1>
                <button onclick="loadWalletData()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="wallet-content" id="walletDashboard"></div>
        </div>

        <!-- RECHARGE SCREEN -->
        <div id="rechargeScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('walletScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-plus-circle"></i> Recharger</h1>
                <div style="width: 40px;"></div>
            </div>
            <div class="recharge-content" id="rechargeContent"></div>
        </div>

        <!-- WITHDRAWAL SCREEN -->
        <div id="withdrawalScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('walletScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-money-bill-wave"></i> Retrait</h1>
                <div style="width: 40px;"></div>
            </div>
            <div class="withdrawal-content" id="withdrawalContent"></div>
        </div>

        <!-- TRANSACTIONS HISTORY SCREEN -->
        <div id="transactionsScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('walletScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-list"></i> Transactions</h1>
                <button onclick="loadAllTransactions()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="wallet-content" id="transactionsContent"></div>
        </div>

        <!-- ACTIVE COURSE SCREEN -->
        <div id="activeCourseScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-route"></i> Course Active</h1>
                <button onclick="callClient()"><i class="fas fa-phone"></i></button>
            </div>
            
            <div class="active-course-container">
                <div class="route-tabs">
                    <div class="route-tab active" id="tabApproche" onclick="showRouteTab('approche')">
                        <i class="fas fa-car-side"></i>Vers Client
                    </div>
                    <div class="route-tab disabled" id="tabCourse" onclick="showRouteTab('course')">
                        <i class="fas fa-route"></i>Course
                    </div>
                </div>
                
                <div class="map-container" style="margin-bottom: 15px;">
                    <div id="activeCourseMap"></div>
                </div>
                
                <div class="route-info-box approche" id="routeInfoApproche">
                    <div class="route-info-title">üöó TRAJET VERS LE CLIENT</div>
                    <div class="route-info-details">
                        <div class="route-info-item"><div class="route-info-value" id="approcheDistance">--</div><div class="route-info-label">Distance</div></div>
                        <div class="route-info-item"><div class="route-info-value" id="approcheDuration">--</div><div class="route-info-label">Dur√©e</div></div>
                        <div class="route-info-item"><div class="route-info-value" id="approcheETA">--</div><div class="route-info-label">Arriv√©e</div></div>
                    </div>
                </div>
                
                <div class="route-info-box" id="routeInfoCourse" style="display: none;">
                    <div class="route-info-title">üéØ TRAJET DE LA COURSE</div>
                    <div class="route-info-details">
                        <div class="route-info-item"><div class="route-info-value" id="courseDistance">--</div><div class="route-info-label">Distance</div></div>
                        <div class="route-info-item"><div class="route-info-value" id="courseDuration">--</div><div class="route-info-label">Dur√©e</div></div>
                        <div class="route-info-item"><div class="route-info-value" id="coursePrice">--</div><div class="route-info-label">Prix</div></div>
                    </div>
                </div>
                
                <div class="course-status-card">
                    <span class="status-badge approche" id="courseStatus">üöó En route vers client</span>
                    <h3 id="courseStatusTitle" style="font-size: 1em;">Direction: Point de prise en charge</h3>
                </div>
                
                <div class="client-info-card">
                    <h3>üë§ Client</h3>
                    <div class="info-row"><span>Nom</span><strong id="clientName">-</strong></div>
                    <div class="info-row"><span>T√©l√©phone</span><strong id="clientPhone">-</strong></div>
                    <div class="info-row"><span>Note</span><strong id="clientRating">-</strong></div>
                </div>
                
                <div class="client-info-card">
                    <h3>üó∫Ô∏è Trajet du Client</h3>
                    <div class="info-row"><span>üìç D√©part</span><strong id="activeDeparture">-</strong></div>
                    <div class="info-row"><span>üéØ Destination</span><strong id="activeDestination">-</strong></div>
                    <div class="info-row"><span>üí∞ Prix</span><strong id="activePrice">-</strong></div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-btn secondary" id="btnNavigation" onclick="openGoogleMapsToClient()"><i class="fas fa-map-marked-alt"></i> GPS Client</button>
                    <button class="nav-btn primary" onclick="callClient()"><i class="fas fa-phone"></i> Appeler</button>
                </div>
                
                <div class="navigation-buttons" style="margin-top: 10px;">
                    <button class="nav-btn warning" id="btnArrive" onclick="updateCourseStatus('arrive')"><i class="fas fa-map-pin"></i> Arriv√©</button>
                    <button class="nav-btn primary" id="btnStart" onclick="updateCourseStatus('en_cours')" style="display: none;"><i class="fas fa-play"></i> D√©marrer</button>
                </div>
                
                <button class="btn btn-primary" onclick="completeCourse()" style="margin-top: 15px;" id="btnComplete" disabled><i class="fas fa-check-circle"></i> Terminer la course</button>
                <button class="btn" onclick="cancelCourse()" style="margin-top: 10px; background: #E30613; color: white;"><i class="fas fa-times-circle"></i> Annuler</button>
            </div>
        </div>

        <!-- HISTORY SCREEN -->
        <div id="historyScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-history"></i> Historique</h1>
                <button onclick="loadHistory()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>

        <!-- PROFILE SCREEN -->
        <div id="profileScreen" class="screen">
            <div class="profile-header">
                <button onclick="showScreen('dashboardScreen')" style="position: absolute; left: 15px; top: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;"><i class="fas fa-arrow-left"></i></button>
                <div class="profile-avatar" id="profileAvatar"><i class="fas fa-user"></i></div>
                <div class="profile-name" id="profileName">Chauffeur</div>
                <div style="font-size: 0.9em;">‚≠ê <span id="profileRating">4.8</span> ‚Ä¢ <span id="profileTotalCourses">0</span> courses</div>
            </div>
            <div class="profile-info">
                <div class="info-item"><span class="info-label">üì± T√©l√©phone</span><span class="info-value" id="profilePhone">-</span></div>
                <div class="info-item"><span class="info-label">üÜî ID Firestore</span><span class="info-value" id="profileFirestoreId" style="font-size: 0.6em; word-break: break-all;">-</span></div>
                <div class="info-item"><span class="info-label">üöó V√©hicule</span><span class="info-value" id="profileVehicle">-</span></div>
                <div class="info-item"><span class="info-label">üí∞ Revenus Total</span><span class="info-value" id="profileRevenuTotal">0 FCFA</span></div>
                
                <div class="stats-section">
                    <h3>üìä Statistiques d'Acceptation</h3>
                    <div class="stats-row"><span class="stats-row-label">Taux d'acceptation</span><span class="stats-row-value good" id="acceptanceRate">-</span></div>
                    <div class="acceptance-rate"><div class="acceptance-bar" id="acceptanceBar" style="width: 0%"></div></div>
                    <div class="stats-row"><span class="stats-row-label">Courses accept√©es</span><span class="stats-row-value good" id="coursesAccepted">0</span></div>
                    <div class="stats-row"><span class="stats-row-label">Courses refus√©es</span><span class="stats-row-value warning" id="coursesRefused">0</span></div>
                    <div class="stats-row"><span class="stats-row-label">Courses manqu√©es</span><span class="stats-row-value bad" id="coursesMissed">0</span></div>
                </div>
                
                <button class="btn btn-primary" onclick="handleLogout()" style="margin-top: 20px; background: #E30613;"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <div class="nav-item active" onclick="showScreen('dashboardScreen')"><div class="nav-icon"><i class="fas fa-home"></i></div><div class="nav-label">Accueil</div></div>
            <div class="nav-item" onclick="showScreen('walletScreen')"><div class="nav-icon"><i class="fas fa-wallet"></i></div><div class="nav-label">Portefeuille</div><div class="nav-badge" id="walletBadge" style="display: none;">!</div></div>
            <div class="nav-item" onclick="showScreen('activeCourseScreen')" id="navCourseItem"><div class="nav-icon"><i class="fas fa-route"></i></div><div class="nav-label">Course</div><div class="nav-badge" id="navCourseBadge" style="display: none;">!</div></div>
            <div class="nav-item" onclick="showScreen('historyScreen')"><div class="nav-icon"><i class="fas fa-history"></i></div><div class="nav-label">Historique</div></div>
            <div class="nav-item" onclick="showScreen('profileScreen')"><div class="nav-icon"><i class="fas fa-user"></i></div><div class="nav-label">Profil</div></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <script>
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBI1svukv3Ts7fN97ke5OGfwo2V-vRUGHI&callback=initMap';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
    </script>

    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
            authDomain: "albourakh-sn-ok.firebaseapp.com",
            projectId: "albourakh-sn-ok",
            storageBucket: "albourakh-sn-ok.firebasestorage.app",
            messagingSenderId: "297875396274",
            appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        console.log('üöï Al Bourakh Driver v6.0 - Recharge & Retrait - Initialized');

        // ========== CONSTANTS ==========
        const ALBOURAKH_ACCOUNT = '+221 78 785 01 01';
        const COMMISSION_RATE = 0.30;
        const DRIVER_RATE = 0.70;
        const MIN_WITHDRAWAL = 5000;
        const MIN_RECHARGE = 1000;

        // ========== VARIABLES GLOBALES ==========
        let currentUser = null;
        let isOnline = false;
        let currentCourse = null;
        let map = null;
        let activeCourseMap = null;
        let driverMarker = null;
        let clientPickupMarker = null;
        let clientDestinationMarker = null;
        let directionsService = null;
        let directionsRenderer = null;
        let audioContext = null;
        let currentRouteMode = 'approche';
        let approcheRoute = null;
        let courseRoute = null;
        let courseListener = null;

        // GPS Tracking
        let watchPositionId = null;
        let driverPosition = null;
        let lastPositionUpdate = 0;
        let trackingSession = null;
        let distanceParcourue = 0;
        let lastKnownPosition = null;
        let positionBuffer = [];

        const TRACKING_CONFIG = {
            updateInterval: 3000,
            minDistance: 5,
            batchSize: 10,
            historyRetention: 24 * 60 * 60 * 1000
        };

        let courseStats = { accepted: 0, refused: 0, missed: 0, todayAccepted: 0, todayMissed: 0 };

        // ========== WALLET STATE ==========
        let walletState = {
            soldeDisponible: 0,
            revenusJour: 0,
            revenusSemaine: 0,
            revenusMois: 0,
            pendingRecharges: [],
            pendingWithdrawals: [],
            allTransactions: [],
            rechargeAmount: '',
            rechargeSource: 'Orange Money',
            withdrawalAmount: '',
            withdrawalDestination: 'Orange Money'
        };

        // ========== WALLET FUNCTIONS ==========
        function calculateDriverEarnings(grossAmount, tipAmount = 0) {
            return {
                grossAmount: grossAmount,
                commission: Math.round(grossAmount * COMMISSION_RATE),
                netAmount: Math.round(grossAmount * DRIVER_RATE),
                tip: tipAmount,
                totalEarned: Math.round(grossAmount * DRIVER_RATE) + tipAmount
            };
        }

        async function loadWalletData() {
            if (!currentUser) return;
            showLoading('Chargement portefeuille...');

            try {
                if (currentUser.isDemo) {
                    walletState = {
                        soldeDisponible: 85000,
                        revenusJour: 28000,
                        revenusSemaine: 156000,
                        revenusMois: 624000,
                        pendingRecharges: [
                            { id: 'REC001', amount: 10000, source: 'Orange Money', createdAt: new Date(), status: 'pending' }
                        ],
                        pendingWithdrawals: [
                            { id: 'WD001', amount: 25000, destination: 'Wave', createdAt: new Date(Date.now() - 86400000), status: 'pending' }
                        ],
                        allTransactions: [
                            { id: 'T1', type: 'course', amount: 2600, date: new Date(), from: 'Sicap', to: 'Point E', status: 'completed' },
                            { id: 'T2', type: 'recharge', amount: 20000, date: new Date(Date.now() - 172800000), source: 'Wave', status: 'validated' },
                            { id: 'T3', type: 'withdrawal', amount: 15000, date: new Date(Date.now() - 259200000), destination: 'Orange Money', status: 'completed' }
                        ],
                        rechargeAmount: '',
                        rechargeSource: 'Orange Money',
                        withdrawalAmount: '',
                        withdrawalDestination: 'Orange Money'
                    };
                } else {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    
                    // Load driver data
                    const driverDoc = await db.collection('drivers').doc(driverId).get();
                    if (driverDoc.exists) {
                        const data = driverDoc.data();
                        walletState.soldeDisponible = data.soldeDisponible || 0;
                        walletState.revenusJour = data.revenusJour || 0;
                        walletState.revenusSemaine = data.revenusSemaine || 0;
                        walletState.revenusMois = data.revenusMois || 0;
                    }

                    // Load pending recharges - Get ALL and filter client-side
                    try {
                        const rechargesSnap = await db.collection('driver_recharges').get();
                        walletState.pendingRecharges = [];
                        rechargesSnap.forEach(doc => {
                            const data = doc.data();
                            if (data.driverId === driverId && data.status === 'pending') {
                                walletState.pendingRecharges.push({ id: doc.id, ...data });
                            }
                        });
                        // Sort client-side
                        walletState.pendingRecharges.sort((a, b) => {
                            const dateA = a.createdAt?.toDate?.() || new Date(0);
                            const dateB = b.createdAt?.toDate?.() || new Date(0);
                            return dateB - dateA;
                        });
                    } catch (e) {
                        console.warn('Recharges load error:', e.message);
                        walletState.pendingRecharges = [];
                    }

                    // Load pending withdrawals - Get ALL and filter client-side
                    try {
                        const withdrawalsSnap = await db.collection('withdrawals').get();
                        walletState.pendingWithdrawals = [];
                        withdrawalsSnap.forEach(doc => {
                            const data = doc.data();
                            if (data.driverId === driverId && data.status === 'pending') {
                                walletState.pendingWithdrawals.push({ id: doc.id, ...data });
                            }
                        });
                        // Sort client-side
                        walletState.pendingWithdrawals.sort((a, b) => {
                            const dateA = a.createdAt?.toDate?.() || new Date(0);
                            const dateB = b.createdAt?.toDate?.() || new Date(0);
                            return dateB - dateA;
                        });
                    } catch (e) {
                        console.warn('Withdrawals load error:', e.message);
                        walletState.pendingWithdrawals = [];
                    }
                }

                renderWalletDashboard();
                updateWalletBadge();
                hideLoading();
                showToast('‚úÖ Portefeuille actualis√©', 'success');
            } catch (error) {
                console.error('Erreur chargement portefeuille:', error);
                hideLoading();
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function updateWalletBadge() {
            const badge = document.getElementById('walletBadge');
            const total = walletState.pendingRecharges.length + walletState.pendingWithdrawals.length;
            if (total > 0) {
                badge.style.display = 'flex';
                badge.textContent = total;
            } else {
                badge.style.display = 'none';
            }
        }

        function renderWalletDashboard() {
            const totalPending = walletState.pendingRecharges.length + walletState.pendingWithdrawals.length;
            
            document.getElementById('walletDashboard').innerHTML = `
                <div class="card wallet-balance-card">
                    <p class="wallet-label">Solde Disponible</p>
                    <h2 class="wallet-amount">${walletState.soldeDisponible.toLocaleString()} FCFA</h2>
                    <div class="wallet-actions">
                        <button class="wallet-action-btn recharge" onclick="showRechargeScreen()">
                            <i class="fas fa-plus-circle"></i> Recharger
                        </button>
                        <button class="wallet-action-btn withdraw" onclick="showWithdrawalScreen()">
                            <i class="fas fa-arrow-up"></i> Retirer
                        </button>
                    </div>
                </div>

                ${totalPending > 0 ? `
                <div class="pending-transactions">
                    <div class="pending-header">
                        <span class="pending-icon">‚è≥</span>
                        <span class="pending-title">Transactions en attente</span>
                        <span class="pending-count">${totalPending}</span>
                    </div>
                    <div class="pending-list">
                        ${walletState.pendingRecharges.map(r => `
                            <div class="pending-item">
                                <div class="pending-item-info">
                                    <div class="pending-item-type">üì• Recharge ${r.source || ''}</div>
                                    <div class="pending-item-date">${formatDate(r.createdAt)}</div>
                                </div>
                                <div class="pending-item-amount credit">+${(r.amount || 0).toLocaleString()} F</div>
                                <span class="pending-status">En attente</span>
                            </div>
                        `).join('')}
                        ${walletState.pendingWithdrawals.map(w => `
                            <div class="pending-item">
                                <div class="pending-item-info">
                                    <div class="pending-item-type">üì§ Retrait ${w.destination || ''}</div>
                                    <div class="pending-item-date">${formatDate(w.createdAt)}</div>
                                </div>
                                <div class="pending-item-amount debit">-${(w.amount || 0).toLocaleString()} F</div>
                                <span class="pending-status">En attente</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="driver-stats">
                    <div class="driver-stat">
                        <p class="driver-stat-label">Aujourd'hui</p>
                        <p class="driver-stat-value">${walletState.revenusJour.toLocaleString()}</p>
                        <p class="driver-stat-unit">FCFA</p>
                    </div>
                    <div class="driver-stat">
                        <p class="driver-stat-label">Semaine</p>
                        <p class="driver-stat-value">${walletState.revenusSemaine.toLocaleString()}</p>
                        <p class="driver-stat-unit">FCFA</p>
                    </div>
                    <div class="driver-stat">
                        <p class="driver-stat-label">Mois</p>
                        <p class="driver-stat-value">${walletState.revenusMois.toLocaleString()}</p>
                        <p class="driver-stat-unit">FCFA</p>
                    </div>
                </div>

                <div class="card" style="padding: 0;">
                    <div class="section-header">
                        <h3>üìú Historique des transactions</h3>
                        <button onclick="showScreen('transactionsScreen'); loadAllTransactions();" style="background: #00A854; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-size: 0.85em; cursor: pointer;">
                            Voir tout <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <div style="background: #e0f2fe; border: 2px solid #0284c7; padding: 15px; border-radius: 12px; margin-top: 15px;">
                    <h4 style="color: #0369a1; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-info-circle"></i> Comment √ßa marche ?
                    </h4>
                    <p style="color: #0c4a6e; font-size: 0.85em; line-height: 1.5; margin-bottom: 8px;">
                        <strong>Recharger:</strong> Envoyez de l'argent au compte Al Bourakh, puis faites une demande. L'admin validera apr√®s r√©ception.
                    </p>
                    <p style="color: #0c4a6e; font-size: 0.85em; line-height: 1.5;">
                        <strong>Retirer:</strong> Demandez un retrait. L'admin vous transf√©rera l'argent sous 24-48h.
                    </p>
                </div>
            `;
        }

        function showRechargeScreen() {
            walletState.rechargeAmount = '';
            walletState.rechargeSource = 'Orange Money';
            showScreen('rechargeScreen');
            renderRechargeScreen();
        }

        function renderRechargeScreen() {
            document.getElementById('rechargeContent').innerHTML = `
                <div class="albourakh-account">
                    <h3>üì≤ Envoyez votre paiement au compte Al Bourakh</h3>
                    <div class="albourakh-number">${ALBOURAKH_ACCOUNT}</div>
                    <button class="albourakh-copy-btn" onclick="copyAccountNumber()">
                        <i class="fas fa-copy"></i> Copier le num√©ro
                    </button>
                </div>

                <div class="recharge-instructions">
                    <h4><i class="fas fa-list-ol"></i> Instructions</h4>
                    <ol>
                        <li><strong>Envoyez</strong> le montant souhait√© au num√©ro ci-dessus via Orange Money, Wave ou Free Money</li>
                        <li><strong>Indiquez</strong> le montant et la source ci-dessous</li>
                        <li><strong>Soumettez</strong> votre demande</li>
                        <li><strong>Attendez</strong> la validation par l'admin (sous 24h)</li>
                    </ol>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px; font-size: 1em;">üí∞ Montant envoy√©</h3>
                    <div class="amount-presets">
                        ${[5000, 10000, 20000, 30000, 50000, 100000].map(amt => `
                            <button class="preset-btn ${walletState.rechargeAmount == amt ? 'active' : ''}" 
                                    onclick="setRechargeAmount(${amt})">
                                ${amt.toLocaleString()}
                            </button>
                        `).join('')}
                    </div>
                    <div class="input-group">
                        <label>Ou saisissez un montant</label>
                        <div class="amount-input-container">
                            <input type="number" class="amount-input" id="rechargeAmountInput" 
                                   placeholder="0" value="${walletState.rechargeAmount}"
                                   oninput="walletState.rechargeAmount = this.value">
                            <span class="amount-currency">FCFA</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px; font-size: 1em;">üì± Source du paiement</h3>
                    <div class="payment-methods">
                        ${['Orange Money', 'Wave', 'Free Money'].map(source => `
                            <button class="payment-method ${walletState.rechargeSource === source ? 'active' : ''}"
                                    onclick="setRechargeSource('${source}')">
                                <span class="payment-method-icon">${source === 'Orange Money' ? 'üü†' : source === 'Wave' ? 'üîµ' : 'üü¢'}</span>
                                <span class="payment-method-name">${source}</span>
                                <i class="fas fa-check payment-method-check"></i>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div id="rechargeError" class="error-box hidden">
                    <span class="error-icon"><i class="fas fa-exclamation-circle"></i></span>
                    <span class="error-text">Montant minimum: ${MIN_RECHARGE.toLocaleString()} FCFA</span>
                </div>

                <button class="btn btn-success" onclick="submitRechargeRequest()" style="margin-top: 15px;">
                    <i class="fas fa-paper-plane"></i> Soumettre la demande de recharge
                </button>

                <p style="text-align: center; margin-top: 15px; color: #666; font-size: 0.85em;">
                    ‚ö†Ô∏è Assurez-vous d'avoir d√©j√† envoy√© l'argent avant de soumettre
                </p>
            `;
        }

        function setRechargeAmount(amount) {
            walletState.rechargeAmount = amount;
            document.getElementById('rechargeAmountInput').value = amount;
            renderRechargeScreen();
        }

        function setRechargeSource(source) {
            walletState.rechargeSource = source;
            renderRechargeScreen();
        }

        function copyAccountNumber() {
            navigator.clipboard.writeText(ALBOURAKH_ACCOUNT.replace(/\s/g, '')).then(() => {
                showToast('üìã Num√©ro copi√©!', 'success');
            }).catch(() => {
                showToast('‚ùå Erreur de copie', 'error');
            });
        }

        async function submitRechargeRequest() {
            const amount = parseInt(walletState.rechargeAmount);
            
            if (!amount || amount < MIN_RECHARGE) {
                document.getElementById('rechargeError').classList.remove('hidden');
                return;
            }

            if (!confirm(`Confirmez-vous avoir envoy√© ${amount.toLocaleString()} FCFA via ${walletState.rechargeSource} au ${ALBOURAKH_ACCOUNT} ?`)) {
                return;
            }

            showLoading('Envoi de la demande...');

            try {
                if (!currentUser.isDemo) {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    await db.collection('driver_recharges').add({
                        driverId: driverId,
                        driverNom: `${currentUser.prenom || ''} ${currentUser.nom || ''}`.trim(),
                        driverTelephone: currentUser.telephone,
                        amount: amount,
                        source: walletState.rechargeSource,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                walletState.pendingRecharges.unshift({
                    id: 'REC_' + Date.now(),
                    amount: amount,
                    source: walletState.rechargeSource,
                    status: 'pending',
                    createdAt: new Date()
                });

                hideLoading();
                showToast('‚úÖ Demande envoy√©e! En attente de validation.', 'success');
                
                setTimeout(() => {
                    showScreen('walletScreen');
                    renderWalletDashboard();
                    updateWalletBadge();
                }, 1500);
            } catch (error) {
                hideLoading();
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function showWithdrawalScreen() {
            walletState.withdrawalAmount = '';
            walletState.withdrawalDestination = 'Orange Money';
            showScreen('withdrawalScreen');
            renderWithdrawalScreen();
        }

        function renderWithdrawalScreen() {
            document.getElementById('withdrawalContent').innerHTML = `
                <div class="withdrawal-balance">
                    <p class="withdrawal-balance-label">Solde Disponible</p>
                    <p class="withdrawal-balance-amount">${walletState.soldeDisponible.toLocaleString()} FCFA</p>
                </div>

                <div class="withdrawal-info">
                    <h4><i class="fas fa-info-circle"></i> Information</h4>
                    <p>Les retraits sont trait√©s sous <strong>24-48h ouvr√©es</strong>. Le montant minimum est de <strong>${MIN_WITHDRAWAL.toLocaleString()} FCFA</strong>.</p>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px; font-size: 1em;">üí∞ Montant √† retirer</h3>
                    <div class="amount-input-container">
                        <input type="number" class="amount-input" id="withdrawalAmountInput" 
                               placeholder="0" value="${walletState.withdrawalAmount}"
                               oninput="walletState.withdrawalAmount = this.value"
                               max="${walletState.soldeDisponible}">
                        <span class="amount-currency">FCFA</span>
                    </div>
                    
                    <div class="quick-amounts" style="margin-top: 15px;">
                        <button class="quick-amount-btn" onclick="setWithdrawalAmount(${Math.floor(walletState.soldeDisponible * 0.25)})">25%</button>
                        <button class="quick-amount-btn" onclick="setWithdrawalAmount(${Math.floor(walletState.soldeDisponible * 0.5)})">50%</button>
                        <button class="quick-amount-btn" onclick="setWithdrawalAmount(${walletState.soldeDisponible})">Tout</button>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px; font-size: 1em;">üì± Destination du retrait</h3>
                    <div class="payment-methods">
                        ${['Orange Money', 'Wave', 'Free Money'].map(dest => `
                            <button class="payment-method ${walletState.withdrawalDestination === dest ? 'active' : ''}"
                                    onclick="setWithdrawalDestination('${dest}')">
                                <span class="payment-method-icon">${dest === 'Orange Money' ? 'üü†' : dest === 'Wave' ? 'üîµ' : 'üü¢'}</span>
                                <span class="payment-method-name">${dest}</span>
                                <i class="fas fa-check payment-method-check"></i>
                            </button>
                        `).join('')}
                    </div>
                    <div class="input-group" style="margin-top: 15px;">
                        <label>Num√©ro de r√©ception</label>
                        <input type="text" id="withdrawalPhone" value="${currentUser?.telephone || ''}" placeholder="+221 XX XXX XX XX">
                    </div>
                </div>

                <div id="withdrawalError" class="error-box hidden">
                    <span class="error-icon"><i class="fas fa-exclamation-circle"></i></span>
                    <span class="error-text" id="withdrawalErrorText">Montant minimum: ${MIN_WITHDRAWAL.toLocaleString()} FCFA</span>
                </div>

                <button class="btn btn-primary" onclick="submitWithdrawalRequest()" style="margin-top: 15px;">
                    <i class="fas fa-paper-plane"></i> Demander le retrait
                </button>
            `;
        }

        function setWithdrawalAmount(amount) {
            walletState.withdrawalAmount = amount;
            document.getElementById('withdrawalAmountInput').value = amount;
        }

        function setWithdrawalDestination(dest) {
            walletState.withdrawalDestination = dest;
            renderWithdrawalScreen();
        }

        async function submitWithdrawalRequest() {
            const amount = parseInt(walletState.withdrawalAmount);
            const errorBox = document.getElementById('withdrawalError');
            const errorText = document.getElementById('withdrawalErrorText');
            
            if (!amount || amount < MIN_WITHDRAWAL) {
                errorText.textContent = `Montant minimum: ${MIN_WITHDRAWAL.toLocaleString()} FCFA`;
                errorBox.classList.remove('hidden');
                return;
            }

            if (amount > walletState.soldeDisponible) {
                errorText.textContent = 'Solde insuffisant';
                errorBox.classList.remove('hidden');
                return;
            }

            if (!confirm(`Confirmer la demande de retrait de ${amount.toLocaleString()} FCFA vers ${walletState.withdrawalDestination} ?`)) {
                return;
            }

            showLoading('Envoi de la demande...');

            try {
                const phone = document.getElementById('withdrawalPhone').value;
                const driverId = currentUser.firestoreId || currentUser.uid;
                
                if (!currentUser.isDemo) {
                    // Cr√©er la demande de retrait avec TOUS les champs n√©cessaires
                    await db.collection('withdrawals').add({
                        driverId: driverId,  // IMPORTANT: pour le d√©bit automatique
                        driverNom: `${currentUser.prenom || ''} ${currentUser.nom || ''}`.trim() || 'Chauffeur',
                        driverTelephone: phone || currentUser.telephone,
                        amount: amount,
                        destination: walletState.withdrawalDestination,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        // M√©tadonn√©es suppl√©mentaires
                        soldeAvantRetrait: walletState.soldeDisponible,
                        requestedAt: new Date().toISOString()
                    });
                    
                    console.log(`üì§ Demande retrait cr√©√©e: ${amount} FCFA pour driver ${driverId}`);
                }

                walletState.pendingWithdrawals.unshift({
                    id: 'WD_' + Date.now(),
                    amount: amount,
                    destination: walletState.withdrawalDestination,
                    status: 'pending',
                    createdAt: new Date()
                });

                hideLoading();
                showToast('‚úÖ Demande de retrait envoy√©e!', 'success');
                
                setTimeout(() => {
                    showScreen('walletScreen');
                    renderWalletDashboard();
                    updateWalletBadge();
                }, 1500);
            } catch (error) {
                hideLoading();
                console.error('Erreur retrait:', error);
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        async function loadAllTransactions() {
            showLoading('Chargement transactions...');

            try {
                let transactions = [];

                if (currentUser.isDemo) {
                    transactions = [
                        { id: 'T1', type: 'course', amount: 2600, date: new Date(), from: 'Sicap', to: 'Point E', status: 'completed' },
                        { id: 'T2', type: 'recharge', amount: 20000, date: new Date(Date.now() - 86400000), source: 'Wave', status: 'validated' },
                        { id: 'T3', type: 'withdrawal', amount: 15000, date: new Date(Date.now() - 172800000), destination: 'Orange Money', status: 'completed' },
                        { id: 'T4', type: 'recharge', amount: 10000, date: new Date(Date.now() - 259200000), source: 'Orange Money', status: 'pending' },
                        { id: 'T5', type: 'course', amount: 3500, date: new Date(Date.now() - 345600000), from: 'Plateau', to: 'Almadies', status: 'completed' }
                    ];
                } else {
                    const driverId = currentUser.firestoreId || currentUser.uid;

                    // Recharges
                    const rechargesSnap = await db.collection('driver_recharges')
                        .where('driverId', '==', driverId)
                        .orderBy('createdAt', 'desc')
                        .limit(20)
                        .get();
                    rechargesSnap.forEach(doc => {
                        const d = doc.data();
                        transactions.push({
                            id: doc.id,
                            type: 'recharge',
                            amount: d.amount,
                            date: d.createdAt?.toDate?.() || new Date(),
                            source: d.source,
                            status: d.status
                        });
                    });

                    // Withdrawals
                    const withdrawalsSnap = await db.collection('withdrawals')
                        .where('driverId', '==', driverId)
                        .orderBy('createdAt', 'desc')
                        .limit(20)
                        .get();
                    withdrawalsSnap.forEach(doc => {
                        const d = doc.data();
                        transactions.push({
                            id: doc.id,
                            type: 'withdrawal',
                            amount: d.amount,
                            date: d.createdAt?.toDate?.() || new Date(),
                            destination: d.destination,
                            status: d.status
                        });
                    });

                    // Courses termin√©es
                    const coursesSnap = await db.collection('reservations')
                        .where('chauffeurAssigne', '==', driverId)
                        .where('statut', '==', 'terminee')
                        .orderBy('dateFin', 'desc')
                        .limit(20)
                        .get();
                    coursesSnap.forEach(doc => {
                        const d = doc.data();
                        const earnings = calculateDriverEarnings(d.prixEstime || 0, d.pourboire || 0);
                        transactions.push({
                            id: doc.id,
                            type: 'course',
                            amount: earnings.totalEarned,
                            date: d.dateFin?.toDate?.() || new Date(),
                            from: d.depart,
                            to: d.destination,
                            status: 'completed'
                        });
                    });

                    // Sort by date
                    transactions.sort((a, b) => b.date - a.date);
                }

                renderTransactions(transactions);
                hideLoading();
            } catch (error) {
                console.error('Erreur:', error);
                hideLoading();
                showToast('‚ùå Erreur de chargement', 'error');
            }
        }

        function renderTransactions(transactions) {
            document.getElementById('transactionsContent').innerHTML = `
                <div class="card" style="padding: 0;">
                    <div class="section-header">
                        <h3>üìú Toutes les transactions</h3>
                    </div>
                    <div class="transaction-list">
                        ${transactions.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-inbox" style="font-size: 3em; opacity: 0.3; margin-bottom: 15px;"></i>
                                <p>Aucune transaction</p>
                            </div>
                        ` : transactions.map(t => {
                            let icon, title, amountClass;
                            if (t.type === 'recharge') {
                                icon = 'recharge';
                                title = `üì• Recharge ${t.source || ''}`;
                                amountClass = 'positive';
                            } else if (t.type === 'withdrawal') {
                                icon = 'withdrawal';
                                title = `üì§ Retrait ${t.destination || ''}`;
                                amountClass = 'negative';
                            } else {
                                icon = 'course';
                                title = `üöó ${t.from || ''} ‚Üí ${t.to || ''}`;
                                amountClass = 'positive';
                            }
                            
                            return `
                                <div class="transaction-item">
                                    <div class="transaction-header">
                                        <div class="transaction-icon ${icon}">
                                            <i class="fas fa-${t.type === 'recharge' ? 'arrow-down' : t.type === 'withdrawal' ? 'arrow-up' : 'car'}"></i>
                                        </div>
                                        <div style="flex: 1;">
                                            <div class="transaction-route">${title}</div>
                                            <div class="transaction-date">${formatDate(t.date)}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div class="transaction-amount ${amountClass}">
                                                ${t.type === 'withdrawal' ? '-' : '+'}${(t.amount || 0).toLocaleString()} F
                                            </div>
                                            <span class="transaction-status ${t.status}">${getStatusLabel(t.status)}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('fr-FR') + ' ' + d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': '‚è≥ En attente',
                'validated': '‚úÖ Valid√©',
                'completed': '‚úÖ Effectu√©',
                'rejected': '‚ùå Refus√©'
            };
            return labels[status] || status;
        }

        // ========== PHONE VALIDATION ==========
        function validateSenegalPhone(phone) {
            if (!phone) return { valid: false, message: 'Num√©ro requis' };
            const cleaned = phone.replace(/[\s\-\.]/g, '');
            const patterns = [/^\+221(77|78|76|70)\d{7}$/, /^221(77|78|76|70)\d{7}$/, /^(77|78|76|70)\d{7}$/, /^00221(77|78|76|70)\d{7}$/];
            const isValid = patterns.some(pattern => pattern.test(cleaned));
            if (!isValid) return { valid: false, message: 'Format invalide. Utilisez: +221 77/78/76/70 XXX XX XX' };
            return { valid: true, normalized: cleaned };
        }
        
        function formatPhoneInput(input) {
            const cleaned = input.value.replace(/[\s\-\.]/g, '');
            const helper = document.getElementById('phoneHelper');
            if (cleaned.length > 0) {
                const validation = validateSenegalPhone(input.value);
                if (validation.valid) {
                    input.classList.remove('invalid');
                    input.classList.add('valid');
                    if (helper) { helper.textContent = '‚úì Num√©ro valide'; helper.style.color = '#00A854'; }
                } else {
                    input.classList.remove('valid');
                    if (cleaned.length >= 9) {
                        input.classList.add('invalid');
                        if (helper) { helper.textContent = validation.message; helper.classList.add('error'); }
                    }
                }
            }
        }

        function normalizePhoneForComparison(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, '');
        }

        async function findDriverByPhone(inputPhone) {
            const inputDigits = normalizePhoneForComparison(inputPhone);
            try {
                const snapshot = await db.collection('drivers').get();
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    const dbDigits = normalizePhoneForComparison(data.telephone || '');
                    const inputLocal = inputDigits.slice(-9);
                    const dbLocal = dbDigits.slice(-9);
                    if (inputLocal === dbLocal && inputLocal.length === 9) {
                        return { id: doc.id, ...data };
                    }
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        function displayProfilePhoto(photoUrl) {
            const headerPhoto = document.getElementById('headerProfilePhoto');
            if (photoUrl) {
                headerPhoto.innerHTML = `<img src="${photoUrl}" class="header-profile-photo" alt="Photo" onerror="this.parentElement.innerHTML='<div class=\\'header-profile-placeholder\\'><i class=\\'fas fa-user\\'></i></div>'">`;
            } else {
                headerPhoto.innerHTML = `<div class="header-profile-placeholder"><i class="fas fa-user"></i></div>`;
            }
            
            const profileAvatar = document.getElementById('profileAvatar');
            if (photoUrl) {
                profileAvatar.innerHTML = `<img src="${photoUrl}" alt="Photo" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>'">`;
            } else {
                profileAvatar.innerHTML = `<i class="fas fa-user"></i>`;
            }
        }

        // ========== LOGIN ==========
        async function handleLogin() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!phone || !password) { showToast('Remplissez tous les champs', 'error'); return; }
            
            const validation = validateSenegalPhone(phone);
            if (!validation.valid) { showToast(`‚ùå ${validation.message}`, 'error'); return; }
            
            const normalizedPhone = validation.normalized;

            if (password === 'demo123') {
                showLoading('Connexion d√©mo...');
                setTimeout(async () => {
                    currentUser = {
                        firestoreId: 'DEMO_' + Date.now(),
                        uid: 'DEMO_' + Date.now(),
                        telephone: phone,
                        prenom: 'Chauffeur',
                        nom: 'Demo',
                        rating: 4.8,
                        coursesCompletees: 42,
                        revenusTotal: 150000,
                        isDemo: true
                    };
                    hideLoading();
                    showToast('‚úÖ Mode d√©mo activ√©!', 'success');
                    document.getElementById('bottomNav').style.display = 'flex';
                    displayProfilePhoto(null);
                    showScreen('dashboardScreen');
                    loadDashboardDataDemo();
                    await loadWalletData();
                    await loadCourseStats();
                    startLocationTracking();
                }, 1000);
                return;
            }

            showLoading('Connexion...');

            try {
                const existingDriver = await findDriverByPhone(normalizedPhone);
                
                if (existingDriver) {
                    if (password !== 'Admin2025') {
                        hideLoading();
                        showToast('‚ùå Mot de passe incorrect', 'error');
                        return;
                    }
                    
                    currentUser = { firestoreId: existingDriver.id, uid: existingDriver.id, ...existingDriver };
                    
                    await db.collection('drivers').doc(existingDriver.id).update({
                        derniereConnexion: firebase.firestore.FieldValue.serverTimestamp(),
                        statut: 'hors_ligne'
                    });
                    
                    hideLoading();
                    displayProfilePhoto(existingDriver.photoProfil || existingDriver.photoIdentite);
                    
                    showToast(`‚úÖ Bienvenue ${currentUser.prenom || ''} ${currentUser.nom || ''}!`, 'success');
                    document.getElementById('bottomNav').style.display = 'flex';
                    showScreen('dashboardScreen');
                    await loadDashboardData();
                    await loadWalletData();
                    await loadCourseStats();
                    startLocationTracking();
                    return;
                }
                
                hideLoading();
                showToast('‚ùå Num√©ro non enregistr√©', 'error');
            } catch (error) {
                hideLoading();
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function handleLogout() {
            if (confirm('Voulez-vous vous d√©connecter?')) {
                showLoading('D√©connexion...');
                if (isOnline) toggleOnlineStatus();
                stopLocationTracking();
                if (courseListener) { courseListener(); courseListener = null; }
                if (!currentUser?.isDemo) auth.signOut();
                currentUser = null;
                currentCourse = null;
                hideLoading();
                document.getElementById('bottomNav').style.display = 'none';
                showScreen('loginScreen');
                showToast('D√©connexion r√©ussie', 'info');
            }
        }

        // ========== GOOGLE MAPS ==========
        function initMap() {
            const dakar = { lat: 14.6937, lng: -17.4441 };
            map = new google.maps.Map(document.getElementById('map'), {
                center: dakar, zoom: 14, disableDefaultUI: true, zoomControl: true
            });
            driverMarker = new google.maps.Marker({
                map: map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 12, fillColor: '#00A854', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 3 },
                title: 'Ma position'
            });
            directionsService = new google.maps.DirectionsService();
        }

        window.initMap = initMap;
        loadGoogleMaps();

        async function reverseGeocode(lat, lng) {
            try {
                if (google && google.maps) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            document.getElementById('currentAddress').textContent = results[0].formatted_address;
                        }
                    });
                }
            } catch (error) {
                document.getElementById('currentAddress').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            }
        }

        // ========== GPS TRACKING ==========
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showToast('‚ùå G√©olocalisation non support√©e', 'error');
                return;
            }
            watchPositionId = navigator.geolocation.watchPosition(
                handlePositionUpdate,
                handlePositionError,
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
            document.getElementById('trackingBadge').style.display = 'flex';
        }

        async function handlePositionUpdate(position) {
            const { latitude, longitude, accuracy, speed, heading } = position.coords;
            driverPosition = { lat: latitude, lng: longitude };

            document.getElementById('accuracy').innerHTML = `${accuracy < 50 ? 'üü¢' : 'üü°'} Pr√©cision: ${Math.round(accuracy)} m`;
            reverseGeocode(latitude, longitude);

            if (driverMarker && map && !currentCourse) {
                driverMarker.setPosition(driverPosition);
                map.panTo(driverPosition);
            }

            const statusElement = document.getElementById('trackingStatus');
            if (statusElement) {
                const speedKmh = Math.round((speed || 0) * 3.6);
                statusElement.textContent = speed > 0 ? `${speedKmh} km/h` : 'GPS Actif';
            }

            // Update Firestore
            if (currentUser && !currentUser.isDemo && Date.now() - lastPositionUpdate >= TRACKING_CONFIG.updateInterval) {
                try {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    await db.collection('drivers').doc(driverId).update({
                        positionActuelle: new firebase.firestore.GeoPoint(latitude, longitude),
                        derniereActivite: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    lastPositionUpdate = Date.now();
                } catch (e) { console.warn('Update position error:', e); }
            }
        }

        function handlePositionError(error) {
            document.getElementById('currentAddress').textContent = 'Position non disponible';
            document.getElementById('accuracy').innerHTML = 'üî¥ GPS d√©sactiv√©';
            if (error.code === 1) showToast('‚ö†Ô∏è Activez la g√©olocalisation', 'warning');
        }

        function stopLocationTracking() {
            if (watchPositionId) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
            }
            document.getElementById('trackingBadge').style.display = 'none';
        }

        // ========== ONLINE STATUS ==========
        async function toggleOnlineStatus() {
            if (!currentUser) return;
            isOnline = !isOnline;
            const toggle = document.getElementById('toggleSwitch');
            const statusText = document.getElementById('statusText');

            if (isOnline) {
                toggle.classList.add('active');
                statusText.textContent = 'üü¢ EN LIGNE';
                statusText.classList.add('online');
                showToast('‚úÖ Vous √™tes en ligne', 'success');
                listenForNewCourses();
                
                if (!currentUser.isDemo) {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    await db.collection('drivers').doc(driverId).update({ statut: 'disponible' });
                }
            } else {
                toggle.classList.remove('active');
                statusText.textContent = '‚ö´ HORS LIGNE';
                statusText.classList.remove('online');
                showToast('Vous √™tes hors ligne', 'info');
                if (courseListener) { courseListener(); courseListener = null; }
                
                if (!currentUser.isDemo) {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    await db.collection('drivers').doc(driverId).update({ statut: 'hors_ligne' });
                }
            }
        }

        // ========== COURSE MANAGEMENT ==========
        function listenForNewCourses() {
            if (!currentUser || !isOnline || currentUser.isDemo) return;
            const driverId = currentUser.firestoreId || currentUser.uid;
            courseListener = db.collection('reservations')
                .where('chauffeurAssigne', '==', driverId)
                .where('statut', '==', 'assignee')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            showCourseNotification({ id: change.doc.id, ...change.doc.data() });
                        }
                    });
                });
        }

        function showCourseNotification(course) {
            document.getElementById('navCourseBadge').style.display = 'flex';
            playAlertBeeps(0);
            
            const notification = document.createElement('div');
            notification.className = 'course-notification';
            notification.innerHTML = `
                <div class="course-modal">
                    <div class="course-timer" id="courseTimer">30<div class="course-timer-label">sec</div></div>
                    <h2 class="course-title">üîî NOUVELLE COURSE!</h2>
                    <div class="course-client"><strong>Client:</strong> ${course.clientNom || 'Client'}</div>
                    <div class="course-route">
                        <div class="route-point"><span class="route-icon">üìç</span><span>${course.depart}</span></div>
                        <div style="text-align: center; margin: 8px 0;">‚Üì</div>
                        <div class="route-point"><span class="route-icon">üéØ</span><span>${course.destination}</span></div>
                    </div>
                    <div class="course-details">
                        <div class="detail-item"><div class="detail-icon">üí∞</div><div>${(course.prixEstime || 0).toLocaleString()} F</div></div>
                        <div class="detail-item"><div class="detail-icon">üìè</div><div>${course.distance || 5} km</div></div>
                    </div>
                    <div class="course-actions">
                        <button class="btn btn-refuse" onclick="refuseCourse('${course.id}')">‚ùå Refuser</button>
                        <button class="btn btn-accept" onclick="acceptCourse('${course.id}', ${JSON.stringify(course).replace(/"/g, '&quot;')})">‚úÖ Accepter</button>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);

            let timeLeft = 30;
            const timerInterval = setInterval(() => {
                timeLeft--;
                const timer = document.getElementById('courseTimer');
                if (timer) timer.innerHTML = `${timeLeft}<div class="course-timer-label">sec</div>`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    refuseCourse(course.id, true);
                }
            }, 1000);
            notification.timerInterval = timerInterval;
        }

        async function acceptCourse(courseId, courseData) {
            const notification = document.querySelector('.course-notification');
            if (notification) { clearInterval(notification.timerInterval); notification.remove(); }
            document.getElementById('navCourseBadge').style.display = 'none';
            
            courseStats.accepted++;
            showLoading('Acceptation...');

            if (typeof courseData === 'string') courseData = JSON.parse(courseData.replace(/&quot;/g, '"'));
            currentCourse = { id: courseId, ...courseData, statut: 'acceptee' };

            if (!currentUser.isDemo) {
                try {
                    await db.collection('reservations').doc(courseId).update({
                        statut: 'acceptee',
                        accepteeParChauffeur: true,
                        dateAcceptation: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) { console.error('Erreur:', e); }
            }

            hideLoading();
            showToast('‚úÖ Course accept√©e!', 'success');
            showScreen('activeCourseScreen');
            displayActiveCourse();
        }

        function refuseCourse(courseId, auto = false) {
            const notification = document.querySelector('.course-notification');
            if (notification) { clearInterval(notification.timerInterval); notification.remove(); }
            document.getElementById('navCourseBadge').style.display = 'none';
            if (!auto) courseStats.refused++;
            else courseStats.missed++;
            showToast(auto ? '‚è±Ô∏è Temps √©coul√©' : 'Course refus√©e', 'info');
        }

        function displayActiveCourse() {
            if (!currentCourse) return;
            document.getElementById('clientName').textContent = currentCourse.clientNom || 'Client';
            document.getElementById('clientPhone').textContent = currentCourse.clientTelephone || '-';
            document.getElementById('activeDeparture').textContent = currentCourse.depart;
            document.getElementById('activeDestination').textContent = currentCourse.destination;
            document.getElementById('activePrice').textContent = `${(currentCourse.prixEstime || 0).toLocaleString()} FCFA`;
        }

        async function updateCourseStatus(newStatus) {
            if (!currentCourse) return;
            currentCourse.statut = newStatus;
            
            const btnArrive = document.getElementById('btnArrive');
            const btnStart = document.getElementById('btnStart');
            const btnComplete = document.getElementById('btnComplete');
            
            if (newStatus === 'arrive') {
                btnArrive.style.display = 'none';
                btnStart.style.display = 'block';
                showToast('‚úÖ Vous √™tes arriv√©', 'success');
            } else if (newStatus === 'en_cours') {
                btnStart.style.display = 'none';
                btnComplete.disabled = false;
                showToast('üöó Course d√©marr√©e!', 'success');
            }
        }

        async function completeCourse() {
            if (!currentCourse || currentCourse.statut !== 'en_cours') {
                showToast('‚ö†Ô∏è D√©marrez d\'abord la course', 'error');
                return;
            }
            if (!confirm('Confirmer la fin de la course?')) return;

            showLoading('Finalisation...');
            
            const earnings = calculateDriverEarnings(currentCourse.prixEstime || 0);
            walletState.soldeDisponible += earnings.totalEarned;
            walletState.revenusJour += earnings.totalEarned;

            if (!currentUser.isDemo) {
                try {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    await db.collection('reservations').doc(currentCourse.id).update({
                        statut: 'terminee',
                        dateFin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection('drivers').doc(driverId).update({
                        statut: 'disponible',
                        coursesCompletees: firebase.firestore.FieldValue.increment(1),
                        soldeDisponible: firebase.firestore.FieldValue.increment(earnings.totalEarned),
                        revenusJour: firebase.firestore.FieldValue.increment(earnings.totalEarned)
                    });
                } catch (e) { console.error('Erreur:', e); }
            }

            currentCourse = null;
            hideLoading();
            showToast('‚úÖ Course termin√©e!', 'success');
            showScreen('dashboardScreen');
        }

        async function cancelCourse() {
            if (!confirm('Annuler cette course?')) return;
            currentCourse = null;
            showToast('Course annul√©e', 'info');
            showScreen('dashboardScreen');
        }

        function callClient() {
            if (!currentCourse?.clientTelephone) {
                showToast('Num√©ro non disponible', 'error');
                return;
            }
            window.location.href = `tel:${currentCourse.clientTelephone}`;
        }

        function openGoogleMapsToClient() {
            if (!currentCourse?.departCoords && !currentCourse?.depart) {
                showToast('Coordonn√©es non disponibles', 'error');
                return;
            }
            const dest = currentCourse.departCoords ? 
                `${currentCourse.departCoords.lat},${currentCourse.departCoords.lng}` : 
                encodeURIComponent(currentCourse.depart + ', Dakar, Senegal');
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${dest}&travelmode=driving`, '_blank');
        }

        function showRouteTab(mode) { /* Simplified */ }

        // ========== AUDIO ==========
        function playBeep(freq = 800, dur = 200, vol = 0.3) {
            try {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + dur / 1000);
                osc.start();
                osc.stop(audioContext.currentTime + dur / 1000);
            } catch (e) {}
        }

        function playAlertBeeps(rep = 0) {
            [0, 300, 600, 900, 1200].forEach((delay, i) => {
                setTimeout(() => playBeep([800, 1000, 800, 1000, 1200][i], 200, 0.3), delay);
            });
            if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 300]);
        }

        // ========== STATS ==========
        async function loadCourseStats() {
            if (currentUser?.isDemo) {
                courseStats = { accepted: 42, refused: 5, missed: 3 };
            }
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            const total = courseStats.accepted + courseStats.refused + courseStats.missed;
            const rate = total > 0 ? ((courseStats.accepted / total) * 100).toFixed(1) : 0;
            document.getElementById('acceptanceRate').textContent = `${rate}%`;
            document.getElementById('acceptanceBar').style.width = `${rate}%`;
            document.getElementById('coursesAccepted').textContent = courseStats.accepted;
            document.getElementById('coursesRefused').textContent = courseStats.refused;
            document.getElementById('coursesMissed').textContent = courseStats.missed;
        }

        // ========== DASHBOARD ==========
        async function loadDashboardData() {
            if (!currentUser || currentUser.isDemo) return loadDashboardDataDemo();
            try {
                const driverId = currentUser.firestoreId || currentUser.uid;
                const driverDoc = await db.collection('drivers').doc(driverId).get();
                const data = driverDoc.data();

                displayProfilePhoto(data.photoProfil || data.photoIdentite);
                document.getElementById('profileName').textContent = `${data.prenom || ''} ${data.nom || ''}`;
                document.getElementById('profilePhone').textContent = data.telephone || '';
                document.getElementById('profileFirestoreId').textContent = driverId;
                document.getElementById('profileVehicle').textContent = data.vehicule?.modele || '-';
                document.getElementById('coursesTotal').textContent = data.coursesCompletees || 0;
                document.getElementById('profileTotalCourses').textContent = data.coursesCompletees || 0;
                document.getElementById('profileRevenuTotal').textContent = (data.revenusTotal || 0).toLocaleString() + ' FCFA';
                document.getElementById('coursesJour').textContent = data.coursesJour || 0;
                document.getElementById('revenusJour').textContent = (data.revenusJour || 0).toLocaleString();
            } catch (e) { console.error('Erreur:', e); }
        }

        function loadDashboardDataDemo() {
            displayProfilePhoto(null);
            document.getElementById('profileName').textContent = `${currentUser.prenom} ${currentUser.nom}`;
            document.getElementById('profilePhone').textContent = currentUser.telephone;
            document.getElementById('profileFirestoreId').textContent = currentUser.firestoreId;
            document.getElementById('profileVehicle').textContent = 'Toyota Corolla (Demo)';
            document.getElementById('rating').textContent = currentUser.rating.toFixed(1);
            document.getElementById('profileRating').textContent = currentUser.rating.toFixed(1);
            document.getElementById('coursesTotal').textContent = currentUser.coursesCompletees;
            document.getElementById('profileTotalCourses').textContent = currentUser.coursesCompletees;
            document.getElementById('profileRevenuTotal').textContent = currentUser.revenusTotal.toLocaleString() + ' FCFA';
            document.getElementById('coursesJour').textContent = '5';
            document.getElementById('revenusJour').textContent = '17,500';
        }

        // ========== HISTORY ==========
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            
            if (currentUser?.isDemo) {
                const courses = [
                    { date: new Date(), depart: 'Plateau', dest: 'Almadies', prix: 4500 },
                    { date: new Date(Date.now() - 3600000), depart: 'Sacr√©-C≈ìur', dest: 'Yoff', prix: 3200 }
                ];
                historyList.innerHTML = courses.map(c => `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-date">${c.date.toLocaleDateString('fr-FR')} ${c.date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                            <span class="history-price">${c.prix.toLocaleString()} FCFA</span>
                        </div>
                        <div class="history-route">üìç ${c.depart} ‚Üí üéØ ${c.dest}</div>
                        <span class="history-status">‚úÖ Termin√©e</span>
                    </div>
                `).join('');
                return;
            }

            historyList.innerHTML = '<div style="text-align: center; padding: 40px;">Chargement...</div>';
            
            try {
                const driverId = currentUser.firestoreId || currentUser.uid;
                // Get ALL reservations and filter client-side to avoid index issues
                const snapshot = await db.collection('reservations').get();

                const courses = [];
                snapshot.forEach(doc => {
                    const c = doc.data();
                    if (c.chauffeurAssigne === driverId && (c.statut === 'terminee' || c.statut === 'annulee')) {
                        courses.push({ id: doc.id, ...c });
                    }
                });

                // Sort client-side by timestamp
                courses.sort((a, b) => {
                    const dateA = a.timestamp?.toDate?.() || a.dateFin?.toDate?.() || new Date(0);
                    const dateB = b.timestamp?.toDate?.() || b.dateFin?.toDate?.() || new Date(0);
                    return dateB - dateA;
                });

                // Limit to 20
                const limitedCourses = courses.slice(0, 20);

                if (limitedCourses.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Aucune course</div>';
                    return;
                }

                historyList.innerHTML = '';
                limitedCourses.forEach(c => {
                    const date = c.timestamp?.toDate?.() || c.dateFin?.toDate?.() || new Date();
                    historyList.innerHTML += `
                        <div class="history-item">
                            <div class="history-header">
                                <span class="history-date">${date.toLocaleDateString('fr-FR')}</span>
                                <span class="history-price">${(c.prixEstime || 0).toLocaleString()} FCFA</span>
                            </div>
                            <div class="history-route">üìç ${c.depart || ''} ‚Üí üéØ ${c.destination || ''}</div>
                            <span class="history-status" style="${c.statut === 'terminee' ? '' : 'background: #E30613;'}">${c.statut === 'terminee' ? '‚úÖ Termin√©e' : '‚ùå Annul√©e'}</span>
                        </div>
                    `;
                });
            } catch (e) {
                console.error('Erreur historique:', e.message);
                historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #E30613;">Erreur de chargement</div>';
            }
        }

        // ========== NAVIGATION ==========
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            const navIndex = { 'dashboardScreen': 0, 'walletScreen': 1, 'activeCourseScreen': 2, 'historyScreen': 3, 'profileScreen': 4 };
            if (navIndex[screenId] !== undefined) {
                document.querySelectorAll('.nav-item')[navIndex[screenId]].classList.add('active');
            }

            if (screenId === 'historyScreen') loadHistory();
            if (screenId === 'walletScreen') loadWalletData();
        }

        // ========== UI ==========
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideInRight 0.3s reverse'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function showLoading(text = 'Chargement...') {
            const loading = document.createElement('div');
            loading.className = 'loading-overlay';
            loading.id = 'loadingOverlay';
            loading.innerHTML = `<div class="loading-spinner"></div><div class="loading-text">${text}</div>`;
            document.body.appendChild(loading);
        }

        function hideLoading() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) loading.remove();
        }

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöï Al Bourakh Driver v6.0 - Ready');
            document.getElementById('loginPhone').value = '+221 77 712 34 56';
            document.getElementById('loginPassword').value = 'demo123';
        });
    </script>
</body>
</html>
