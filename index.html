<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#00A854">
    <title>Al Bourakh Driver v5.3 - Complet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; }
        .mobile-container { max-width: 414px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .app-header { background: linear-gradient(135deg, #00A854, #FECB00); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 100; }
        .app-header h1 { font-size: 1.1em; display: flex; align-items: center; gap: 8px; }
        .app-header button { background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.1em; }
        
        .tracking-badge { position: fixed; top: 70px; right: 10px; background: linear-gradient(135deg, #00A854, #FECB00); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.7em; font-weight: bold; z-index: 1000; display: none; align-items: center; gap: 6px; box-shadow: 0 4px 12px rgba(0,168,84,0.3); animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .tracking-indicator { width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: blink 1s ease-in-out infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .login-screen { padding: 30px 25px; text-align: center; }
        .login-logo { width: 90px; height: 90px; margin: 0 auto 15px; background: linear-gradient(135deg, #00A854, #FECB00); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2em; box-shadow: 0 8px 20px rgba(0,168,84,0.3); }
        .login-title { font-size: 1.5em; color: #00A854; margin-bottom: 8px; }
        .login-subtitle { color: #666; margin-bottom: 25px; font-size: 0.9em; }
        
        .input-group { margin-bottom: 12px; text-align: left; }
        .input-group label { display: block; margin-bottom: 6px; color: #333; font-weight: 600; font-size: 0.9em; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; transition: border-color 0.3s; }
        .input-group input:focus { outline: none; border-color: #00A854; }
        .input-helper { font-size: 0.75em; color: #666; margin-top: 4px; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1em; font-weight: bold; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        .btn-secondary { background: white; color: #059669; border: 2px solid #059669; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .dashboard-content { padding: 12px; padding-bottom: 90px; }
        
        .status-toggle { background: white; padding: 12px 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .status-text { font-size: 1em; font-weight: bold; color: #999; }
        .status-text.online { color: #00A854; }
        .toggle-switch { position: relative; width: 55px; height: 30px; background: #ccc; border-radius: 30px; cursor: pointer; }
        .toggle-switch.active { background: #00A854; }
        .toggle-switch::after { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: all 0.3s; }
        .toggle-switch.active::after { left: 28px; }
        
        .map-container { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 12px; }
        .map-container h3 { margin-bottom: 8px; color: #333; font-size: 0.95em; }
        #map { width: 100%; height: 200px; border-radius: 10px; background: #e0e0e0; }
        #activeCourseMap { width: 100%; height: 250px; border-radius: 10px; background: #e0e0e0; }
        .location-info { background: #f5f5f5; padding: 10px; border-radius: 8px; margin-top: 8px; font-size: 0.85em; }
        .location-info div { margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px; }
        .stat-card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .stat-icon { font-size: 1.5em; margin-bottom: 5px; }
        .stat-value { font-size: 1.3em; font-weight: bold; color: #00A854; }
        .stat-label { color: #666; font-size: 0.8em; }
        
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; cursor: pointer; border: none; font-size: 0.85em; }
        .action-btn-icon { font-size: 1.5em; margin-bottom: 5px; }
        
        /* WALLET STYLES COMPLET */
        .wallet-content { padding: 12px; padding-bottom: 90px; }
        .wallet-card { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 8px 20px rgba(0,0,0,0.2); margin-bottom: 1rem; }
        .wallet-amount { font-size: 2.2rem; font-weight: 700; margin: 0.8rem 0; }
        .wallet-label { opacity: 0.9; font-size: 0.85rem; }
        .wallet-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; margin-top: 1rem; }
        .wallet-stat { background: rgba(255,255,255,0.15); padding: 0.8rem; border-radius: 0.6rem; }
        .wallet-stat-value { font-size: 1.2rem; font-weight: bold; }
        .wallet-stat-label { font-size: 0.75rem; opacity: 0.9; margin-top: 0.2rem; }
        
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .tab-btn { flex: 1; padding: 0.8rem; border: none; border-radius: 0.6rem; font-weight: 600; cursor: pointer; transition: all 0.3s; background: white; color: #333; font-size: 0.9em; }
        .tab-btn.active { background: linear-gradient(135deg, #00A854, #FECB00); color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { background: white; border-radius: 1rem; padding: 1rem; margin-bottom: 0.8rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { margin-bottom: 0.8rem; color: #333; display: flex; align-items: center; gap: 0.5rem; font-size: 1em; }
        
        .quick-amounts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.8rem; }
        .quick-amount { padding: 0.6rem; border: 2px solid #ddd; border-radius: 0.5rem; text-align: center; cursor: pointer; transition: all 0.3s; font-weight: 600; background: white; font-size: 0.9em; }
        .quick-amount:hover { border-color: #059669; background: #f0fdf4; }
        
        .payment-method { padding: 0.8rem; border: 2px solid #ddd; border-radius: 0.6rem; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.8rem; background: white; }
        .payment-method:hover { border-color: #059669; }
        .payment-method.selected { border-color: #059669; background: #f0fdf4; }
        
        .info-box { background: #e3f2fd; border: 2px solid #2196F3; padding: 0.8rem; border-radius: 0.6rem; margin-bottom: 0.8rem; }
        .info-box h4 { color: #1976d2; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.4rem; font-size: 0.9em; }
        .info-box p, .info-box ul { color: #0d47a1; font-size: 0.8rem; line-height: 1.4; }
        .info-box ul { margin-left: 1.2rem; margin-top: 0.4rem; }
        
        .warning-box { background: #fef3c7; border: 2px solid #f59e0b; padding: 0.8rem; border-radius: 0.6rem; margin-bottom: 0.8rem; }
        .warning-box h4 { color: #92400e; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.4rem; font-size: 0.9em; }
        .warning-box p, .warning-box ul { color: #78350f; font-size: 0.8rem; line-height: 1.4; }
        .warning-box ul { margin-left: 1.2rem; margin-top: 0.4rem; }
        
        .pending-item { background: #fff3cd; border-left: 4px solid #ffc107; padding: 0.8rem; border-radius: 0.5rem; margin-bottom: 0.6rem; }
        .pending-item h4 { color: #856404; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.4rem; font-size: 0.9em; }
        .pending-item p { font-size: 0.8rem; color: #666; }
        .pending-amount { font-size: 1.2rem; font-weight: bold; color: #E30613; }
        .pending-amount.credit { color: #00A854; }
        
        .completed-item { background: #e8f5e9; border-left: 4px solid #00A854; padding: 0.8rem; border-radius: 0.5rem; margin-bottom: 0.6rem; }
        .completed-item h4 { color: #155724; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.4rem; font-size: 0.9em; }
        
        .course-notification { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .course-modal { background: white; width: 90%; max-width: 380px; border-radius: 20px; padding: 20px; max-height: 90vh; overflow-y: auto; }
        .course-timer { background: linear-gradient(135deg, #E30613, #FF6B00); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 12px; font-size: 1.5em; font-weight: bold; animation: pulse 1s ease-in-out infinite; }
        .course-timer-label { font-size: 0.35em; }
        .course-title { text-align: center; font-size: 1.2em; color: #00A854; margin-bottom: 12px; }
        .course-client, .course-route { background: #f5f5f5; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9em; }
        .route-point { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .course-details { display: flex; justify-content: space-around; margin: 12px 0; padding: 10px; background: #f5f5f5; border-radius: 8px; }
        .detail-item { text-align: center; font-size: 0.9em; }
        .course-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
        .btn-refuse { background: #E30613; color: white; }
        .btn-accept { background: #00A854; color: white; }
        
        .active-course-container { padding: 12px; padding-bottom: 90px; }
        .course-status-card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 12px; }
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85em; margin-bottom: 8px; }
        .status-badge.approche { background: #fff3cd; color: #856404; }
        .status-badge.en-cours { background: #cce5ff; color: #004085; }
        
        .route-tabs { display: flex; gap: 8px; margin-bottom: 12px; }
        .route-tab { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 600; font-size: 0.8em; background: white; }
        .route-tab.active { border-color: #00A854; background: #e8f5e9; color: #00A854; }
        .route-tab.disabled { opacity: 0.5; cursor: not-allowed; }
        .route-tab i { display: block; font-size: 1.3em; margin-bottom: 4px; }
        
        .route-info-box { background: linear-gradient(135deg, #00A854, #FECB00); padding: 12px; border-radius: 10px; color: white; margin-bottom: 12px; }
        .route-info-box.approche { background: linear-gradient(135deg, #2196F3, #00BCD4); }
        .route-info-title { font-size: 0.85em; opacity: 0.9; margin-bottom: 6px; }
        .route-info-details { display: flex; justify-content: space-around; text-align: center; }
        .route-info-item { flex: 1; }
        .route-info-value { font-size: 1.2em; font-weight: bold; }
        .route-info-label { font-size: 0.7em; opacity: 0.9; }
        
        .client-info-card { background: white; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 12px; }
        .client-info-card h3 { margin-bottom: 10px; color: #333; font-size: 0.95em; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.85em; }
        .info-row:last-child { border-bottom: none; }
        
        .navigation-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .nav-btn { padding: 10px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.85em; }
        .nav-btn.primary { background: #00A854; color: white; }
        .nav-btn.secondary { background: #2196F3; color: white; }
        .nav-btn.warning { background: #FF9800; color: white; }
        .nav-btn.danger { background: #E30613; color: white; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 8px 0; max-width: 414px; margin: 0 auto; z-index: 1000; }
        .nav-item { text-align: center; cursor: pointer; padding: 6px; flex: 1; position: relative; }
        .nav-item.active { color: #00A854; }
        .nav-icon { font-size: 1.2em; margin-bottom: 3px; }
        .nav-label { font-size: 0.7em; }
        .nav-badge { position: absolute; top: 2px; right: 20%; background: #E30613; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 0.65em; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        
        .toast { position: fixed; top: 15px; right: 15px; left: 15px; max-width: 350px; margin: 0 auto; background: white; padding: 12px 16px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); z-index: 9999; animation: slideIn 0.3s; font-size: 0.9em; }
        @keyframes slideIn { from { transform: translateY(-100px); } to { transform: translateY(0); } }
        .toast.success { border-left: 4px solid #00A854; }
        .toast.error { border-left: 4px solid #E30613; }
        .toast.info { border-left: 4px solid #2196F3; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #FECB00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 1em; margin-top: 12px; }
        
        .history-list { padding: 12px; padding-bottom: 90px; }
        .history-item { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .history-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85em; }
        .history-price { font-weight: bold; color: #00A854; }
        .history-route { color: #333; margin-bottom: 4px; font-size: 0.85em; }
        .history-status { display: inline-block; padding: 3px 8px; border-radius: 15px; font-size: 0.75em; background: #00A854; color: white; }
        
        .profile-header { background: linear-gradient(135deg, #00A854, #FECB00); padding: 20px; text-align: center; color: white; position: relative; }
        .profile-avatar { width: 80px; height: 80px; background: white; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 2em; color: #00A854; overflow: hidden; border: 3px solid white; }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 1.2em; font-weight: bold; margin-bottom: 4px; }
        .profile-info { padding: 12px; padding-bottom: 90px; }
        .info-item { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-size: 0.9em; }
        
        .stats-section { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .stats-section h3 { color: #333; font-size: 0.95em; margin-bottom: 10px; }
        .stats-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.85em; }
        .stats-row:last-child { border-bottom: none; }
        .stats-row-value.good { color: #00A854; }
        .stats-row-value.warning { color: #FF9800; }
        .stats-row-value.bad { color: #E30613; }
        .acceptance-rate { width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; margin-top: 6px; }
        .acceptance-bar { height: 100%; background: linear-gradient(90deg, #E30613, #FF9800, #00A854); }
        
        .version-badge { display: inline-block; background: #d4edda; color: #155724; padding: 2px 5px; border-radius: 4px; font-size: 0.6em; font-weight: bold; margin-left: 4px; }
        
        .header-profile-photo { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid white; cursor: pointer; }
        .header-profile-placeholder { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.1em; border: 2px solid white; cursor: pointer; }
        
        @media (max-width: 414px) { .mobile-container, .bottom-nav { max-width: 100%; } }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="tracking-badge" id="trackingBadge">
            <div class="tracking-indicator"></div>
            <span id="trackingStatus">GPS Actif</span>
        </div>

        <!-- LOGIN SCREEN -->
        <div id="loginScreen" class="screen active">
            <div class="login-screen">
                <div class="login-logo">üöï</div>
                <h1 class="login-title">Al Bourakh Driver <span class="version-badge">v5.3</span></h1>
                <p class="login-subtitle">GPS PRO + Portefeuille Complet</p>
                
                <div class="input-group">
                    <label>üì± T√©l√©phone</label>
                    <input type="tel" id="loginPhone" placeholder="+221 77 123 45 67">
                </div>
                <div class="input-group">
                    <label>üîí Mot de passe</label>
                    <input type="password" id="loginPassword" placeholder="Mot de passe">
                </div>
                
                <button class="btn btn-primary" onclick="handleLogin()">Se connecter</button>
                
                <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 0.8em;">
                    <p><strong>üîê</strong> Num√©ro + <code>Admin2025</code></p>
                    <p><strong>üß™ D√©mo:</strong> Tout num√©ro + <code>demo123</code></p>
                </div>
            </div>
        </div>

        <!-- DASHBOARD SCREEN -->
        <div id="dashboardScreen" class="screen">
            <div class="app-header">
                <h1>üöï Dashboard</h1>
                <div id="headerProfilePhoto" onclick="showScreen('profileScreen')"></div>
            </div>
            
            <div class="dashboard-content">
                <div class="status-toggle">
                    <div>
                        <h3 style="font-size: 0.9em; margin-bottom: 3px;">Statut</h3>
                        <div class="status-text" id="statusText">‚ö´ HORS LIGNE</div>
                    </div>
                    <div class="toggle-switch" id="toggleSwitch" onclick="toggleOnlineStatus()"></div>
                </div>
                
                <div class="map-container">
                    <h3>üìç Ma Position</h3>
                    <div id="map"></div>
                    <div class="location-info">
                        <div><i class="fas fa-map-marker-alt"></i> <span id="currentAddress">En attente...</span></div>
                        <div><i class="fas fa-crosshairs"></i> <span id="accuracy">Pr√©cision: -- m</span></div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üöó</div>
                        <div class="stat-value" id="coursesJour">0</div>
                        <div class="stat-label">Courses Aujourd'hui</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="revenusJour">0</div>
                        <div class="stat-label">FCFA Aujourd'hui</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚≠ê</div>
                        <div class="stat-value" id="rating">4.8</div>
                        <div class="stat-label">Note</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="coursesTotal">0</div>
                        <div class="stat-label">Total Courses</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn" onclick="showScreen('walletScreen')">
                        <div class="action-btn-icon">üí≥</div>
                        <div>Portefeuille</div>
                    </button>
                    <button class="action-btn" onclick="showScreen('historyScreen')">
                        <div class="action-btn-icon">üìä</div>
                        <div>Historique</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- WALLET SCREEN COMPLET -->
        <div id="walletScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-wallet"></i> Portefeuille</h1>
                <button onclick="loadWalletData()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="wallet-content">
                <div class="wallet-card">
                    <div class="wallet-label">üí∞ Portefeuille Chauffeur</div>
                    <div class="wallet-amount" id="walletBalance">0 FCFA</div>
                    <div class="wallet-label">Solde disponible</div>
                    <div class="wallet-stats">
                        <div class="wallet-stat">
                            <div class="wallet-stat-value" id="totalEarnings">0</div>
                            <div class="wallet-stat-label">Gains Total</div>
                        </div>
                        <div class="wallet-stat">
                            <div class="wallet-stat-value" id="totalWithdrawn">0</div>
                            <div class="wallet-stat-label">Retraits Total</div>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchWalletTab('recharge')">
                        <i class="fas fa-plus-circle"></i> Recharger
                    </button>
                    <button class="tab-btn" onclick="switchWalletTab('withdraw')">
                        <i class="fas fa-money-bill-wave"></i> Retirer
                    </button>
                </div>

                <!-- TAB RECHARGE -->
                <div id="tab-recharge" class="tab-content active">
                    <div class="card">
                        <h3><i class="fas fa-plus-circle"></i> Recharger</h3>
                        <div class="info-box">
                            <h4><i class="fas fa-info-circle"></i> Comment Recharger ?</h4>
                            <ul>
                                <li>Choisissez le montant</li>
                                <li>S√©lectionnez Orange Money ou Wave</li>
                                <li>Transf√©rez vers <strong>+221 78 785 01 01</strong></li>
                                <li>Validez la demande</li>
                                <li>L'admin v√©rifie et cr√©dite votre compte</li>
                            </ul>
                        </div>
                        
                        <div class="input-group">
                            <label>Montant (FCFA)</label>
                            <input type="number" id="rechargeAmount" placeholder="Ex: 10000" min="1000" step="1000">
                        </div>
                        
                        <div class="quick-amounts">
                            <div class="quick-amount" onclick="setRechargeAmount(5000)">5 000 F</div>
                            <div class="quick-amount" onclick="setRechargeAmount(10000)">10 000 F</div>
                            <div class="quick-amount" onclick="setRechargeAmount(20000)">20 000 F</div>
                            <div class="quick-amount" onclick="setRechargeAmount(50000)">50 000 F</div>
                        </div>
                        
                        <div class="input-group">
                            <label>Moyen de Paiement</label>
                            <div class="payment-method" onclick="selectRechargeMethod('Orange Money', this)">
                                <span style="font-size: 1.3em;">üì±</span>
                                <div><div style="font-weight: 600;">Orange Money</div></div>
                            </div>
                            <div class="payment-method" onclick="selectRechargeMethod('Wave', this)">
                                <span style="font-size: 1.3em;">üí≥</span>
                                <div><div style="font-weight: 600;">Wave</div></div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="submitRechargeRequest()">
                            <i class="fas fa-paper-plane"></i> Envoyer la Demande
                        </button>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-clock"></i> Recharges en Attente</h3>
                        <div id="pendingRechargesList">
                            <p style="text-align: center; color: #999; padding: 1rem;">Aucune recharge en cours</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-check-circle"></i> Recharges Valid√©es</h3>
                        <div id="validatedRechargesList">
                            <p style="text-align: center; color: #999; padding: 1rem;">Aucune recharge valid√©e</p>
                        </div>
                    </div>
                </div>

                <!-- TAB RETRAIT -->
                <div id="tab-withdraw" class="tab-content">
                    <div class="card">
                        <h3><i class="fas fa-money-bill-wave"></i> Retirer</h3>
                        <div class="warning-box">
                            <h4><i class="fas fa-info-circle"></i> Proc√©dure de Retrait</h4>
                            <ul>
                                <li>Choisissez le montant √† retirer</li>
                                <li>S√©lectionnez Orange Money ou Wave</li>
                                <li>Validez (solde d√©bit√© imm√©diatement)</li>
                                <li>L'admin effectue le transfert</li>
                            </ul>
                            <p style="margin-top: 0.5rem; font-weight: bold;">‚ö†Ô∏è Compte: +221 78 785 01 01</p>
                        </div>
                        
                        <div class="input-group">
                            <label>Montant √† Retirer (FCFA)</label>
                            <input type="number" id="withdrawAmount" placeholder="Ex: 50000" min="5000" step="5000">
                            <p style="font-size: 0.8em; color: #666; margin-top: 4px;">Minimum: 5 000 FCFA</p>
                        </div>
                        
                        <div class="quick-amounts">
                            <div class="quick-amount" onclick="setWithdrawAmount(10000)">10 000 F</div>
                            <div class="quick-amount" onclick="setWithdrawAmount(25000)">25 000 F</div>
                            <div class="quick-amount" onclick="setWithdrawAmount(50000)">50 000 F</div>
                            <div class="quick-amount" onclick="setWithdrawAmount(100000)">100 000 F</div>
                        </div>
                        
                        <div class="input-group">
                            <label>Destination du Retrait</label>
                            <div class="payment-method" onclick="selectWithdrawDestination('Orange Money', this)">
                                <span style="font-size: 1.3em;">üì±</span>
                                <div><div style="font-weight: 600;">Orange Money</div></div>
                            </div>
                            <div class="payment-method" onclick="selectWithdrawDestination('Wave', this)">
                                <span style="font-size: 1.3em;">üí≥</span>
                                <div><div style="font-weight: 600;">Wave</div></div>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="submitWithdrawalRequest()" id="submitWithdrawBtn">
                            <i class="fas fa-paper-plane"></i> Demander le Retrait
                        </button>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-clock"></i> Retraits en Attente</h3>
                        <div id="pendingWithdrawalsList">
                            <p style="text-align: center; color: #999; padding: 1rem;">Aucun retrait en cours</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-check-circle"></i> Retraits Effectu√©s</h3>
                        <div id="completedWithdrawalsList">
                            <p style="text-align: center; color: #999; padding: 1rem;">Aucun retrait effectu√©</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ACTIVE COURSE SCREEN -->
        <div id="activeCourseScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-route"></i> Course Active</h1>
                <button onclick="callClient()"><i class="fas fa-phone"></i></button>
            </div>
            
            <div class="active-course-container">
                <div class="route-tabs">
                    <div class="route-tab active" id="tabApproche" onclick="showRouteTab('approche')">
                        <i class="fas fa-car-side"></i> Vers Client
                    </div>
                    <div class="route-tab disabled" id="tabCourse" onclick="showRouteTab('course')">
                        <i class="fas fa-route"></i> Course
                    </div>
                </div>
                
                <div class="map-container">
                    <div id="activeCourseMap"></div>
                </div>
                
                <div class="route-info-box approche" id="routeInfoApproche">
                    <div class="route-info-title">üöó TRAJET VERS LE CLIENT</div>
                    <div class="route-info-details">
                        <div class="route-info-item">
                            <div class="route-info-value" id="approcheDistance">--</div>
                            <div class="route-info-label">Distance</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-value" id="approcheDuration">--</div>
                            <div class="route-info-label">Dur√©e</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-value" id="approcheETA">--</div>
                            <div class="route-info-label">Arriv√©e</div>
                        </div>
                    </div>
                </div>
                
                <div class="route-info-box" id="routeInfoCourse" style="display: none;">
                    <div class="route-info-title">üéØ TRAJET DE LA COURSE</div>
                    <div class="route-info-details">
                        <div class="route-info-item">
                            <div class="route-info-value" id="courseDistance">--</div>
                            <div class="route-info-label">Distance</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-value" id="courseDuration">--</div>
                            <div class="route-info-label">Dur√©e</div>
                        </div>
                        <div class="route-info-item">
                            <div class="route-info-value" id="coursePrice">--</div>
                            <div class="route-info-label">Prix</div>
                        </div>
                    </div>
                </div>
                
                <div class="course-status-card">
                    <span class="status-badge approche" id="courseStatus">üöó En route vers client</span>
                    <h3 id="courseStatusTitle" style="font-size: 0.95em;">Direction: Point de prise en charge</h3>
                </div>
                
                <div class="client-info-card">
                    <h3>üë§ Client</h3>
                    <div class="info-row"><span>Nom</span><strong id="clientName">-</strong></div>
                    <div class="info-row"><span>T√©l√©phone</span><strong id="clientPhone">-</strong></div>
                </div>
                
                <div class="client-info-card">
                    <h3>üó∫Ô∏è Trajet</h3>
                    <div class="info-row"><span>üìç D√©part</span><strong id="activeDeparture">-</strong></div>
                    <div class="info-row"><span>üéØ Destination</span><strong id="activeDestination">-</strong></div>
                    <div class="info-row"><span>üí∞ Prix</span><strong id="activePrice">-</strong></div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-btn secondary" id="btnNavigation" onclick="openGoogleMapsToClient()">
                        <i class="fas fa-map-marked-alt"></i> GPS
                    </button>
                    <button class="nav-btn primary" onclick="callClient()">
                        <i class="fas fa-phone"></i> Appeler
                    </button>
                </div>
                
                <div class="navigation-buttons" style="margin-top: 8px;">
                    <button class="nav-btn warning" id="btnArrive" onclick="updateCourseStatus('arrive')">
                        <i class="fas fa-map-pin"></i> Arriv√©
                    </button>
                    <button class="nav-btn primary" id="btnStart" onclick="updateCourseStatus('en_cours')" style="display: none;">
                        <i class="fas fa-play"></i> D√©marrer
                    </button>
                </div>
                
                <button class="btn btn-primary" onclick="completeCourse()" style="margin-top: 12px;" id="btnComplete" disabled>
                    <i class="fas fa-check-circle"></i> Terminer la course
                </button>
                
                <button class="btn" onclick="cancelCourse()" style="margin-top: 8px; background: #E30613; color: white;">
                    <i class="fas fa-times-circle"></i> Annuler
                </button>
            </div>
        </div>

        <!-- HISTORY SCREEN -->
        <div id="historyScreen" class="screen">
            <div class="app-header">
                <button onclick="showScreen('dashboardScreen')"><i class="fas fa-arrow-left"></i></button>
                <h1><i class="fas fa-history"></i> Historique</h1>
                <button onclick="loadHistory()"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>

        <!-- PROFILE SCREEN -->
        <div id="profileScreen" class="screen">
            <div class="profile-header">
                <button onclick="showScreen('dashboardScreen')" style="position: absolute; left: 12px; top: 12px; background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="profile-avatar" id="profileAvatar"><i class="fas fa-user"></i></div>
                <div class="profile-name" id="profileName">Chauffeur</div>
                <div style="font-size: 0.85em;">‚≠ê <span id="profileRating">4.8</span> ‚Ä¢ <span id="profileTotalCourses">0</span> courses</div>
            </div>
            <div class="profile-info">
                <div class="info-item"><span>üì± T√©l√©phone</span><span id="profilePhone">-</span></div>
                <div class="info-item"><span>üöó V√©hicule</span><span id="profileVehicle">-</span></div>
                <div class="info-item"><span>üí∞ Revenus Total</span><span id="profileRevenuTotal">0 FCFA</span></div>
                
                <div class="stats-section">
                    <h3>üìä Statistiques</h3>
                    <div class="stats-row">
                        <span>Taux d'acceptation</span>
                        <span class="stats-row-value good" id="acceptanceRate">-</span>
                    </div>
                    <div class="acceptance-rate">
                        <div class="acceptance-bar" id="acceptanceBar" style="width: 0%"></div>
                    </div>
                    <div class="stats-row">
                        <span>Courses accept√©es</span>
                        <span class="stats-row-value good" id="coursesAccepted">0</span>
                    </div>
                    <div class="stats-row">
                        <span>Courses refus√©es</span>
                        <span class="stats-row-value warning" id="coursesRefused">0</span>
                    </div>
                </div>
                
                <button class="btn" onclick="handleLogout()" style="margin-top: 15px; background: #E30613; color: white;">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav" id="bottomNav" style="display: none;">
            <div class="nav-item active" onclick="showScreen('dashboardScreen')">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <div class="nav-label">Accueil</div>
            </div>
            <div class="nav-item" onclick="showScreen('walletScreen')">
                <div class="nav-icon"><i class="fas fa-wallet"></i></div>
                <div class="nav-label">Portefeuille</div>
            </div>
            <div class="nav-item" onclick="showScreen('activeCourseScreen')" id="navCourseItem">
                <div class="nav-icon"><i class="fas fa-route"></i></div>
                <div class="nav-label">Course</div>
                <div class="nav-badge" id="navCourseBadge" style="display: none;">!</div>
            </div>
            <div class="nav-item" onclick="showScreen('historyScreen')">
                <div class="nav-icon"><i class="fas fa-history"></i></div>
                <div class="nav-label">Historique</div>
            </div>
            <div class="nav-item" onclick="showScreen('profileScreen')">
                <div class="nav-icon"><i class="fas fa-user"></i></div>
                <div class="nav-label">Profil</div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyANcdvMz2yMbRD4V82EGLm95Jh2NdaR2o0",
            authDomain: "albourakh-sn-ok.firebaseapp.com",
            projectId: "albourakh-sn-ok",
            storageBucket: "albourakh-sn-ok.firebasestorage.app",
            messagingSenderId: "297875396274",
            appId: "1:297875396274:web:82a466c4fce6fbb79b1bab"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Variables globales
        let currentUser = null;
        let isOnline = false;
        let currentCourse = null;
        let map = null;
        let activeCourseMap = null;
        let driverMarker = null;
        let directionsService = null;
        let directionsRenderer = null;
        let watchPositionId = null;
        let driverPosition = null;
        let currentRouteMode = 'approche';
        let courseListener = null;
        let walletBalance = 0;

        // Wallet variables
        const ALBOURAKH_ACCOUNT = '+221 78 785 01 01';
        let selectedRechargeMethod = null;
        let selectedWithdrawDestination = null;

        // ========== UTILITY FUNCTIONS ==========
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showLoading(text = 'Chargement...') {
            const loading = document.createElement('div');
            loading.className = 'loading-overlay';
            loading.id = 'loadingOverlay';
            loading.innerHTML = `<div class="loading-spinner"></div><div class="loading-text">${text}</div>`;
            document.body.appendChild(loading);
        }

        function hideLoading() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) loading.remove();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            const navIndex = { 'dashboardScreen': 0, 'walletScreen': 1, 'activeCourseScreen': 2, 'historyScreen': 3, 'profileScreen': 4 };
            if (navIndex[screenId] !== undefined) {
                document.querySelectorAll('.nav-item')[navIndex[screenId]].classList.add('active');
            }
            if (screenId === 'walletScreen') loadWalletData();
            if (screenId === 'historyScreen') loadHistory();
        }

        // ========== WALLET FUNCTIONS ==========
        function switchWalletTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        function setRechargeAmount(amount) {
            document.getElementById('rechargeAmount').value = amount;
        }

        function setWithdrawAmount(amount) {
            document.getElementById('withdrawAmount').value = amount;
        }

        function selectRechargeMethod(method, element) {
            selectedRechargeMethod = method;
            document.querySelectorAll('#tab-recharge .payment-method').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function selectWithdrawDestination(dest, element) {
            selectedWithdrawDestination = dest;
            document.querySelectorAll('#tab-withdraw .payment-method').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        async function loadWalletData() {
            if (!currentUser) return;

            try {
                if (currentUser.isDemo) {
                    walletBalance = 85000;
                    document.getElementById('walletBalance').textContent = walletBalance.toLocaleString() + ' FCFA';
                    document.getElementById('totalEarnings').textContent = '150 000 F';
                    document.getElementById('totalWithdrawn').textContent = '65 000 F';
                    return;
                }

                const driverId = currentUser.firestoreId || currentUser.uid;
                const phone = currentUser.telephone;

                // Load driver balance
                const driverDoc = await db.collection('drivers').doc(driverId).get();
                if (driverDoc.exists) {
                    const data = driverDoc.data();
                    walletBalance = data.soldeDisponible || 0;
                    document.getElementById('walletBalance').textContent = walletBalance.toLocaleString() + ' FCFA';
                    document.getElementById('totalEarnings').textContent = (data.revenusTotal || 0).toLocaleString() + ' F';
                }

                // Load total withdrawn
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .where('driverTelephone', '==', phone)
                    .where('status', '==', 'completed')
                    .get();
                
                const totalWithdrawn = withdrawalsSnapshot.docs.reduce((sum, doc) => sum + (doc.data().amount || 0), 0);
                document.getElementById('totalWithdrawn').textContent = totalWithdrawn.toLocaleString() + ' F';

                // Update withdraw button
                const submitBtn = document.getElementById('submitWithdrawBtn');
                if (walletBalance < 5000) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-ban"></i> Solde insuffisant';
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Demander le Retrait';
                }

                // Load pending/validated transactions
                await loadPendingRecharges(phone);
                await loadValidatedRecharges(phone);
                await loadPendingWithdrawals(phone);
                await loadCompletedWithdrawals(phone);

            } catch (error) {
                console.error('Erreur chargement portefeuille:', error);
            }
        }

        async function submitRechargeRequest() {
            const amount = parseInt(document.getElementById('rechargeAmount').value);

            if (!amount || amount < 1000) {
                showToast('‚ö†Ô∏è Montant minimum: 1 000 FCFA', 'error');
                return;
            }

            if (!selectedRechargeMethod) {
                showToast('‚ö†Ô∏è S√©lectionnez un moyen de paiement', 'error');
                return;
            }

            if (!currentUser) {
                showToast('‚ö†Ô∏è Connectez-vous d\'abord', 'error');
                return;
            }

            if (!confirm(`Confirmez-vous avoir transf√©r√© ${amount.toLocaleString()} FCFA depuis ${selectedRechargeMethod} vers ${ALBOURAKH_ACCOUNT} ?`)) {
                return;
            }

            showLoading('Envoi de la demande...');

            try {
                if (!currentUser.isDemo) {
                    await db.collection('driver_recharges').add({
                        driverNom: `${currentUser.prenom || ''} ${currentUser.nom || ''}`.trim(),
                        driverTelephone: currentUser.telephone,
                        driverId: currentUser.firestoreId || currentUser.uid,
                        amount: amount,
                        source: selectedRechargeMethod,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        instructions: `Transfert depuis ${selectedRechargeMethod} vers ${ALBOURAKH_ACCOUNT}`
                    });
                }

                document.getElementById('rechargeAmount').value = '';
                document.querySelectorAll('#tab-recharge .payment-method').forEach(el => el.classList.remove('selected'));
                selectedRechargeMethod = null;

                hideLoading();
                showToast('‚úÖ Demande envoy√©e ! En attente de validation.', 'success');
                await loadWalletData();
            } catch (error) {
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function submitWithdrawalRequest() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);

            if (!amount || amount < 5000) {
                showToast('‚ö†Ô∏è Montant minimum: 5 000 FCFA', 'error');
                return;
            }

            if (amount > walletBalance) {
                showToast(`‚ö†Ô∏è Solde insuffisant (${walletBalance.toLocaleString()} FCFA)`, 'error');
                return;
            }

            if (!selectedWithdrawDestination) {
                showToast('‚ö†Ô∏è S√©lectionnez une destination', 'error');
                return;
            }

            if (!confirm(`Confirmer le retrait de ${amount.toLocaleString()} FCFA vers ${selectedWithdrawDestination} ?\n\nVotre solde sera d√©bit√© imm√©diatement.`)) {
                return;
            }

            showLoading('Traitement...');

            try {
                if (!currentUser.isDemo) {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    
                    await db.collection('drivers').doc(driverId).update({
                        soldeDisponible: firebase.firestore.FieldValue.increment(-amount)
                    });

                    await db.collection('withdrawals').add({
                        driverNom: `${currentUser.prenom || ''} ${currentUser.nom || ''}`.trim(),
                        driverTelephone: currentUser.telephone,
                        driverId: driverId,
                        amount: amount,
                        destination: selectedWithdrawDestination,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        instructions: `Transfert depuis ${ALBOURAKH_ACCOUNT} vers ${currentUser.telephone} via ${selectedWithdrawDestination}`
                    });
                }

                document.getElementById('withdrawAmount').value = '';
                document.querySelectorAll('#tab-withdraw .payment-method').forEach(el => el.classList.remove('selected'));
                selectedWithdrawDestination = null;

                hideLoading();
                showToast('‚úÖ Demande envoy√©e !', 'success');
                await loadWalletData();
            } catch (error) {
                hideLoading();
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function loadPendingRecharges(phone) {
            if (!phone || currentUser.isDemo) return;

            try {
                const snapshot = await db.collection('driver_recharges')
                    .where('driverTelephone', '==', phone)
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();

                const list = document.getElementById('pendingRechargesList');

                if (snapshot.empty) {
                    list.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Aucune recharge en cours</p>';
                    return;
                }

                list.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString('fr-FR') : 'N/A';
                    return `
                        <div class="pending-item">
                            <h4><i class="fas fa-hourglass-half"></i> En cours de validation</h4>
                            <div class="pending-amount credit">+${data.amount.toLocaleString()} FCFA</div>
                            <p><strong>${data.source}</strong> ‚Üí ${ALBOURAKH_ACCOUNT}</p>
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.3rem;">${date}</p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadValidatedRecharges(phone) {
            if (!phone || currentUser.isDemo) return;

            try {
                const snapshot = await db.collection('driver_recharges')
                    .where('driverTelephone', '==', phone)
                    .where('status', '==', 'validated')
                    .orderBy('validatedAt', 'desc')
                    .limit(5)
                    .get();

                const list = document.getElementById('validatedRechargesList');

                if (snapshot.empty) {
                    list.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Aucune recharge valid√©e</p>';
                    return;
                }

                list.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = data.validatedAt?.toDate ? data.validatedAt.toDate().toLocaleString('fr-FR') : 'N/A';
                    return `
                        <div class="completed-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4><i class="fas fa-check-circle"></i> Valid√©e</h4>
                                    <p style="font-size: 0.8em; color: #666;">${data.source}</p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.1em; font-weight: bold; color: #00A854;">+${data.amount.toLocaleString()} F</div>
                                    <div style="font-size: 0.7em; color: #999;">${date}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadPendingWithdrawals(phone) {
            if (!phone || currentUser.isDemo) return;

            try {
                const snapshot = await db.collection('withdrawals')
                    .where('driverTelephone', '==', phone)
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();

                const list = document.getElementById('pendingWithdrawalsList');

                if (snapshot.empty) {
                    list.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Aucun retrait en cours</p>';
                    return;
                }

                list.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString('fr-FR') : 'N/A';
                    return `
                        <div class="pending-item">
                            <h4><i class="fas fa-hourglass-half"></i> En cours de traitement</h4>
                            <div class="pending-amount">-${data.amount.toLocaleString()} FCFA</div>
                            <p><strong>Destination:</strong> ${data.destination}</p>
                            <p style="font-size: 0.75em; color: #999; margin-top: 0.3rem;">${date}</p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadCompletedWithdrawals(phone) {
            if (!phone || currentUser.isDemo) return;

            try {
                const snapshot = await db.collection('withdrawals')
                    .where('driverTelephone', '==', phone)
                    .where('status', '==', 'completed')
                    .orderBy('completedAt', 'desc')
                    .limit(5)
                    .get();

                const list = document.getElementById('completedWithdrawalsList');

                if (snapshot.empty) {
                    list.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">Aucun retrait effectu√©</p>';
                    return;
                }

                list.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = data.completedAt?.toDate ? data.completedAt.toDate().toLocaleString('fr-FR') : 'N/A';
                    return `
                        <div class="completed-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4><i class="fas fa-check-circle"></i> Effectu√©</h4>
                                    <p style="font-size: 0.8em; color: #666;">${data.destination}</p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.1em; font-weight: bold; color: #E30613;">-${data.amount.toLocaleString()} F</div>
                                    <div style="font-size: 0.7em; color: #999;">${date}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // ========== LOGIN ==========
        async function handleLogin() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!phone || !password) {
                showToast('Remplissez tous les champs', 'error');
                return;
            }

            if (password === 'demo123') {
                showLoading('Connexion d√©mo...');
                setTimeout(async () => {
                    currentUser = {
                        firestoreId: 'DEMO_' + Date.now(),
                        uid: 'DEMO_' + Date.now(),
                        telephone: phone,
                        prenom: 'Chauffeur',
                        nom: 'Demo',
                        rating: 4.8,
                        coursesCompletees: 42,
                        revenusTotal: 150000,
                        isDemo: true
                    };
                    hideLoading();
                    showToast('‚úÖ Mode d√©mo activ√©!', 'success');
                    document.getElementById('bottomNav').style.display = 'flex';
                    displayProfilePhoto(null);
                    showScreen('dashboardScreen');
                    loadDashboardData();
                    startLocationTracking();
                }, 1000);
                return;
            }

            showLoading('Connexion...');

            try {
                const normalizedPhone = phone.replace(/[\s\-\.]/g, '');
                const snapshot = await db.collection('drivers').get();
                let existingDriver = null;

                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    const dbPhone = (data.telephone || '').replace(/[\s\-\.]/g, '');
                    if (normalizedPhone.slice(-9) === dbPhone.slice(-9)) {
                        existingDriver = { id: doc.id, ...data };
                        break;
                    }
                }
                
                if (existingDriver) {
                    if (password !== 'Admin2025') {
                        hideLoading();
                        showToast('‚ùå Mot de passe incorrect', 'error');
                        return;
                    }
                    
                    currentUser = { firestoreId: existingDriver.id, uid: existingDriver.id, ...existingDriver };
                    
                    await db.collection('drivers').doc(existingDriver.id).update({
                        derniereConnexion: firebase.firestore.FieldValue.serverTimestamp(),
                        statut: 'hors_ligne'
                    });
                    
                    hideLoading();
                    
                    // Charger la photo de profil
                    showLoading('Chargement photo...');
                    const photoUrl = await fetchDriverPhoto({ ...existingDriver, id: existingDriver.id });
                    displayProfilePhoto(photoUrl);
                    hideLoading();
                    
                    showToast(`‚úÖ Bienvenue ${currentUser.prenom || ''} ${currentUser.nom || ''}!`, 'success');
                    document.getElementById('bottomNav').style.display = 'flex';
                    showScreen('dashboardScreen');
                    loadDashboardData();
                    startLocationTracking();
                    return;
                }
                
                hideLoading();
                showToast('‚ùå Num√©ro non enregistr√©', 'error');
                
            } catch (error) {
                hideLoading();
                showToast('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function handleLogout() {
            if (confirm('Voulez-vous vous d√©connecter?')) {
                if (isOnline) toggleOnlineStatus();
                stopLocationTracking();
                currentUser = null;
                currentCourse = null;
                document.getElementById('bottomNav').style.display = 'none';
                showScreen('loginScreen');
                showToast('D√©connexion r√©ussie', 'info');
            }
        }

        // ========== PHOTO PROFIL ==========
        function normalizePhoneForComparison(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, '');
        }

        function getPhoneVariants(phone) {
            const digits = normalizePhoneForComparison(phone);
            const variants = new Set();
            variants.add(digits);
            const localNumber = digits.slice(-9);
            variants.add(localNumber);
            variants.add('+221' + localNumber);
            variants.add('221' + localNumber);
            return [...variants].filter(v => {
                const cleaned = v.replace(/\D/g, '');
                return cleaned.length >= 9;
            });
        }

        async function fetchDriverPhoto(driverData) {
            console.log('üì∏ Recherche photo pour:', driverData.telephone);
            
            // Chercher dans les donn√©es du chauffeur
            let photoUrl = driverData.photoProfil || 
                          driverData.photoIdentite || 
                          driverData.photoUrl ||
                          driverData.photo ||
                          driverData.photos?.photoProfil ||
                          driverData.photos?.photoIdentite;
            
            if (photoUrl) {
                console.log('‚úÖ Photo trouv√©e dans driver:', photoUrl);
                return photoUrl;
            }
            
            // Chercher dans la collection drivers
            try {
                const phoneVariants = getPhoneVariants(driverData.telephone);
                const driversSnapshot = await db.collection('drivers').get();
                
                for (const doc of driversSnapshot.docs) {
                    const driver = doc.data();
                    const driverPhone = driver.telephone || '';
                    const driverDigits = normalizePhoneForComparison(driverPhone);
                    
                    for (const variant of phoneVariants) {
                        const variantDigits = normalizePhoneForComparison(variant);
                        
                        if (driverDigits === variantDigits || 
                            driverDigits.endsWith(variantDigits.slice(-9)) ||
                            variantDigits.endsWith(driverDigits.slice(-9))) {
                            
                            const foundPhoto = driver.photoProfil ||
                                             driver.photoIdentite || 
                                             driver.photoUrl ||
                                             driver.photo ||
                                             driver.photos?.photoProfil ||
                                             driver.photos?.photoIdentite;
                            
                            if (foundPhoto) {
                                console.log('‚úÖ Photo trouv√©e dans autre driver:', foundPhoto);
                                
                                // Synchroniser la photo
                                if (driverData.id && doc.id !== driverData.id) {
                                    try {
                                        await db.collection('drivers').doc(driverData.id).update({
                                            photoIdentite: foundPhoto,
                                            photoProfil: foundPhoto
                                        });
                                        console.log('‚úÖ Photo synchronis√©e');
                                    } catch (err) {
                                        console.warn('‚ö†Ô∏è Sync impossible:', err);
                                    }
                                }
                                return foundPhoto;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur recherche drivers:', error);
            }
            
            // Chercher dans les candidatures accept√©es
            try {
                const phoneVariants = getPhoneVariants(driverData.telephone);
                const candidaturesSnapshot = await db.collection('candidatures')
                    .where('statut', '==', 'acceptee')
                    .get();
                
                for (const doc of candidaturesSnapshot.docs) {
                    const candidature = doc.data();
                    const candidaturePhone = candidature.telephone || candidature.phone || '';
                    const candidatureDigits = normalizePhoneForComparison(candidaturePhone);
                    
                    for (const variant of phoneVariants) {
                        const variantDigits = normalizePhoneForComparison(variant);
                        
                        if (candidatureDigits === variantDigits || 
                            candidatureDigits.endsWith(variantDigits.slice(-9)) ||
                            variantDigits.endsWith(candidatureDigits.slice(-9))) {
                            
                            photoUrl = candidature.photoProfil ||
                                       candidature.photos?.photoProfil ||
                                       candidature.photos?.photoIdentite || 
                                       candidature.photoIdentite || 
                                       candidature.photoUrl ||
                                       candidature.photo;
                            
                            if (photoUrl) {
                                console.log('‚úÖ Photo trouv√©e dans candidature:', photoUrl);
                                
                                // Synchroniser vers le driver
                                if (driverData.id) {
                                    try {
                                        await db.collection('drivers').doc(driverData.id).update({
                                            photoIdentite: photoUrl,
                                            photoProfil: photoUrl
                                        });
                                        console.log('‚úÖ Photo sync depuis candidature');
                                    } catch (err) {
                                        console.warn('‚ö†Ô∏è Sync impossible:', err);
                                    }
                                }
                                return photoUrl;
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Candidatures inaccessibles:', error.message);
            }
            
            console.log('‚ùå Aucune photo trouv√©e');
            return null;
        }
        
        function displayProfilePhoto(photoUrl) {
            console.log('üì∏ Affichage photo:', photoUrl);
            
            const headerPhoto = document.getElementById('headerProfilePhoto');
            if (photoUrl && photoUrl.trim() !== '') {
                headerPhoto.innerHTML = `<img src="${photoUrl}" class="header-profile-photo" alt="Photo" onerror="this.parentElement.innerHTML='<div class=\\'header-profile-placeholder\\'><i class=\\'fas fa-user\\'></i></div>'">`;
            } else {
                headerPhoto.innerHTML = `<div class="header-profile-placeholder"><i class="fas fa-user"></i></div>`;
            }
            
            const profileAvatar = document.getElementById('profileAvatar');
            if (photoUrl && photoUrl.trim() !== '') {
                profileAvatar.innerHTML = `<img src="${photoUrl}" alt="Photo" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>'">`;
            } else {
                profileAvatar.innerHTML = `<i class="fas fa-user"></i>`;
            }
        }

        // ========== DASHBOARD ==========
        async function loadDashboardData() {
            if (!currentUser) return;

            document.getElementById('profileName').textContent = `${currentUser.prenom || ''} ${currentUser.nom || ''}`;
            document.getElementById('profilePhone').textContent = currentUser.telephone || '';
            document.getElementById('profileVehicle').textContent = currentUser.vehicule?.modele || currentUser.typeVehicule || 'Non renseign√©';
            document.getElementById('coursesTotal').textContent = currentUser.coursesCompletees || 0;
            document.getElementById('profileTotalCourses').textContent = currentUser.coursesCompletees || 0;
            document.getElementById('profileRevenuTotal').textContent = (currentUser.revenusTotal || 0).toLocaleString() + ' FCFA';
            document.getElementById('rating').textContent = (currentUser.rating || 4.8).toFixed(1);
            document.getElementById('profileRating').textContent = (currentUser.rating || 4.8).toFixed(1);

            // Stats display
            document.getElementById('acceptanceRate').textContent = '85%';
            document.getElementById('acceptanceBar').style.width = '85%';
            document.getElementById('coursesAccepted').textContent = currentUser.coursesCompletees || 0;
            document.getElementById('coursesRefused').textContent = '5';

            if (currentUser.isDemo) {
                document.getElementById('coursesJour').textContent = '5';
                document.getElementById('revenusJour').textContent = '17,500';
                displayProfilePhoto(null);
            } else {
                // Charger les donn√©es actualis√©es depuis Firestore
                try {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    const driverDoc = await db.collection('drivers').doc(driverId).get();
                    
                    if (driverDoc.exists) {
                        const data = driverDoc.data();
                        
                        // Mettre √† jour les infos
                        document.getElementById('profileName').textContent = `${data.prenom || ''} ${data.nom || ''}`;
                        document.getElementById('profileVehicle').textContent = data.vehicule?.modele || data.typeVehicule || 'Non renseign√©';
                        document.getElementById('coursesTotal').textContent = data.coursesCompletees || 0;
                        document.getElementById('profileTotalCourses').textContent = data.coursesCompletees || 0;
                        document.getElementById('profileRevenuTotal').textContent = (data.revenusTotal || 0).toLocaleString() + ' FCFA';
                        document.getElementById('rating').textContent = (data.rating || 4.8).toFixed(1);
                        document.getElementById('profileRating').textContent = (data.rating || 4.8).toFixed(1);
                        
                        // Charger la photo
                        const photoUrl = await fetchDriverPhoto({ ...data, id: driverId });
                        displayProfilePhoto(photoUrl);
                    }
                } catch (error) {
                    console.error('Erreur chargement dashboard:', error);
                }
            }
        }

        // ========== LOCATION TRACKING ==========
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showToast('‚ùå G√©olocalisation non support√©e', 'error');
                return;
            }

            watchPositionId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    driverPosition = { lat: latitude, lng: longitude };

                    document.getElementById('accuracy').innerHTML = 
                        `${accuracy < 50 ? 'üü¢' : 'üü°'} Pr√©cision: ${Math.round(accuracy)} m`;

                    if (driverMarker && map) {
                        driverMarker.setPosition(driverPosition);
                        map.panTo(driverPosition);
                    }

                    reverseGeocode(latitude, longitude);
                    document.getElementById('trackingBadge').style.display = 'flex';
                },
                (error) => {
                    document.getElementById('currentAddress').textContent = 'Position non disponible';
                    document.getElementById('accuracy').innerHTML = 'üî¥ GPS d√©sactiv√©';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function stopLocationTracking() {
            if (watchPositionId) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
            }
            document.getElementById('trackingBadge').style.display = 'none';
        }

        function reverseGeocode(lat, lng) {
            if (window.google && google.maps) {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('currentAddress').textContent = results[0].formatted_address;
                    }
                });
            }
        }

        // ========== ONLINE STATUS ==========
        async function toggleOnlineStatus() {
            if (!currentUser) return;

            isOnline = !isOnline;
            const toggle = document.getElementById('toggleSwitch');
            const statusText = document.getElementById('statusText');

            if (isOnline) {
                toggle.classList.add('active');
                statusText.textContent = 'üü¢ EN LIGNE';
                statusText.classList.add('online');
                showToast('‚úÖ Vous √™tes en ligne', 'success');
                listenForNewCourses();
                
                if (!currentUser.isDemo) {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    await db.collection('drivers').doc(driverId).update({
                        statut: 'disponible',
                        derniereActivite: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } else {
                toggle.classList.remove('active');
                statusText.textContent = '‚ö´ HORS LIGNE';
                statusText.classList.remove('online');
                showToast('Vous √™tes hors ligne', 'info');
                stopListeningForCourses();
                
                if (!currentUser.isDemo) {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    await db.collection('drivers').doc(driverId).update({ statut: 'hors_ligne' });
                }
            }
        }

        // ========== COURSE MANAGEMENT ==========
        function listenForNewCourses() {
            if (!currentUser || !isOnline || currentUser.isDemo) return;

            const driverId = currentUser.firestoreId || currentUser.uid;

            courseListener = db.collection('reservations')
                .where('chauffeurAssigne', '==', driverId)
                .where('statut', '==', 'assignee')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const course = { id: change.doc.id, ...change.doc.data() };
                            showCourseNotification(course);
                        }
                    });
                });
        }

        function stopListeningForCourses() {
            if (courseListener) {
                courseListener();
                courseListener = null;
            }
        }

        function showCourseNotification(course) {
            document.getElementById('navCourseBadge').style.display = 'flex';
            
            const notification = document.createElement('div');
            notification.className = 'course-notification';
            notification.innerHTML = `
                <div class="course-modal">
                    <div class="course-timer" id="courseTimer">30<div class="course-timer-label">sec</div></div>
                    <h2 class="course-title">üîî NOUVELLE COURSE!</h2>
                    <div class="course-client">
                        <strong>Client:</strong> ${course.clientNom || 'Client'}
                    </div>
                    <div class="course-route">
                        <div class="route-point"><span>üìç</span><span>${course.depart}</span></div>
                        <div style="text-align: center; margin: 6px 0;">‚Üì</div>
                        <div class="route-point"><span>üéØ</span><span>${course.destination}</span></div>
                    </div>
                    <div class="course-details">
                        <div class="detail-item"><div>üí∞</div><div>${(course.prixEstime || 0).toLocaleString()} F</div></div>
                        <div class="detail-item"><div>üìè</div><div>${course.distance || 5} km</div></div>
                        <div class="detail-item"><div>üë•</div><div>${course.passagers || 1}</div></div>
                    </div>
                    <div class="course-actions">
                        <button class="btn btn-refuse" onclick="refuseCourse('${course.id}')">‚ùå Refuser</button>
                        <button class="btn btn-accept" onclick="acceptCourse('${course.id}', ${JSON.stringify(course).replace(/"/g, '&quot;')})">‚úÖ Accepter</button>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);

            let timeLeft = 30;
            const timerInterval = setInterval(() => {
                timeLeft--;
                const timer = document.getElementById('courseTimer');
                if (timer) timer.innerHTML = `${timeLeft}<div class="course-timer-label">sec</div>`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    refuseCourse(course.id, true);
                }
            }, 1000);
            notification.timerInterval = timerInterval;
        }

        async function acceptCourse(courseId, courseData) {
            const notification = document.querySelector('.course-notification');
            if (notification) {
                clearInterval(notification.timerInterval);
                notification.remove();
            }
            
            document.getElementById('navCourseBadge').style.display = 'none';
            showLoading('Acceptation...');

            if (typeof courseData === 'string') {
                courseData = JSON.parse(courseData.replace(/&quot;/g, '"'));
            }

            currentCourse = { id: courseId, ...courseData, statut: 'acceptee' };

            if (!currentUser.isDemo) {
                try {
                    await db.collection('reservations').doc(courseId).update({
                        statut: 'acceptee',
                        accepteeParChauffeur: true,
                        dateAcceptation: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            hideLoading();
            showToast('‚úÖ Course accept√©e!', 'success');
            showScreen('activeCourseScreen');
            displayActiveCourse();
        }

        function refuseCourse(courseId, auto = false) {
            const notification = document.querySelector('.course-notification');
            if (notification) {
                clearInterval(notification.timerInterval);
                notification.remove();
            }
            
            document.getElementById('navCourseBadge').style.display = 'none';
            showToast(auto ? '‚è±Ô∏è Temps √©coul√©' : 'Course refus√©e', 'info');
        }

        function displayActiveCourse() {
            if (!currentCourse) return;

            document.getElementById('clientName').textContent = currentCourse.clientNom || 'Client';
            document.getElementById('clientPhone').textContent = currentCourse.clientTelephone || '-';
            document.getElementById('activeDeparture').textContent = currentCourse.depart;
            document.getElementById('activeDestination').textContent = currentCourse.destination;
            document.getElementById('activePrice').textContent = `${(currentCourse.prixEstime || 0).toLocaleString()} FCFA`;
            updateCourseStatusDisplay();
        }

        async function updateCourseStatus(newStatus) {
            if (!currentCourse) return;

            showLoading('Mise √† jour...');
            currentCourse.statut = newStatus;

            if (!currentUser.isDemo) {
                try {
                    await db.collection('reservations').doc(currentCourse.id).update({
                        statut: newStatus,
                        derniereModification: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            hideLoading();
            updateCourseStatusDisplay();
            showToast(newStatus === 'arrive' ? '‚úÖ Vous √™tes arriv√©' : 'üöó Course d√©marr√©e!', 'success');
        }

        function updateCourseStatusDisplay() {
            const status = currentCourse?.statut || 'acceptee';
            const statusBadge = document.getElementById('courseStatus');
            const statusTitle = document.getElementById('courseStatusTitle');
            const btnArrive = document.getElementById('btnArrive');
            const btnStart = document.getElementById('btnStart');
            const btnComplete = document.getElementById('btnComplete');
            const tabCourse = document.getElementById('tabCourse');

            switch(status) {
                case 'acceptee':
                case 'en_route':
                    statusBadge.className = 'status-badge approche';
                    statusBadge.textContent = 'üöó En route vers client';
                    statusTitle.textContent = 'Direction: ' + currentCourse.depart;
                    btnArrive.style.display = 'block';
                    btnStart.style.display = 'none';
                    btnComplete.disabled = true;
                    tabCourse.classList.add('disabled');
                    break;
                case 'arrive':
                    statusBadge.className = 'status-badge approche';
                    statusBadge.textContent = 'üìç Arriv√© - En attente';
                    statusTitle.textContent = 'Le client arrive...';
                    btnArrive.style.display = 'none';
                    btnStart.style.display = 'block';
                    btnComplete.disabled = true;
                    tabCourse.classList.add('disabled');
                    break;
                case 'en_cours':
                    statusBadge.className = 'status-badge en-cours';
                    statusBadge.textContent = 'üöó Course en cours';
                    statusTitle.textContent = 'Direction: ' + currentCourse.destination;
                    btnArrive.style.display = 'none';
                    btnStart.style.display = 'none';
                    btnComplete.disabled = false;
                    tabCourse.classList.remove('disabled');
                    break;
            }
        }

        function showRouteTab(mode) {
            if (mode === 'course' && currentCourse?.statut !== 'en_cours') {
                showToast('‚ö†Ô∏è D√©marrez d\'abord la course', 'info');
                return;
            }
            currentRouteMode = mode;
            document.getElementById('tabApproche').classList.toggle('active', mode === 'approche');
            document.getElementById('tabCourse').classList.toggle('active', mode === 'course');
            document.getElementById('routeInfoApproche').style.display = mode === 'approche' ? 'block' : 'none';
            document.getElementById('routeInfoCourse').style.display = mode === 'course' ? 'block' : 'none';
        }

        function openGoogleMapsToClient() {
            if (!currentCourse) return;
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentCourse.depart + ', Dakar, Senegal')}`, '_blank');
        }

        function callClient() {
            if (!currentCourse?.clientTelephone) {
                return showToast('Num√©ro non disponible', 'error');
            }
            window.location.href = `tel:${currentCourse.clientTelephone}`;
        }

        async function completeCourse() {
            if (!currentCourse || currentCourse.statut !== 'en_cours') {
                return showToast('‚ö†Ô∏è D√©marrez d\'abord la course', 'error');
            }
            if (!confirm('Confirmer la fin de la course?')) return;

            showLoading('Finalisation...');

            if (!currentUser.isDemo) {
                try {
                    const driverId = currentUser.firestoreId || currentUser.uid;
                    await db.collection('reservations').doc(currentCourse.id).update({
                        statut: 'terminee',
                        dateFin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection('drivers').doc(driverId).update({
                        statut: 'disponible',
                        coursesCompletees: firebase.firestore.FieldValue.increment(1),
                        revenusTotal: firebase.firestore.FieldValue.increment(currentCourse.prixEstime || 0)
                    });
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            currentCourse = null;
            hideLoading();
            showToast('‚úÖ Course termin√©e!', 'success');
            showScreen('dashboardScreen');
        }

        async function cancelCourse() {
            if (!confirm('Annuler cette course?')) return;

            showLoading('Annulation...');

            if (!currentUser.isDemo && currentCourse) {
                try {
                    await db.collection('reservations').doc(currentCourse.id).update({
                        statut: 'annulee',
                        annuleePar: 'chauffeur',
                        dateAnnulation: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Erreur:', error);
                }
            }

            currentCourse = null;
            hideLoading();
            showToast('Course annul√©e', 'info');
            showScreen('dashboardScreen');
        }

        // ========== HISTORY ==========
        async function loadHistory() {
            const historyList = document.getElementById('historyList');
            
            if (currentUser?.isDemo) {
                const courses = [
                    { date: new Date(), depart: 'Plateau', dest: 'Almadies', prix: 4500 },
                    { date: new Date(Date.now() - 3600000), depart: 'Sacr√©-C≈ìur', dest: 'Yoff', prix: 3200 },
                    { date: new Date(Date.now() - 86400000), depart: 'M√©dina', dest: 'Ngor', prix: 2800 }
                ];
                historyList.innerHTML = courses.map(c => `
                    <div class="history-item">
                        <div class="history-header">
                            <span class="history-date">${c.date.toLocaleDateString('fr-FR')} ${c.date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                            <span class="history-price">${c.prix.toLocaleString()} FCFA</span>
                        </div>
                        <div class="history-route">üìç ${c.depart} ‚Üí üéØ ${c.dest}</div>
                        <span class="history-status">‚úÖ Termin√©e</span>
                    </div>
                `).join('');
                return;
            }

            historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Chargement...</div>';

            try {
                const driverId = currentUser.firestoreId || currentUser.uid;
                const snapshot = await db.collection('reservations')
                    .where('chauffeurAssigne', '==', driverId)
                    .where('statut', 'in', ['terminee', 'annulee'])
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();

                if (snapshot.empty) {
                    historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">üì≠ Aucune course</div>';
                    return;
                }

                historyList.innerHTML = snapshot.docs.map(doc => {
                    const c = doc.data();
                    let date = c.timestamp?.toDate ? c.timestamp.toDate() : new Date();
                    return `
                        <div class="history-item">
                            <div class="history-header">
                                <span class="history-date">${date.toLocaleDateString('fr-FR')} ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</span>
                                <span class="history-price">${(c.prixEstime || 0).toLocaleString()} FCFA</span>
                            </div>
                            <div class="history-route">üìç ${c.depart || 'D√©part'} ‚Üí üéØ ${c.destination || 'Destination'}</div>
                            <span class="history-status" style="${c.statut === 'terminee' ? '' : 'background: #E30613;'}">${c.statut === 'terminee' ? '‚úÖ Termin√©e' : '‚ùå Annul√©e'}</span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                historyList.innerHTML = '<div style="text-align: center; padding: 40px; color: #E30613;">Erreur de chargement</div>';
            }
        }

        // ========== GOOGLE MAPS ==========
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBI1svukv3Ts7fN97ke5OGfwo2V-vRUGHI&callback=initMap';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        function initMap() {
            const dakar = { lat: 14.6937, lng: -17.4441 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: dakar,
                zoom: 14,
                disableDefaultUI: true,
                zoomControl: true
            });
            
            driverMarker = new google.maps.Marker({
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#00A854',
                    fillOpacity: 1,
                    strokeColor: '#fff',
                    strokeWeight: 2
                }
            });

            directionsService = new google.maps.DirectionsService();
        }

        window.initMap = initMap;
        
        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöï Al Bourakh Driver v5.3 - Ready');
            document.getElementById('loginPhone').value = '+221 77 712 34 56';
            document.getElementById('loginPassword').value = 'demo123';
            loadGoogleMaps();
        });
    </script>
</body>
</html>
